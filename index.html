                                        <!DOCTYPE html>
                            <html lang="ar" dir="rtl">
                                <head>
                                    <meta charset="UTF-8">
                                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                    <title>Ibn Masr CMS V47</title>
                                    
                                    <!-- المكتبات الخارجية -->
                                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
                                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                                    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

                                    <!-- 1. استدعاء مكتبات فايربيز (النسخة اللي بتشتغل في المتصفح علطول) -->
                                    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
                                    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
                                    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>

                                    <script>
                                    // 2. إعدادات المشروع بتاعك (اللي إنت بعتها)
                                    const firebaseConfig = {
                                        apiKey: "AIzaSyCcgHfPeVGSA699yFPH24AP5jt7VJgzYyw",
                                        authDomain: "abn-maser-21fdb.firebaseapp.com",
                                        databaseURL: "https://abn-maser-21fdb-default-rtdb.firebaseio.com",
                                        projectId: "abn-maser-21fdb",
                                        storageBucket: "abn-maser-21fdb.firebasestorage.app",
                                        messagingSenderId: "921105330552",
                                        appId: "1:921105330552:web:95f87a56b524b15f7f188d",
                                        measurementId: "G-REL2TVSPSM"
                                    };

                                    // 3. تشغيل الفايربيز
                                    firebase.initializeApp(firebaseConfig);
                                    const analytics = firebase.analytics();

                                    // 4. تعريف المحرك الأساسي (عشان الكود القديم يفهمه)
                                    const dbHub = firebase.database();
                                    </script>

                                    <style>
                                        /* 
                                        ========================================================================
                                        --- CSS MASTER ARCHITECTURE: VIP HOVER EDITION --- 
                                        ========================================================================
                                        */
                            :root {
                                --primary-bg-core: #010409;
                                --glass-surface: rgba(13, 17, 23, 0.96);
                                --gold-master: #f59e0b;
                                --gold-bright: #fbbf24;
                                --accent-navy: #1d4ed8;
                                --success-glow: #10b981;
                                --danger-pulse: #ef4444;
                                --text-pure: #f0f6fc;
                                --text-muted-core: #8b949e;
                                --border-glow-line: rgba(245, 158, 11, 0.28);
                                --radius-massive: 8px;
                                --shadow-depth: 0 30px 60px rgba(0,0,0,0.85), inset 0 1px 2px rgba(255,255,255,0.06);
                                --font-stack: 'Cairo', sans-serif;
                                --transition-speed: 0.2s;
                                --sidebar-width: 200px;
                            }

                                        /* Animations */
                                        @keyframes slideRightFade { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
                                        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
                                        @keyframes rotateBrand { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                                        @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                                        @keyframes pulseLive { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

                                        ::-webkit-scrollbar { width: 10px; }
                                        ::-webkit-scrollbar-track { background: var(--primary-bg-core); }
                                        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--gold-master), #d97706); border-radius: 12px; border: 3px solid var(--primary-bg-core); }

                                        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; transition: var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1); }

                            body {
                                font-family: var(--font-stack);
                                background: var(--primary-bg-core);
                                color: var(--text-pure);
                                min-height: 100vh;
                                overflow-x: hidden;
                                font-size: 13px;
                                background-image: radial-gradient(circle at 5% 5%, rgba(245, 158, 11, 0.08) 0%, transparent 45%), radial-gradient(circle at 95% 95%, rgba(29, 78, 216, 0.08) 0%, transparent 50%);
                                background-attachment: fixed;
                            }

                                        /* Layout */
                                        .system-side-nav {
                                            position: fixed; top: 20px; right: 20px; bottom: 20px; width: var(--sidebar-width);
                                            background: var(--glass-surface); backdrop-filter: blur(55px);
                                            border: 1px solid var(--border-glow-line); border-radius: var(--radius-massive);
                                            box-shadow: var(--shadow-depth); z-index: 1000;
                                            display: flex; flex-direction: column; padding: 20px 15px; overflow-y: auto;
                                            animation: slideRightFade 0.8s ease-out;
                                        }

                                        .vip-master-container {
                                            margin-right: calc(var(--sidebar-width) + 30px); margin-left: 20px;
                                            padding-top: 20px; padding-bottom: 100px; max-width: 100%;
                                            animation: slideUpFade 0.7s ease-out;
                                        }

                                        .hamburger-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 1100; background: var(--gold-master); color: #000; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }

                                        /* Mobile Responsive */
                                        @media (max-width: 768px) {
                                            body { font-size: 12px; }
                                            .vip-master-container { margin-right: 0 !important; margin-left: 0 !important; padding: 15px !important; padding-top: 80px !important; }
                                            .system-side-nav { width: 280px !important; right: -300px !important; top: 0 !important; bottom: 0 !important; height: 100vh !important; border-radius: 0 !important; z-index: 3000 !important; }
                                            .system-side-nav.open { right: 0 !important; }
                                            .hamburger-btn { display: flex !important; }
                                            .login-card-massive { width: 95% !important; padding: 40px 20px !important; }
                                            .floating-action-master { width: 60px !important; height: 60px !important; font-size: 1.8rem !important; bottom: 20px !important; left: 20px !important; }
                                            .admin-layout-flex { grid-template-columns: 1fr !important; }
                                            h1 { font-size: 2rem !important; }
                                        }

                                        /* Sidebar Elements */
                                        .identity-matrix { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid rgba(255,255,255,0.05); }
                                        .identity-orb-vip { width: 70px; height: 70px; background: linear-gradient(135deg, var(--gold-master), #b45309); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 950; color: #000; font-size: 1.8rem; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4); cursor: pointer; margin-bottom: 10px; }
                                        .identity-orb-vip:hover { animation: rotateBrand 2s infinite linear; }
                                        .nav-hub-menu { display: flex; flex-direction: column; gap: 15px; flex: 1; }
                                        .nav-link-vip { background: rgba(255,255,255,0.03); border: 1px solid transparent; color: var(--text-muted-core); padding: 15px 20px; border-radius: 18px; cursor: pointer; font-family: var(--font-stack); font-weight: 800; font-size: 1rem; display: flex; align-items: center; gap: 18px; width: 100%; }
                                        .nav-link-vip:hover, .nav-link-vip.active { background: rgba(245, 158, 11, 0.15); color: var(--gold-master); border-color: var(--border-glow-line); transform: translateX(-8px); }
                                        .nav-link-vip.active { background: var(--gold-master); color: #000; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }
                                        .logout-btn-sidebar { margin-top: auto; background: rgba(239, 68, 68, 0.1) !important; color: var(--danger-pulse) !important; border: 1px solid rgba(239, 68, 68, 0.3) !important; justify-content: center; }

                                        /* Cards & Inputs */
                                        .massive-glass-card { background: var(--glass-surface); backdrop-filter: blur(55px); border: 1px solid var(--border-glow-line); border-radius: var(--radius-massive); box-shadow: var(--shadow-depth); position: relative; overflow: hidden; }
                                        .floating-action-master { position: fixed; bottom: 50px; left: 50px; width: 100px; height: 100px; border-radius: 50%; background: var(--gold-master); color: #000; font-size: 3.5rem; border: none; cursor: pointer; z-index: 2000; box-shadow: 0 40px 90px rgba(245, 158, 11, 0.8); display: flex; align-items: center; justify-content: center; }
                                        .floating-action-master:hover { transform: scale(1.1) rotate(90deg); }
                                        
                                        .sidebar-complaint-master { position: fixed; top: 0; left: -700px; width: 600px; height: 100%; background: #0b0e14; border-right: 12px solid var(--gold-master); z-index: 2600; padding: 70px; transition: 1s cubic-bezier(0.7, 0, 0.1, 1); box-shadow: 60px 0 200px rgba(0,0,0,1); overflow-y: auto; }
                                        .sidebar-complaint-master.open { left: 0; }
                                        .dimmer-overlay-master { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 2599; display: none; }

                                        /*
                            ============================================================
                            --- VIP COMPACT MODE (إصلاح الحجم الضخم) ---
                            ============================================================
                            */

                            :root {
                                /* تصغير القائمة الجانبية لتوفير مساحة للعرض */
                                --sidebar-width: 240px;
                                --radius-massive: 12px;
                                --transition-speed: 0.2s;
                            }

                            body {
                                /* تصغير الخط العام للموقع */
                                font-size: 13px;
                            }

                            /* --- القائمة الجانبية (تصغير كلي) --- */
                            .system-side-nav {
                                width: var(--sidebar-width);
                                padding: 15px 10px;
                                top: 15px; right: 15px; bottom: 15px;
                            }

                            .identity-orb-vip {
                                width: 60px; height: 60px; /* تصغير الأفاتار من 110px */
                                font-size: 1.5rem;
                                border-width: 3px;
                                margin-bottom: 10px;
                            }

                            .identity-labels h2 { font-size: 1rem; }
                            .identity-labels span { font-size: 0.75rem; }

                            .nav-link-vip {
                                padding: 10px 12px;
                                font-size: 0.85rem;
                                gap: 10px;
                                border-radius: 10px;
                                margin-bottom: 5px;
                            }

                            /* --- المحتوى الرئيسي --- */
                            .vip-master-container {
                                margin-right: calc(var(--sidebar-width) + 30px);
                                margin-left: 15px;
                                padding-top: 15px;
                            }

                            h1 { font-size: 1.6rem !important; margin-bottom: 15px !important; }

                            /* --- البث الحي (تحويله لشبكة كروت صغيرة بجانب بعضها) --- */
                            #render-live-feed-matrix {
                                display: grid;
                                /* يظهر 3 أو 4 بلاغات في السطر الواحد */
                                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                                gap: 12px;
                            }

                            .ticket-visual-unit {
                                padding: 15px;
                                border-radius: var(--radius-massive);
                                border-right: 6px solid var(--gold-master);
                                margin-bottom: 15px;
                                background: #0d1117;
                                height: 110px; /* ارتفاع الكارت وهو مقفول */
                                overflow: hidden;
                                transition: all 0.3s ease;
                                cursor: pointer;
                                position: relative;
                                border: 1px solid rgba(255,255,255,0.05);
                            }

                            /* حالة الـ Hover أو عند الضغط (is-fixed) */
                            .ticket-visual-unit:hover,
                            .ticket-visual-unit.is-fixed {
                                height: auto;
                                min-height: 110px;
                                background: #161b22;
                                border-color: var(--gold-bright);
                                z-index: 100;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                                transform: translateY(-2px);
                            }

                            /* تصميم رقم الأوردر ليكون واضح جداً في الخارج */
                            .order-number-badge {
                                font-size: 2.2rem !important; /* الرقم كبير وواضح */
                                font-weight: 900;
                                color: #ffffff;
                                display: block;
                                margin: 5px 0;
                                line-height: 1;
                            }

                            .ticket-hidden-details {
                                opacity: 0;
                                display: none;
                            }

                            .ticket-visual-unit:hover .ticket-hidden-details,
                            .ticket-visual-unit.is-fixed .ticket-hidden-details {
                                opacity: 1;
                                display: block;
                                margin-top: 15px;
                                padding-top: 15px;
                                border-top: 1px solid rgba(255,255,255,0.1);
                            }

                            /* تصغير عام لعناصر الموقع عشان ميبقاش ضخم */
                            .vip-master-container { padding: 10px; margin-right: calc(var(--sidebar-width) + 20px); }
                            h1 { font-size: 1.4rem !important; }
                            .btn-vip-execute-master { padding: 10px; font-size: 0.9rem; }

                                        /* ================================================== */

                                        .badge-status-glow { padding: 10px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 950; display: inline-block; margin-bottom: 20px; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

                                        .daily-matrix-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 40px; }
                                        .branch-data-card { padding: 50px; text-align: center; border-bottom: 10px solid var(--gold-master); background: rgba(255,255,255,0.04); border-radius: var(--radius-massive); }
                                        .massive-daily-input { font-size: 5rem; font-weight: 950; color: var(--gold-master); width: 100%; text-align: center; background: transparent; border: none; border-bottom: 6px solid var(--border-glow-line); margin-top: 30px; }
                                        
                                        input, select, textarea { width: 100%; padding: 20px; border-radius: 18px; background: #010409; border: 2px solid var(--border-glow-line); color: white; margin-bottom: 25px; font-family: var(--font-stack); font-size: 1.1rem; }
                                        input:focus, select:focus { border-color: var(--gold-master); box-shadow: 0 0 25px rgba(245, 158, 11, 0.25); }
                                        .btn-vip-execute-master { background: var(--gold-master); color: #000; border: none; padding: 20px; border-radius: 20px; font-weight: 950; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.2rem; box-shadow: 0 20px 50px rgba(245, 158, 11, 0.4); }
                                        .btn-vip-execute-master:hover { filter: brightness(1.2); transform: translateY(-5px); }

                                        .stat-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 80px; }
                                        .analytics-pill-card { padding: 50px; text-align: center; border-radius: 30px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glow-line); }
                                        .analytics-pill-card h2 { font-size: 3.5rem; font-weight: 950; color: var(--gold-master); }
                                        .analytics-dual-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; margin-top: 50px; }
                                        .chart-viewport-massive { padding: 60px; background: rgba(0,0,0,0.45); border-radius: 40px; border: 2px solid var(--border-glow-line); }

                                        .admin-layout-flex { display: grid; grid-template-columns: 1fr; gap: 60px; }
                                        @media(min-width: 1600px) { .admin-layout-flex { grid-template-columns: 1.5fr 1fr; } }
                                        .scrollable-admin-list { max-height: 400px; overflow-y: auto; border: 2px solid var(--border-glow-line); border-radius: 20px; padding: 25px; background: rgba(0,0,0,0.3); }
                                        .admin-row-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
                                        
                                        #system-toast-container { position: fixed; bottom: 40px; left: 40px; z-index: 6000; }
                                        .toast-msg-vip { background: var(--gold-master); color: #000; padding: 20px 40px; border-radius: 15px; font-weight: 950; box-shadow: 0 20px 45px rgba(0,0,0,0.7); margin-top: 15px; display: flex; align-items: center; gap: 15px; animation: slideInRight 0.6s; }
                                        
                                        #auth-portal-mask { height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; z-index: 9999; position: fixed; inset: 0; }
                                        .login-card-massive { width: 650px; padding: 100px 80px; text-align: center; border: 6px solid var(--gold-master); }
                                        .hidden { display: none !important; }

                                        /* --- رادار VIP المدمج والأنيق --- */
                                        .presence-grid {
                                            display: flex;
                                            flex-wrap: wrap;
                                            gap: 15px; /* مسافة صغيرة بين الأعضاء */
                                            justify-content: flex-start; /* بجانب بعض من اليمين */
                                            padding: 10px;
                                        }

                                        .presence-user-orb {
                                            width: 75px; /* عرض مدمج جداً */
                                            display: flex;
                                            flex-direction: column;
                                            align-items: center;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        }

                                        .presence-user-orb:hover { transform: scale(1.1); }

                                        /* الأفاتار الصغير والأنيق */
                                        .avatar-ring {
                                            width: 50px; /* حجم صغير جداً */
                                            height: 50px;
                                            border-radius: 50%;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            background: #161b22;
                                            border: 2px solid #30363d;
                                            font-size: 1.2rem;
                                            font-weight: bold;
                                            color: #8b949e;
                                            position: relative;
                                        }

                                    /* نقطة الحالة المدمجة */
                                    .status-indicator {
                                        position: absolute;
                                        bottom: 2px;
                                        right: 2px;
                                        width: 12px;
                                        height: 12px;
                                        border-radius: 50%;
                                        border: 2px solid #0d1117;
                                        background: #484f58;
                                    }

                                    .user-name-label {
                                        margin-top: 5px;
                                        font-size: 0.85rem;
                                        color: #f0f6fc;
                                        text-align: center;
                                        width: 100%;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        white-space: nowrap;
                                    }

                                    .user-rank-mini { display: none; } /* إخفاء الرتبة لتوفير مساحة */

                                /* الحالة: متصل (Online) */
                                .orb-online .avatar-ring {
                                    border-color: #39d353 !important; /* لون أخضر فوسفوري */
                                    box-shadow: 0 0 15px rgba(57, 211, 83, 0.4);
                                }

                                .orb-online .status-indicator {
                                    background: #39d353 !important;
                                    box-shadow: 0 0 10px #39d353;
                                    animation: pulseStatus 1.5s infinite; /* حركة النبض */
                                }

                                /* الحالة: غير متصل (Offline) */
                                .orb-offline .avatar-ring {
                                    border-color: #484f58 !important;
                                    filter: grayscale(1);
                                    opacity: 0.6;
                                }

                                .orb-offline .status-indicator {
                                    background: #484f58 !important;
                                    animation: none;
                                }

                                /* أنيميشن النبض */
                                @keyframes pulseStatus {
                                    0% { transform: scale(1); opacity: 1; }
                                    50% { transform: scale(1.5); opacity: 0.3; }
                                    100% { transform: scale(1); opacity: 1; }
                                }

                /* تصميم تقارير VIP المطورة V47 */
                .reports-dashboard-premium {
                    background: #0f172a;
                    padding: 25px;
                    border-radius: 20px;
                    color: #f8fafc;
                }

                /* بطاقات المؤشرات العلوية */
                .kpi-container {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .kpi-card {
                    background: linear-gradient(145deg, #1e293b, #0f172a);
                    padding: 20px;
                    border-radius: 15px;
                    border: 1px solid rgba(245, 158, 11, 0.2);
                    text-align: center;
                    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
                    transition: 0.3s;
                }

                .kpi-card:hover {
                    transform: translateY(-5px);
                    border-color: #f59e0b;
                    box-shadow: 0 15px 30px rgba(245, 158, 11, 0.15);
                }

                .kpi-card i { font-size: 2rem; color: #f59e0b; margin-bottom: 10px; }
                .kpi-card h3 { font-size: 0.9rem; color: #94a3b8; }
                .kpi-card .value { font-size: 1.8rem; font-weight: 900; color: #fff; }

                /* تصميم الجدول الاحترافي */
                .table-glass-wrapper {
                    background: rgba(30, 41, 59, 0.7);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 10px;
                    overflow-x: auto;
                    border: 1px solid rgba(255,255,255,0.05);
                }

                .modern-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.8rem;
                    text-align: center;
                }

                .modern-table th {
                    background: #1e40af; /* أزرق ملكي */
                    color: white;
                    padding: 12px 5px;
                    border: 1px solid #334155;
                    font-weight: 800;
                }

                .modern-table td {
                    padding: 10px 5px;
                    border: 1px solid #334155;
                    font-weight: 600;
                }

                .col-highlight-gold { color: #fbbf24 !important; font-weight: 900; }
                .row-total { background: #1e3a8a !important; color: white !important; font-weight: 900; }

                /* أشرطة التقدم الملونة للنسبة */
                .progress-mini {
                    width: 100%;
                    height: 6px;
                    background: #334155;
                    border-radius: 10px;
                    margin-top: 4px;
                }
                .progress-bar-fill {
                    height: 100%;
                    border-radius: 10px;
                    box-shadow: 0 0 10px currentColor;
                }

                                /* تنسيق سجل النشاط - 4 أعمدة */
                                .log-table-row {
                                    display: grid;
                                    /* الموظف (يمين) | الحدث | التوقيت | الفرع (يسار) */
                                    grid-template-columns: 1.5fr 1.5fr 1.2fr 1fr;
                                    padding: 12px 20px;
                                    border-bottom: 1px solid rgba(255,255,255,0.05);
                                    font-size: 0.9rem;
                                    align-items: center;
                                    direction: rtl; /* التأكد من الاتجاه من اليمين لليسان */
                                }

                                .log-header {
                                    font-weight: 800;
                                    color: var(--gold-master);
                                    background: rgba(255, 255, 255, 0.02);
                                    border-bottom: 2px solid var(--gold-master);
                                    position: sticky;
                                    top: 0;
                                    z-index: 5;
                                }

                                .scrollable-admin-list {
                                    max-height: 400px;
                                    overflow-y: auto;
                                    background: rgba(0,0,0,0.2);
                                    border-radius: 0 0 10px 10px;
                                }

                                        .log-action-pill {
                                            padding: 5px 12px;
                                            border-radius: 8px;
                                            font-size: 0.85rem;
                                            font-weight: 800;
                                            display: inline-block;
                                        }

                                        .radar-header-container {
                                            display: flex;
                                            align-items: center;
                                            justify-content: space-between;
                                            margin-bottom: 30px;
                                        }

                                        .scan-line {
                                            height: 2px;
                                            background: linear-gradient(90deg, transparent, var(--success-glow), transparent);
                                            width: 100%;
                                            position: relative;
                                            overflow: hidden;
                                            margin-bottom: 20px;
                                        }
                                        .scan-line::after {
                                            content: '';
                                            position: absolute;
                                            left: -100%;
                                            width: 100%;
                                            height: 100%;
                                            background: linear-gradient(90deg, transparent, #fff, transparent);
                                            animation: scanning 3s linear infinite;
                                        }
                                        @keyframes scanning {
                                            0% { left: -100%; }
                                            100% { left: 100%; }
                                        }

                                        /*
                            ============================================================
                            --- VIP COMPACT MODE (إصلاح الحجم الضخم) ---
                            ============================================================
                            */

                            :root {
                                /* تصغير القائمة الجانبية لتوفير مساحة للعرض */
                                --sidebar-width: 240px;
                                --radius-massive: 12px;
                                --transition-speed: 0.2s;
                            }

                            body {
                                /* تصغير الخط العام للموقع */
                                font-size: 13px;
                            }

                            /* --- القائمة الجانبية (تصغير كلي) --- */
                            .system-side-nav {
                                width: var(--sidebar-width);
                                padding: 15px 10px;
                                top: 15px; right: 15px; bottom: 15px;
                            }

                            .identity-orb-vip {
                                width: 60px; height: 60px; /* تصغير الأفاتار من 110px */
                                font-size: 1.5rem;
                                border-width: 3px;
                                margin-bottom: 10px;
                            }

                            .identity-labels h2 { font-size: 1rem; }
                            .identity-labels span { font-size: 0.75rem; }

                            .nav-link-vip {
                                padding: 10px 12px;
                                font-size: 0.85rem;
                                gap: 10px;
                                border-radius: 10px;
                                margin-bottom: 5px;
                            }

                            /* --- المحتوى الرئيسي --- */
                            .vip-master-container {
                                margin-right: calc(var(--sidebar-width) + 30px);
                                margin-left: 15px;
                                padding-top: 15px;
                            }

                            h1 { font-size: 1.6rem !important; margin-bottom: 15px !important; }

                            /* --- البث الحي (تحويله لشبكة كروت صغيرة بجانب بعضها) --- */
                            #render-live-feed-matrix {
                                display: grid;
                                /* يظهر 3 أو 4 بلاغات في السطر الواحد */
                                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                                gap: 12px;
                            }

                            .ticket-visual-unit {
                                padding: 12px 15px;
                                height: 100px; /* تقليل الارتفاع جداً */
                                margin-bottom: 0;
                                border-right-width: 6px;
                                background: #0d1117;
                                border-radius: 10px;
                                transition: 0.3s;
                            }

                            /* توسيع الكارت عند الوقوف عليه لرؤية التفاصيل */
                            .ticket-visual-unit:hover {
                                height: auto;
                                min-height: 100px;
                                z-index: 100;
                            }

                            /* تصغير النصوص داخل البلاغ */
                            .ticket-visual-unit b { font-size: 1rem !important; } /* اسم الفرع */
                            .ticket-visual-unit div { font-size: 0.75rem; } /* التاريخ والوقت */

                            /* تصغير رقم الأوردر الضخم */
                            .ticket-visual-unit div[style*="font-size: 3rem"],
                            .ticket-visual-unit div[style*="font-size: 5rem"] {
                                font-size: 1.4rem !important;
                                font-weight: 900;
                                margin: 5px 0 !important;
                            }

                            /* --- تصغير الخانات والأزرار --- */
                            input, select, textarea {
                                padding: 8px 12px;
                                font-size: 0.85rem;
                                margin-bottom: 10px;
                                border-radius: 8px;
                            }

                            .btn-vip-execute-master {
                                padding: 10px;
                                font-size: 0.95rem;
                                border-radius: 10px;
                            }

                            /* تصغير الزر العائم */
                            .floating-action-master {
                                width: 55px; height: 55px;
                                font-size: 1.5rem;
                                bottom: 20px; left: 20px;
                            }

                            /* --- تصغير كروت التقارير واليومية --- */
                            .analytics-pill-card {
                                padding: 20px;
                            }
                            .analytics-pill-card h2 {
                                font-size: 1.8rem;
                            }
                            .branch-data-card {
                                padding: 20px;
                            }
                            .massive-daily-input {
                                font-size: 2.5rem; /* تصغير رقم اليومية الضخم */
                            }
                /* تنسيق شاشة الإنذار */
                                        .alarm-screen {
                                            position: fixed;
                                            top: 0; left: 0; width: 100%; height: 100%;
                                            background-color: rgba(220, 38, 38, 0.85); /* لون أحمر شفاف قليلاً */
                                            z-index: 10000; /* فوق كل شيء */
                                            display: flex;
                                            justify-content: center;
                                            align-items: center;
                                            backdrop-filter: blur(10px);
                                            animation: flashRed 1s infinite; /* وميض مستمر */
                                        }

                                        /* حركة الوميض */
                                        @keyframes flashRed {
                                            0% { background-color: rgba(220, 38, 38, 0.85); box-shadow: inset 0 0 0 0 red; }
                                            50% { background-color: rgba(185, 28, 28, 0.95); box-shadow: inset 0 0 100px 50px #ff0000; }
                                            100% { background-color: rgba(220, 38, 38, 0.85); box-shadow: inset 0 0 0 0 red; }
                                        }

                                        .alarm-content {
                                            text-align: center;
                                            color: white;
                                            background: #000;
                                            padding: 40px;
                                            border-radius: 20px;
                                            border: 4px solid #fca5a5;
                                            box-shadow: 0 0 50px rgba(0,0,0,0.8);
                                        }

                                        .btn-stop-alarm {
                                            background: #fff;
                                            color: #dc2626;
                                            border: none;
                                            padding: 15px 40px;
                                            font-size: 1.5rem;
                                            font-weight: 900;
                                            border-radius: 50px;
                                            cursor: pointer;
                                            margin-top: 20px;
                                            transition: 0.2s;
                                        }

                                        .btn-stop-alarm:hover {
                                            transform: scale(1.1);
                                            box-shadow: 0 0 20px #fff;
                                        }

                /* تصميم الحاوية الكبرى للتقارير */
                .reports-premium-container {
                    padding: 20px;
                    background: radial-gradient(circle at top right, #1e293b, #0f172a);
                    border-radius: 30px;
                    color: #f8fafc;
                }

                /* كروت الـ KPI (المؤشرات السريعة) بتصميم 3D */
                .kpi-grid-premium {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .kpi-card-3d {
                    background: rgba(255, 255, 255, 0.05);
                    backdrop-filter: blur(15px);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    padding: 25px;
                    border-radius: 20px;
                    text-align: center;
                    transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    cursor: pointer;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                }

                .kpi-card-3d:hover {
                    transform: translateY(-10px) rotateX(10deg);
                    background: rgba(255, 255, 255, 0.1);
                    border-color: var(--gold-master);
                    box-shadow: 0 20px 50px rgba(245, 158, 11, 0.2);
                }

                .kpi-card-3d i { font-size: 2.5rem; margin-bottom: 15px; display: block; }
                .kpi-card-3d h3 { font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px; }
                .kpi-card-3d .value { font-size: 2rem; font-weight: 900; color: #fff; }

                /* تصميم الجدول الاحترافي */
                .matrix-wrapper-3d {
                    background: rgba(15, 23, 42, 0.8);
                    border-radius: 25px;
                    padding: 20px;
                    border: 1px solid rgba(255,255,255,0.05);
                    margin-bottom: 30px;
                    overflow-x: auto;
                }

                .premium-table {
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 0 10px;
                }

                .premium-table th {
                    background: transparent;
                    color: var(--gold-master);
                    padding: 15px;
                    font-size: 0.8rem;
                    text-transform: uppercase;
                    border-bottom: 2px solid rgba(245, 158, 11, 0.3);
                }

                .premium-table tr {
                    transition: 0.3s;
                }

                .premium-table td {
                    background: rgba(255, 255, 255, 0.03);
                    padding: 15px;
                    font-weight: 600;
                    text-align: center;
                    border-top: 1px solid rgba(255,255,255,0.05);
                    border-bottom: 1px solid rgba(255,255,255,0.05);
                }

                .premium-table td:first-child { border-radius: 15px 0 0 15px; text-align: right; color: var(--gold-bright); }
                .premium-table td:last-child { border-radius: 0 15px 15px 0; }

                .premium-table tr:hover td {
                    background: rgba(245, 158, 11, 0.1);
                    transform: scale(1.01);
                    color: #fff;
                }

                /* تجميل سطر الإجمالي */
                .row-grand-total td {
                    background: linear-gradient(90deg, #b45309, #f59e0b) !important;
                    color: #000 !important;
                    font-weight: 900 !important;
                }

                /* شريط النسبة المئوية الجمالي */
                .progress-container {
                    width: 100%;
                    background: rgba(255,255,255,0.1);
                    height: 8px;
                    border-radius: 10px;
                    margin-top: 5px;
                }
                .progress-bar {
                    height: 100%;
                    background: var(--gold-master);
                    border-radius: 10px;
                    box-shadow: 0 0 10px var(--gold-master);
                }

                /* تصميم تقارير VIP - مطابقة للصور */
                .reports-dashboard-container {
                    background: #e2e8f0; /* خلفية رمادية فاتحة للموديول بالكامل */
                    padding: 20px;
                    border-radius: 15px;
                    color: #1e293b;
                }

                .blue-report-table {
                    width: 100%;
                    border-collapse: collapse;
                    background: white;
                    font-size: 0.8rem;
                    border: 1px solid #1e3a8a;
                    margin-bottom: 20px;
                }

                .blue-report-table th {
                    background: #3b82f6; /* أزرق فاتح للهيدر */
                    color: white;
                    padding: 8px 4px;
                    border: 1px solid #1e40af;
                    text-align: center;
                }

                .blue-report-table td {
                    border: 1px solid #94a3b8;
                    padding: 6px 3px;
                }

                /* حاوية التقارير الكبرى */
                .reports-dashboard-v2 {
                    background: #0f172a;
                    padding: 25px;
                    border-radius: 20px;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                    color: #e2e8f0;
                }

                /* جداول بتصميم زجاجي احترافي */
                .glass-table-container {
                    background: rgba(30, 41, 59, 0.7);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 20px;
                    border: 1px solid rgba(255,255,255,0.1);
                    margin-bottom: 30px;
                    overflow-x: auto;
                    box-shadow: inset 0 1px 1px rgba(255,255,255,0.1);
                }

                .premium-matrix {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.85rem;
                }

                .premium-matrix th {
                    background: #1e40af; /* أزرق ملكي للهيدر */
                    color: white;
                    padding: 12px 5px;
                    border: 1px solid #334155;
                    text-align: center;
                    font-weight: 800;
                }

                .premium-matrix td {
                    padding: 10px 5px;
                    border: 1px solid #334155;
                    text-align: center;
                    font-weight: 600;
                }

                /* تلوين الأعمدة الإجمالية مثل الصورة */
                .col-total-blue { background: #1e3a8a !important; color: white !important; } /* أزرق غامق */
                .col-subtotal-light { background: #1e293b; color: #fbbf24; } /* أزرق داكن ببيانات ذهبية */

                .premium-matrix tr:hover td {
                    background: rgba(255,255,255,0.05);
                    transition: 0.2s;
                }

                /* كروت الـ 3D للملخص */
                .stats-cards-3d {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .card-v3 {
                    background: linear-gradient(145deg, #1e293b, #0f172a);
                    padding: 20px;
                    border-radius: 15px;
                    border: 1px solid rgba(255,255,255,0.05);
                    text-align: center;
                    box-shadow: 10px 10px 20px #080c14, -5px -5px 15px #1a2436; /* تأثير 3D Neumorphism */
                }

                .card-v3 h4 { color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px; }
                .card-v3 .val { font-size: 1.8rem; font-weight: 900; color: #fbbf24; }

                /* تأثيرات 3D للكروت والحاويات */
                .stats-cards-3d {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .card-v3 {
                    background: linear-gradient(145deg, #1e293b, #0f172a);
                    padding: 20px;
                    border-radius: 15px;
                    border: 1px solid rgba(255,255,255,0.05);
                    text-align: center;
                    box-shadow: 10px 10px 20px #080c14, -5px -5px 15px #1a2436;
                    transition: 0.3s;
                }

                .card-v3:hover {
                    transform: translateY(-5px);
                    box-shadow: 15px 15px 30px #080c14, -10px -10px 20px #1a2436;
                }

                .floating-3d {
                    transform: translateY(-10px);
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 20px rgba(245, 158, 11, 0.1);
                    transition: 0.3s;
                }

                .floating-3d:hover {
                    transform: translateY(-15px);
                    box-shadow: 0 30px 60px rgba(0,0,0,0.4), 0 0 30px rgba(245, 158, 11, 0.2);
                }

                .reports-grid-layout {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-top: 30px;
                }

                .reports-dashboard-v2 {
                    background: #0f172a;
                    padding: 20px;
                    border-radius: 20px;
                }

                .glass-table-container {
                    background: rgba(30, 41, 59, 0.7);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 20px;
                    border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
                    overflow-x: auto;
                }

                .premium-matrix {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.8rem;
                    color: #e2e8f0;
                }

                .premium-matrix th {
                    background: #1e40af; /* أزرق ملكي */
                    color: white;
                    padding: 10px 5px;
                    border: 1px solid #334155;
                    text-align: center;
                }

                .premium-matrix td {
                    padding: 8px 4px;
                    border: 1px solid #334155;
                    text-align: center;
                }

                .col-total-blue { background: #1e3a8a !important; font-weight: 800; }
                .col-subtotal-light { background: #1e293b; color: #fbbf24; font-weight: bold; }

                .premium-matrix tr:hover td {
                    background: rgba(251, 191, 36, 0.1);
                    transition: 0.3s;
                }

                /* حاوية التقارير الكبرى */
                .reports-dashboard-v2 {
                    background: #0f172a;
                    padding: 25px;
                    border-radius: 20px;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                    color: #e2e8f0;
                }

                /* جداول بتصميم زجاجي احترافي */
                .glass-table-container {
                    background: rgba(30, 41, 59, 0.7);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 20px;
                    border: 1px solid rgba(255,255,255,0.1);
                    margin-bottom: 30px;
                    overflow-x: auto;
                    box-shadow: inset 0 1px 1px rgba(255,255,255,0.1);
                }

                .premium-matrix {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.85rem;
                }

                .premium-matrix th {
                    background: #1e40af; /* أزرق ملكي للهيدر */
                    color: white;
                    padding: 12px 5px;
                    border: 1px solid #334155;
                    text-align: center;
                    font-weight: 800;
                }

                .premium-matrix td {
                    padding: 10px 5px;
                    border: 1px solid #334155;
                    text-align: center;
                    font-weight: 600;
                }

                /* تلوين الأعمدة الإجمالية مثل الصورة */
                .col-total-blue { background: #1e3a8a !important; color: white !important; } /* أزرق غامق */
                .col-subtotal-light { background: #1e293b; color: #fbbf24; } /* أزرق داكن ببيانات ذهبية */

                .premium-matrix tr:hover td {
                    background: rgba(255,255,255,0.05);
                    transition: 0.2s;
                }

                /* كروت الـ 3D للملخص */
                .stats-cards-3d {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .card-v3 {
                    background: linear-gradient(145deg, #1e293b, #0f172a);
                    padding: 20px;
                    border-radius: 15px;
                    border: 1px solid rgba(255,255,255,0.05);
                    text-align: center;
                    box-shadow: 10px 10px 20px #080c14, -5px -5px 15px #1a2436; /* تأثير 3D Neumorphism */
                }

                .card-v3 h4 { color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px; }
                .card-v3 .val { font-size: 1.8rem; font-weight: 900; color: #fbbf24; }
                                    </style>
                                </head>
                                <body>

                                    <div id="system-toast-container"></div>
                                    <div id="master-dimmer" class="dimmer-overlay-master" onclick="closeAllMenus()"></div>

                                    <!-- ملف الصوت للتنبيه -->
                                    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

                                    <!-- شاشة الإنذار الحمراء -->
                                    <div id="red-alarm-overlay" class="alarm-screen hidden">
                                        <div class="alarm-content">
                                            <i class="fas fa-bell fa-shake" style="font-size: 5rem; margin-bottom: 20px;"></i>
                                            <h1>🚨 تنبيه هام! 🚨</h1>
                                            <p>يوجد بلاغ جديد يخص فرعك</p>
                                            <button class="btn-stop-alarm" onclick="stopAlarmAndShowTicket()">استلام البلاغ وإيقاف الصوت</button>
                                        </div>
                                    </div>

                                    <!-- Authentication Portal -->
                                    <div id="auth-portal-mask">
                                        <div class="massive-glass-card login-card-massive">
                                            <div class="identity-orb-vip" style="margin: 0 auto; cursor: default;">CMS</div>
                                            <h1 style="color:var(--gold-master); font-weight:950; margin-bottom:20px;">Ibn Masr CMS V47</h1>
                                            <p style="color:var(--text-muted-core); font-weight:900;">نظام الرقابة والتحليل الإحصائي الفائق V47.0</p>
                                            <div style="margin-top: 40px;">
                                                <label>كود الهوية الرقمية (UID)</label>
                                                <input type="text" id="auth-uid-master" placeholder="UID">
                                                <label>الرمز السري المشفر (PWD)</label>
                                                <input type="password" id="auth-pwd-master" placeholder="PWD">
                                                <button class="btn-vip-execute-master" onclick="runSecurityAuthSequence()">ولوج المنظومة الرقمية <i class="fas fa-shield-halved"></i></button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Main Interface -->
                                    <div id="main-system-viewport" class="hidden">
                                        
                                        <nav class="system-side-nav" id="system-side-nav">
                                            <button onclick="closeAllMenus()" style="display:none;" id="mobile-close-btn" class="nav-link-vip"><i class="fas fa-times"></i> إغلاق</button>
                                            <div class="identity-matrix">
                                                <div class="identity-orb-vip" id="ui-avatar-orb">V</div>
                                                <div class="identity-labels">
                                                    <h2 id="ui-user-fullname">---</h2>
                                                    <span id="ui-user-rank-label" style="display:block; margin-top:5px; color:var(--text-muted-core); font-size:0.9rem;">---</span>
                                                </div>
                                            </div>

                                            <div class="nav-hub-menu">
                                                <button class="nav-link-vip active" id="tab-live" onclick="switchToAppModule('live')"><i class="fas fa-satellite-dish"></i> البث المباشر</button>
                                                <button class="nav-link-vip" id="tab-daily" onclick="switchToAppModule('daily')"><i class="fas fa-calendar-check"></i> يومية الأوردرات</button>
                                                <button class="nav-link-vip" id="tab-archive" onclick="switchToAppModule('archive')"><i class="fas fa-database"></i> أرشيف السحابة</button>
                                                <button class="nav-link-vip" id="tab-reports" onclick="switchToAppModule('reports')"><i class="fas fa-chart-line"></i> تقارير الكفاءة</button>
                                                <button class="nav-link-vip" id="tab-admin" onclick="switchToAppModule('admin')"><i class="fas fa-crown"></i> الإدارة العليا</button>
                                                <button class="nav-link-vip logout-btn-sidebar" onclick="runSystemLogoutSequence()"><i class="fas fa-power-off"></i> تسجيل الخروج</button>
                                            </div>
                                        </nav>

                                        <div class="vip-master-container">
                                            <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                                            <button class="floating-action-master" id="floating-plus-btn" onclick="openSidebarControl()"><i class="fas fa-plus"></i></button>

                                            <!-- إضافة شريط الفلتر العلوي -->
                                            <div class="massive-glass-card" style="padding: 15px 25px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap;">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <i class="fas fa-filter" style="color: var(--gold-master);"></i>
                                                    <span style="font-weight: 800;">تصفية حسب الفرع:</span>
                                                    <select id="global-branch-filter" onchange="refreshAllModulesData()" style="width: 200px; margin-bottom: 0; padding: 5px 15px;">
                                                        <option value="ALL">-- عرض جميع الفروع --</option>
                                                    </select>
                                                </div>
                                                <div id="branch-quick-stat" style="color: var(--gold-master); font-weight: 900; font-size: 1.1rem;">
                                                    <!-- سيظهر هنا اسم الفرع المختار حالياً -->
                                                </div>
                                            </div>

                                            <!-- LIVE MODULE -->
                                            <div id="module-view-live">
                                                <h1 style="font-size:2rem; margin-bottom:20px; color:var(--text-pure); display:flex; align-items:center; gap:15px;">
                                                    <i class="fas fa-satellite-dish" style="color:var(--gold-master)"></i> البث الحي للبلاغات
                                                </h1>
                                                <div id="render-live-feed-matrix" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px;"></div>
                                            </div>

                                            <!-- DAILY MODULE -->
                                            <div id="module-view-daily" class="hidden">
                                                <div class="massive-glass-card" style="padding:80px; margin-bottom:80px;">
                                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                                                        <div>
                                                            <h2 style="color:var(--gold-master); font-size:2rem; margin:0;">محرك مدخلات اليومية</h2>
                                                        </div>
                                                        <div style="width:250px;"><input type="date" id="daily-master-date-picker" style="font-size:1.2rem;" onchange="loadDailySnapshotData()"></div>
                                                    </div>
                                                    <div id="render-daily-grid-hub" class="daily-matrix-display"></div>
                                                </div>
                                            </div>

                                            <!-- ARCHIVE MODULE -->
                                            <div id="module-view-archive" class="hidden">
                                                <div class="massive-glass-card" style="padding:60px; display:flex; gap:40px; margin-bottom:60px; align-items:flex-end;">
                                                    <div style="flex:1;"><label>من:</label><input type="date" id="archive-date-from"></div>
                                                    <div style="flex:1;"><label>إلى:</label><input type="date" id="archive-date-to"></div>
                                                    <button class="btn-vip-execute-master" style="width:300px;" onclick="runArchiveRefreshSequence()">تحديث</button>
                                                </div>
                                                <div id="render-archive-grid-hub" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(700px, 1fr)); gap:50px;"></div>
                                            </div>

                                            <!-- موديول تقارير VIP V47 المطور (تأثيرات 3D + رسم دائري) -->
                                            <div id="module-view-reports" class="hidden reports-dashboard-v2">

                                                <!-- شريط التحكم العلوي -->
                                                <div class="massive-glass-card" style="padding:20px; display:flex; gap:20px; margin-bottom:30px; align-items:flex-end; border-radius:20px;">
                                                    <div style="flex:1;"><label>📅 من:</label><input type="date" id="reports-date-from"></div>
                                                    <div style="flex:1;"><label>📅 إلى:</label><input type="date" id="reports-date-to"></div>
                                                    <button class="btn-vip-execute-master" style="width:200px;" onclick="executeAdvancedAnalyticsSequence()">توليد الذكاء التحليلي</button>
                                                    <button class="btn-vip-execute-master" style="width:100px; background:#1d4ed8;" onclick="exportReportsToExcel()"><i class="fas fa-file-excel"></i></button>
                                                </div>

                                                <!-- قسم الكروت ثلاثية الأبعاد (KPIs) -->
                                                <div class="stats-cards-3d">
                                                    <div class="card-v3">
                                                        <h4>إجمالي العمليات</h4>
                                                        <div class="val" id="kpi-ops">0</div>
                                                    </div>
                                                    <div class="card-v3">
                                                        <h4>إجمالي الشكاوى</h4>
                                                        <div class="val" id="kpi-comps" style="color:#ef4444;">0</div>
                                                    </div>
                                                    <div class="card-v3">
                                                        <h4>معدل الأداء العام</h4>
                                                        <div class="val" id="kpi-rate" style="color:#10b981;">0%</div>
                                                    </div>
                                                </div>

                                                <!-- الجدول الكبير (المصفوفة الشاملة) بتصميم زجاجي عائم -->
                                                <div class="glass-table-container floating-3d">
                                                    <h3 style="color:#fbbf24; margin-bottom:15px; border-right:4px solid #fbbf24; padding-right:10px;">
                                                        <i class="fas fa-layer-group"></i> مصفوفة تشريح البيانات الشاملة
                                                    </h3>
                                                    <div id="matrix-report-table-container"></div>
                                                </div>

                                                <!-- شبكة الرسوم البيانية (2 رسم بياني + جدول) -->
                                                <div class="reports-grid-layout">

                                                    <!-- 1. الرسم البياني للأعمدة (3D) -->
                                                    <div class="glass-table-container floating-3d">
                                                        <h4 style="color:#fbbf24; margin-bottom:10px;"><i class="fas fa-chart-bar"></i> كفاءة الفروع</h4>
                                                        <div style="height: 300px;"><canvas id="master-reports-canvas"></canvas></div>
                                                    </div>

                                                    <!-- 2. الرسم الدائري (Pie Chart) لتوزيع الشكاوى -->
                                                    <div class="glass-table-container floating-3d">
                                                        <h4 style="color:#fbbf24; margin-bottom:10px;"><i class="fas fa-chart-pie"></i> توزيع أنواع الشكاوى (%)</h4>
                                                        <div style="height: 300px;"><canvas id="complaint-types-pie-canvas"></canvas></div>
                                                    </div>

                                                    <!-- 3. الجدول الثاني (ملخص النسب) -->
                                                    <div class="glass-table-container floating-3d">
                                                        <h4 style="color:#fbbf24; margin-bottom:10px;"><i class="fas fa-list-ol"></i> ترتيب النسب</h4>
                                                        <div id="summary-percentage-table-container"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ADMIN MODULE (UPDATED WITH PRESENCE & LOGS) -->
                                            <div id="module-view-admin" class="hidden">
                                                
                                                <div class="massive-glass-card" style="padding:40px; margin-bottom:40px; border-top: 5px solid var(--success-glow);">
                                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px;">
                                                        <h3 style="color:var(--success-glow); font-size:1.8rem; margin:0; display:flex; align-items:center; gap:10px;">
                                                            <i class="fas fa-satellite-dish"></i> رادار المنظومة الحية
                                                        </h3>

                                                        <!-- اختيار الفرع للرادار -->
                                                        <div style="display:flex; align-items:center; gap:10px;">
                                                            <span style="color:var(--text-muted-core);">عرض فرع:</span>
                                                            <select id="radar-branch-filter-select" onchange="initPresenceMonitor()" style="width:200px; margin:0; padding:5px 10px;">
                                                                <option value="SHOW_ALL">-- الكل --</option>
                                                                <option value="ALL">الإدارة العليا</option>
                                                                <!-- الفروع الباقية هتضاف تلقائياً -->
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <!-- شبكة الرادار -->
                                                    <div id="adm-presence-grid" class="presence-grid" style="min-height:100px;">
                                                        <!-- الموظفين هيظهروا هنا -->
                                                    </div>
                                                </div>

                                                <div class="massive-glass-card" style="padding:30px; margin-top:30px; border-bottom: 4px solid var(--gold-master);">
                                                    <h3 style="color:var(--gold-master); margin-bottom:25px;"><i class="fas fa-history"></i> سجل النشاط التفصيلي</h3>

                                                    <!-- شريط الفلاتر -->
                                                    <div style="display:flex; gap:10px; margin-bottom:20px; flex-direction: row-reverse;">
                                                        <input type="text" id="log-search-name" placeholder="بحث بالاسم..." style="flex:2; margin:0;" onkeyup="applyLogsFilter()">
                                                        <input type="date" id="log-filter-date" style="flex:1; margin:0;" onchange="applyLogsFilter()">
                                                        <select id="log-filter-branch" style="flex:1; margin:0;" onchange="applyLogsFilter()">
                                                            <option value="">كل الفروع</option>
                                                        </select>
                                                        <button class="btn-vip-execute-master" style="width:auto; padding:0 20px;" onclick="resetLogsFilter()">إعادة ضبط</button>
                                                    </div>

                                                    <!-- حاوية الجدول -->
                                                    <div style="border: 1px solid rgba(255,255,255,0.1); border-radius:10px; overflow:hidden;">
                                                        <div class="log-table-row log-header">
                                                            <div>الموظف</div>
                                                            <div>الحدث (فتح/قفل)</div>
                                                            <div>التوقيت الدقيق</div>
                                                            <div>الفرع</div>
                                                        </div>
                                                        <div id="adm-access-logs-list" class="scrollable-admin-list">
                                                            <!-- البيانات تظهر هنا -->
                                                        </div>
                                                    </div>

                                                    <button class="btn-vip-execute-master" style="background:var(--danger-pulse); width:auto; margin-top:15px; font-size:0.8rem;" onclick="clearAllSystemLogs()">
                                                        <i class="fas fa-trash"></i> تصفير السجل
                                                    </button>
                                                </div>

                                                <div class="admin-layout-flex">
                                                    <div class="massive-glass-card" style="padding:80px;">
                                                        <h3 style="color:var(--gold-master); margin-bottom:60px;">التحكم بالفروع</h3>
                                                    
                                                        <div style="display:flex; gap:25px; margin-bottom:40px;">
                                                            <input id="adm-branch-name-input" placeholder="اسم الفرع">
                                                            <button class="btn-vip-execute-master" style="width:180px;" onclick="addSystemBranchCore()">إدراج</button>
                                                        </div>
                                                        
                                                        <div id="adm-branches-scroll-box" class="scrollable-admin-list"></div>
                                                        <hr style="margin:50px 0; border-color:var(--border-glow-line);">
                                                        <h3 style="color:var(--gold-master); margin-bottom:40px;">واتساب الإشعارات</h3>
                                                
                                                        <select id="adm-whatsapp-br-sel" onchange="renderBranchWhatsappList()"></select>
                                                        <div style="font-weight:600; color:var(--gold-master); margin-bottom:10px;">فرع: </div>
                                                        <div style="display:flex; gap:25px;">
                                                            <input id="adm-whatsapp-phone-input" placeholder="رقم الهاتف">
                                                            <button class="btn-vip-execute-master" style="width:180px;" onclick="bindNewWhatsappToBranch()">+ ربط</button>
                                                        </div>
                                                        <div id="adm-whatsapp-scroll-box" class="scrollable-admin-list" style="margin-top:40px;"></div>
                                                    </div>

                                                    <div class="massive-glass-card" style="padding:80px;">
                                                        <h3 style="color:var(--gold-master); margin-bottom:60px;">إدارة المستخدمين والصلاحيات</h3>
                                                        <div style="display:flex; gap:25px; margin-bottom:40px;">
                                                            <input id="adm-rank-name-input" placeholder="رتبة جديدة">
                                                            <button class="btn-vip-execute-master" style="width:180px;" onclick="registerNewRankTitleCore()">إضافة</button>
                                                        </div>
                                                        <select id="adm-rank-matrix-sel" onchange="loadRankPermissionsMatrixHub()"></select>
                                                        <div id="adm-permissions-grid-hub" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; background:rgba(0,0,0,0.6); padding:40px; border-radius:20px; margin-top:35px;">
                                                            <label><input type="checkbox" id="perm-view-all"> رؤية شاملة</label>
                                                            <label><input type="checkbox" id="perm-create-ticket"> إنشاء بلاغات</label>
                                                            <label><input type="checkbox" id="perm-reply-ticket"> صلاحية الرد</label>
                                                            <label><input type="checkbox" id="perm-daily-edit"> تحرير اليومية</label>
                                                            <label><input type="checkbox" id="perm-admin-access"> دخول الإدارة</label>
                                                            <button class="btn-vip-execute-master" style="grid-column: span 2;" onclick="saveRankPermissionsSequence()">تثبيت</button>
                                                        </div>
                                                        <hr style="margin:60px 0; border-color:var(--border-glow-line);">
                                                        <h3 style="color:var(--gold-master);">تسجيل عضو</h3>
                                                        <input id="reg-user-id-core" placeholder="ID">
                                                        <input id="reg-user-fullname-core" placeholder="الاسم">
                                                        <select id="reg-user-rank-sel-core"></select>
                                                        <select id="reg-user-branch-sel-core"></select>
                                                        <input id="reg-user-pass-core" type="password" placeholder="كلمة المرور">
                                                        <button class="btn-vip-execute-master" onclick="registerNewUserToSystemSequence()">تفعيل</button>
                                                        <div id="adm-users-scroll-box" class="scrollable-admin-list" style="margin-top:50px;"></div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <!-- Sidebar Complaint Form -->
                                    <div id="sidebar-complaint-arc-hub" class="sidebar-complaint-master">
                                        <h2 style="color:var(--gold-master); font-size:3rem; margin-bottom:60px;">تحرير مذكرة بلاغ CMS</h2>
                                        <label>الفرع</label><select id="f-branch-master-sel"></select>
                                        <label>التاريخ</label><input type="date" id="f-date-master">
                                        <label>الأوردر</label><input id="f-order-id-input" placeholder="#00000000">
                                        <label>العميل</label><input id="f-customer-name-input" placeholder="الاسم">
                                        <label>التصنيف</label>
                                        <select id="f-complaint-type-sel">
                                            <option>تأخير</option>
                                            <option>سوء خدمة</option>
                                            <option>ناقص</option>
                                            <option>سوء تعبئة</option>
                                            <option>خطأ في الطلب</option>
                                            <option>خطأ في الباقي</option>
                                            <option>جودة</option>
                                            <option>جسم غريب</option>
                                            <option>سوء سلوك</option>
                                            <option>مندوب</option>
                                            <option>طلب بارد</option>
                                            <option>ريسيبي</option>
                                            <option>تأخير شكوي</option>
                                            <option>تواصل من الفرع</option>
                                            <option>سوشيال</option>
                                        </select>
                                        <label>الطيار</label><input id="f-driver-name-input" placeholder="اسم الطيار">
                                        <label>التفاصيل</label><textarea id="f-complaint-msg-input" rows="8"></textarea>
                                        <button class="btn-vip-execute-master" id="submit-complaint-btn" onclick="runComplaintTicketSequence()">توجيه البلاغ فوراً</button>
                                    </div>



                                    <script>
                                        /* 
                                        ========================================================================
                                        --- INTERNAL CORE LOGIC V47.0 (PRESENCE + LOGS + HOVER UI) --- 
                                        ========================================================================
                                        */


                                        let currentUserSession = null;
                                        let complaintsCache = {};
                                        let systemSettingsCache = {};
                                        let branchListCache = [];
                                        let analyticsChartInstance = null;
                                        let analyticsTypeChartInstance = null;
                                        let allAccessLogsCache = []; // لتخزين السجلات مؤقتاً لسرعة الفلترة
                                        let isFirstLoad = true;

                                        // تسلسل المراحل (من يستلم بعد من؟)
                                        const stageHierarchy = {
                                            'sent_to_dispatcher': 'sent_to_branch_manager',     // الديسبتشر يبعت لمدير الفرع
                                            'sent_to_branch_manager': 'sent_to_regional_manager', // مدير الفرع يبعت لمدير المنطقة
                                            'sent_to_regional_manager': 'sent_back_to_call_center', // مدير المنطقة يبعت للكول سنتر
                                            'sent_back_to_call_center': 'ready_for_delivery'    // الكول سنتر يبعت للتوصيل (أو إنهاء)
                                        };
                                        const reverseStageHierarchy = {
                                            'sent_to_dispatcher': 'waiting_review',
                                            'sent_to_branch_manager': 'sent_to_dispatcher',
                                            'sent_to_regional_manager': 'sent_to_branch_manager',
                                            'sent_back_to_call_center': 'sent_to_regional_manager'
                                        };
                                        // مسميات الأشخاص المستلمين (عشان تظهر على الزرار)
                                        const stageRankNames = {
                                            'sent_to_dispatcher': 'الديسبتشر',
                                            'sent_to_branch_manager': 'مدير الفرع',
                                            'sent_to_regional_manager': 'مدير المنطقة',
                                            'sent_back_to_call_center': 'الكول سنتر',
                                            'ready_for_delivery': 'توصيل التعويض'
                                        };

                                        // أضف هذا الجزء تحت تعريف stageRankNames مباشرة
                                        const stageNamesAr = {
                                            'sent_to_dispatcher': 'عند الديسبتشر',
                                            'sent_to_branch_manager': 'عند مدير الفرع',
                                            'sent_to_regional_manager': 'عند مدير المنطقة',
                                            'sent_back_to_call_center': 'مراجعة الكول سنتر',
                                            'ready_for_delivery': 'جاهز للتوصيل',
                                            'delivered': 'تم التسليم والأرشفة'
                                        };

                                        // تحديد من يملك صلاحية "التحويل" في كل مرحلة
                                        const stageOwner = {
                                            'sent_to_dispatcher': 'ديسبتشر',
                                            'sent_to_branch_manager': 'مدير فرع',
                                            'sent_to_regional_manager': 'مدير منطقة',
                                            'sent_back_to_call_center': 'كول سنتر',
                                            'ready_for_delivery': 'ديسبتشر'
                                        };

                                    async function runSecurityAuthSequence() {
                                        // --- كود جديد لفك حظر الصوت ---
                                        const audio = document.getElementById("notification-sound");
                                        if(audio) {
                                            audio.play().then(() => {
                                                audio.pause();
                                                audio.currentTime = 0;
                                            }).catch(e => console.log("Audio permission needed"));
                                        }
                                        // ----------------------------

                                        const uid = document.getElementById('auth-uid-master').value.trim();
                                        const pwd = document.getElementById('auth-pwd-master').value.trim();

                                        if(!uid || !pwd) { renderSystemToast("يرجى إدخال البيانات!", "danger"); return; }

                                        // دخول السوبر أدمن
                                        if(uid === 'super' && pwd === 'vip2026') {
                                            const adminData = { id: 'super', name: 'Super Administrator', title: 'ROOT-COMMAND', branch: 'ALL', role: 'SUPER' };
                                            grantCoreAccess(adminData);
                                            return;
                                        }

                                        // دخول كول سنتر (Call Center)
                                        if(uid === 'callcenter' && pwd === '1234') {
                                            const callCenterData = { id: 'callcenter', name: 'Call Center Operator', title: 'كول سنتر', branch: 'ALL', role: 'USER' };
                                            grantCoreAccess(callCenterData);
                                            return;
                                        }

                                        // التأكد من المستخدم من خلال السيرفر (Firebase)
                                        const snap = await dbHub.ref('users/' + uid).once('value');
                                        const userData = snap.val();

                                        if(userData && userData.pass === pwd) {
                                            const dataToSave = { id: uid, ...userData, role: 'USER' };
                                            grantCoreAccess(dataToSave);
                                        } else {
                                            Swal.fire('خطأ', 'بيانات الدخول غير صحيحة أو غير مسجلة في هذا المتصفح', 'error');
                                        }
                                    }

                                        function grantCoreAccess(data) {
                                            localStorage.setItem('vip_v43_secure_token', JSON.stringify(data));

                                            // إعداد مراقبة التواجد (Presence)
                                            const presenceRef = dbHub.ref('users_presence/' + data.id);
                                            const connectedRef = dbHub.ref('.info/connected');

                                            connectedRef.on('value', (snap) => {
                                                if (snap.val() === true) {
                                                    // لو قفل الصفحة أو النت قطع، السيستم هيحوله أوفلاين لوحده بعد ثواني
                                                    presenceRef.onDisconnect().update({
                                                        state: 'offline',
                                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                                    });

                                                    // تعيين الحالة "أونلاين" فوراً
                                                    presenceRef.set({
                                                        state: 'online',
                                                        name: data.name,
                                                        title: data.title,
                                                        branch: data.branch,
                                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                                    });
                                                }
                                            });

                                            location.reload(); // إعادة تحميل الموقع لتنشيط الحالة
                                        }

                                        function runSystemLogoutSequence() {
                                            localStorage.removeItem('vip_v43_secure_token');
                                            location.reload();
                                        }

                                    // دي الوظيفة اللي بتبلغ السيرفر إنك "فاتح دلوقتي"، وأول ما تقفل المتصفح بتمسحك تلقائياً
                                    function activateLivePresence(userData) {
                                        if (!userData || !userData.id) return;

                                        // المسار في قاعدة البيانات
                                        const presenceRef = dbHub.ref('users_presence/' + userData.id);
                                        const connectedRef = dbHub.ref('.info/connected');

                                        connectedRef.on('value', (snap) => {
                                            if (snap.val() === true) {
                                                // أول ما المستخدم يقفل المتصفح أو النت يقطع
                                                presenceRef.onDisconnect().update({
                                                    state: 'offline',
                                                    last_changed: firebase.database.ServerValue.TIMESTAMP
                                                });

                                                // تعيين الحالة "أون لاين" فوراً
                                                presenceRef.set({
                                                    state: 'online',
                                                    name: userData.name,
                                                    title: userData.title,
                                                    branch: userData.branch,
                                                    last_changed: firebase.database.ServerValue.TIMESTAMP
                                                });
                                            }
                                        });
                                    }

                                        window.onload = () => {
                                            try {
                                                const sess = localStorage.getItem('vip_v43_secure_token');
                                                if(sess) {
                                                    const parsedSession = JSON.parse(sess);
                                                    // Validate session object
                                                    if(parsedSession && typeof parsedSession === 'object' && parsedSession.id && parsedSession.name && parsedSession.title) {
                                                        currentUserSession = parsedSession;
                                                        document.getElementById('auth-portal-mask').classList.add('hidden');
                                                        document.getElementById('main-system-viewport').classList.remove('hidden');
                                                        document.getElementById('ui-user-fullname').innerText = currentUserSession.name;
                                                        document.getElementById('ui-user-rank-label').innerText = currentUserSession.title;
                                                        document.getElementById('ui-avatar-orb').innerText = currentUserSession.name.charAt(0);

                                                        // تشغيل مراقبة التواجد الحية
                                                        activateLivePresence(currentUserSession);

                                                        // ضبط الفلتر الافتراضي للسوبر أدمن والكول سنتر لعرض كل الشكاوى
                                                        if (currentUserSession.role === 'SUPER' || currentUserSession.branch === 'ALL') {
                                                            document.getElementById('global-branch-filter').value = 'ALL';
                                                        }

                                                        // ضبط التواريخ الافتراضية
                                                        const todayStr = new Date().toISOString().split('T')[0];
                                                        const dateInputs = ['daily-master-date-picker', 'archive-date-from', 'archive-date-to', 'reports-date-from', 'reports-date-to', 'f-date-master'];
                                                        dateInputs.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = todayStr; });

                                                        // تحديث البيانات من localStorage
                                                        branchListCache = JSON.parse(localStorage.getItem('branches') || '[]');
                                                        systemSettingsCache.custom_ranks = JSON.parse(localStorage.getItem('custom_ranks') || '{}');
                                                        systemSettingsCache.permissions = JSON.parse(localStorage.getItem('permissions') || '{}');

                                                        syncUiDropdownSelections();
                                                        renderAdminBranchScrollBox();
                                                        renderAdminUsersScrollBox();

                                                        runPermissionShieldCheck(); // تشغيل الصلاحيات

                                                        initCoreDataListeners(); // تشغيل مراقبة البيانات من Firebase

                                                        initLicensingShield(); // تشغيل محرك الاشتراك
                                                    } else {
                                                        // Invalid session, clear it
                                                        localStorage.removeItem('vip_v43_secure_token');
                                                        console.warn('Invalid session data detected and cleared.');
                                                        location.reload();
                                                    }
                                                }
                                            } catch (error) {
                                                console.error('Error loading session:', error);
                                                localStorage.removeItem('vip_v43_secure_token');
                                                location.reload();
                                            }
                                        };

                                        async function initPresenceMonitor() {
                                            const radarFilter = document.getElementById('radar-branch-filter-select');
                                            let selectedBranch = radarFilter ? radarFilter.value : "SHOW_ALL";

                                            // جلب كل اليوزرز المسجلين
                                            const usersSnap = await dbHub.ref('users').once('value');
                                            const allUsers = usersSnap.val() || {};

                                            // مراقبة الحالات الحية (Online/Offline) من السيرفر
                                            dbHub.ref('users_presence').on('value', snap => {
                                                const presenceData = snap.val() || {};
                                                const grid = document.getElementById('adm-presence-grid');
                                                if(!grid) return;

                                                grid.innerHTML = ''; // مسح الرادار لإعادة الرسم

                                                let usersToDisplay = [];

                                                Object.keys(allUsers).forEach(uid => {
                                                    const user = allUsers[uid];
                                                    // فلترة حسب الفرع
                                                    if (selectedBranch === "SHOW_ALL" || user.branch === selectedBranch) {
                                                        const liveInfo = presenceData[uid] || {};
                                                        const isOnline = liveInfo.state === 'online';

                                                        usersToDisplay.push({ uid, name: user.name, title: user.title, isOnline });
                                                    }
                                                });

                                                // ترتيب: اللي فاتح يظهر الأول
                                                usersToDisplay.sort((a, b) => b.isOnline - a.isOnline);

                                                // رسم العناصر
                                                usersToDisplay.forEach(u => {
                                                    grid.innerHTML += `
                                                        <div class="presence-user-orb ${u.isOnline ? 'orb-online' : 'orb-offline'}" title="${u.isOnline ? 'متصل الآن' : 'غير متصل'}">
                                                            <div class="avatar-ring">
                                                                ${u.name.charAt(0)}
                                                                <div class="status-indicator"></div>
                                                            </div>
                                                            <div class="user-name-label">${u.name}</div>
                                                            <div style="font-size:0.7rem; color:var(--gold-master); font-weight:800;">${u.title}</div>
                                                        </div>`;
                                                });
                                            });
                                        }

                                        function applyLogsFilter() {
                                            // جلب القيم من مدخلات الفلتر
                                            const searchName = document.getElementById('log-search-name').value.toLowerCase();
                                            const filterDate = document.getElementById('log-filter-date').value;
                                            let filterBranch = document.getElementById('log-filter-branch').value;
                                            const list = document.getElementById('adm-access-logs-list');

                                            if(!list) return;
                                            list.innerHTML = '';

                                            // For branch managers, only show their branch logs
                                            if (currentUserSession.title === 'مدير فرع' && currentUserSession.role !== 'SUPER') {
                                                filterBranch = currentUserSession.branch;
                                                document.getElementById('log-filter-branch').value = filterBranch;
                                            }

                                            // تصفية المصفوفة بناءً على الشروط الـ 3
                                            const filtered = allAccessLogsCache.filter(log => {
                                                const matchesName = log.user.toLowerCase().includes(searchName);

                                                // تحويل الـ timestamp لتاريخ بصيغة yyyy-mm-dd للمقارنة
                                                const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                                                const matchesDate = filterDate ? (logDate === filterDate) : true;

                                                // مقارنة الفرع (لو "كل الفروع" يبقى فاضي ويعدي الكل)
                                                const matchesBranch = (filterBranch === "" || filterBranch === "كل الفروع") ? true : (log.branch === filterBranch);

                                                return matchesName && matchesDate && matchesBranch;
                                            });

                                            if (filtered.length === 0) {
                                                list.innerHTML = `<div style="text-align:center; padding:50px; color:var(--text-muted-core);">لا توجد سجلات تطابق البحث</div>`;
                                                return;
                                            }

                                            // عرض النتائج في الجدول
                                            filtered.forEach(log => {
                                                const d = new Date(log.timestamp);
                                                const timeStr = d.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                                                const isOnline = log.action.includes('ONLINE') || log.action.includes('فتح');

                                                list.innerHTML += `
                                                    <div class="log-table-row">
                                                        <div style="font-weight:600;">${log.user}</div>
                                                        <div style="color:${isOnline ? 'var(--success-glow)' : '#ef4444'}">
                                                            <i class="fas ${isOnline ? 'fa-sign-in-alt' : 'fa-sign-out-alt'}"></i> ${log.action}
                                                        </div>
                                                        <div style="direction:ltr; font-family:monospace; font-size:0.85rem;">${timeStr}</div>
                                                        <div style="color:var(--gold-master);">${log.branch || '---'}</div>
                                                    </div>`;
                                            });
                                        }

                                        // دالة إعادة الضبط (زر "إعادة ضبط")
                                        function resetLogsFilter() {
                                            document.getElementById('log-search-name').value = '';
                                            document.getElementById('log-filter-date').value = '';
                                            document.getElementById('log-filter-branch').value = '';
                                            applyLogsFilter(); // تحديث الجدول بعد المسح
                                        }

                                        function loadLogsFromFirebase() {
                                            dbHub.ref('access_logs').limitToLast(100).on('value', snap => {
                                                const logs = snap.val();
                                                allAccessLogsCache = [];
                                                if (logs) {
                                                    Object.keys(logs).forEach(key => {
                                                        allAccessLogsCache.push({ id: key, ...logs[key] });
                                                    });
                                                    allAccessLogsCache.reverse(); // الأحدث فوق
                                                    applyLogsFilter(); // عرضهم في الجدول
                                                }
                                            });
                                        }

                                        // === وظيفة بروفايل الموظف (عرض التايم لاين الخاص به) ===
                                        async function viewUserProfileActivity(uid, userName) {
                                            // إظهار رسالة جاري التحميل
                                            Swal.fire({ title: 'جاري جلب السجل...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                                            // جلب آخر 50 سجل من قاعدة البيانات مباشرة لضمان الدقة
                                            const snap = await dbHub.ref('access_logs').orderByChild('uid').equalTo(uid).limitToLast(50).once('value');
                                            const logsData = snap.val();
                                            
                                            let timelineHtml = `<div style="text-align:right; max-height:400px; overflow-y:auto; padding:10px; direction:rtl;">`;
                                            
                                            if(!logsData) {
                                                timelineHtml += `<p style="text-align:center; padding:20px;">لا توجد سجلات نشاط مسجلة لهذا الموظف بعد.</p>`;
                                            } else {
                                                // تحويل السجلات لمصفوفة وترتيبها من الأحدث للأقدم
                                                const sortedLogs = Object.values(logsData).sort((a, b) => b.timestamp - a.timestamp);
                                                
                                                sortedLogs.forEach(l => {
                                                    const dateObj = new Date(l.timestamp);
                                                    const time = dateObj.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                                                    const date = dateObj.toLocaleDateString('ar-EG');
                                                    const isOnline = l.action.includes('ONLINE');
                                                    
                                                    timelineHtml += `
                                                        <div style="border-bottom:1px solid #30363d; padding:12px 0; display:flex; justify-content:space-between; align-items:center;">
                                                            <div>
                                                                <span style="color:${isOnline ? '#39d353' : '#f85149'}; font-size:1.1rem; margin-left:10px;">
                                                                    ${isOnline ? '●' : '●'}
                                                                </span>
                                                                <b style="color:#f0f6fc;">${l.action.split('(')[0]}</b>
                                                            </div>
                                                            <div style="text-align:left;">
                                                                <div style="font-size:0.85rem; color:#f0f6fc;">${time}</div>
                                                                <div style="font-size:0.7rem; color:#8b949e;">${date}</div>
                                                            </div>
                                                        </div>`;
                                                });
                                            }
                                            timelineHtml += `</div>`;

                                            Swal.fire({
                                                title: `<span style="color:#f59e0b">ملف نشاط: ${userName}</span>`,
                                                html: timelineHtml,
                                                confirmButtonText: 'إغلاق',
                                                confirmButtonColor: '#21262d',
                                                background: '#0d1117',
                                                color: '#f0f6fc',
                                                width: '450px'
                                            });
                                        }

                                        function checkForNewComplaintsAndPlaySound(newOps) {
                                            let triggered = false;

                                            // 1. استثناء السوبر أدمن من الإنذار الصوتي تماماً
                                            if (currentUserSession.role === 'SUPER') return;

                                            // 2. استثناء موظفي الكول سنتر أو الإدارة (الذين فرعهم ALL) من الإنذار
                                            if (currentUserSession.branch === 'ALL') return;

                                            Object.keys(newOps).forEach(id => {
                                                // إذا كان البلاغ جديد (غير موجود في الكاش)
                                                if (!complaintsCache[id]) {
                                                    const ticket = newOps[id];

                                                    // 3. الشرط الجوهري: الإنذار يشتغل فقط إذا كان فرع الموظف مطابق لفرع البلاغ
                                                    if (currentUserSession.branch === ticket.branch) {
                                                        triggered = true;
                                                    }
                                                }
                                            });

                                            if (triggered) {
                                                triggerRedAlarm(); // تشغيل الإنذار الأحمر والصوت
                                            }
                                        }

                                        // دالة تشغيل الإنذار
                                        function triggerRedAlarm() {
                                            const overlay = document.getElementById('red-alarm-overlay');
                                            const audio = document.getElementById('notification-sound');

                                            // إظهار الشاشة الحمراء
                                            overlay.classList.remove('hidden');
                                            overlay.style.display = 'flex'; // تأكيد الإظهار

                                            // تشغيل الصوت بشكل متكرر (Loop)
                                            if (audio) {
                                                audio.loop = true; // تفعيل التكرار
                                                audio.currentTime = 0;
                                                audio.play().catch(e => console.log("User interaction needed for audio"));
                                            }
                                        }

                                        // دالة إيقاف الإنذار (مربوطة بالزر)
                                        function stopAlarmAndShowTicket() {
                                            const overlay = document.getElementById('red-alarm-overlay');
                                            const audio = document.getElementById('notification-sound');

                                            // إخفاء الشاشة الحمراء
                                            overlay.classList.add('hidden');
                                            overlay.style.display = 'none';

                                            // إيقاف الصوت
                                            if (audio) {
                                                audio.pause();
                                                audio.currentTime = 0;
                                                audio.loop = false; // إلغاء التكرار
                                            }

                                            // توجيه المستخدم لصفحة البث المباشر (اختياري)
                                            switchToAppModule('live');
                                            // عمل سكرول لأعلى الصفحة لرؤية البلاغ الجديد
                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                        }

                                        function playNotificationSound() {
                                            const audio = document.getElementById("notification-sound");
                                            if (audio) {
                                                audio.currentTime = 0; // إعادة الصوت للبداية
                                                // محاولة التشغيل (المتصفحات تتطلب تفاعل المستخدم أولاً)
                                                const playPromise = audio.play();
                                                if (playPromise !== undefined) {
                                                    playPromise.catch(error => {
                                                        console.log("Auto-play was prevented by browser logic.");
                                                    });
                                                }
                                            }
                                        }

                                        function initCoreDataListeners() {
                                            console.log("بدء مراقبة البيانات من Firebase...");

                                            // مراقبة الإعدادات (الفروع والرتب)
                                            dbHub.ref('settings').on('value', snap => {
                                                systemSettingsCache = snap.val() || {};
                                                branchListCache = systemSettingsCache.branches ? Object.values(systemSettingsCache.branches) : [];
                                                syncUiDropdownSelections();
                                                renderAdminBranchScrollBox();
                                                console.log("تم تحميل الإعدادات والفروع");
                                            });

                                            // مراقبة الصلاحيات من السيرفر حياً
                                            dbHub.ref('settings/permissions').on('value', snap => {
                                                const allPermissions = snap.val() || {};
                                                systemSettingsCache.permissions = allPermissions;

                                                // إعادة تشغيل "درع الحماية" لتطبيق الصلاحيات الجديدة فوراً
                                                runPermissionShieldCheck();
                                                console.log("تم تحديث درع الصلاحيات من السيرفر");
                                            });

                                            // مراقبة الشكاوى (العمليات)
                                            dbHub.ref('operations').on('value', snap => {
                                                const newOperations = snap.val() || {};
                                                complaintsCache = newOperations;

                                                console.log("وصلت شكاوى جديدة من السيرفر عددها: " + Object.keys(newOperations).length);

                                                // رسم الشكاوى في الشاشة فوراً
                                                renderLiveBroadcastMatrix();
                                                runArchiveRefreshSequence();
                                            }, error => {
                                                console.error("خطأ في قراءة الشكاوى:", error);
                                            });
                                        }

                                        async function loadDailySnapshotData() {
                                            let dateStr = document.getElementById('daily-master-date-picker').value;
                                            const gridBox = document.getElementById('render-daily-grid-hub');
                                            if (!gridBox) return;

                                            gridBox.innerHTML = `<h2 style="grid-column:1/-1;text-align:center;padding:100px; color:var(--gold-master);">جاري التحميل...</h2>`;

                                            const dSnap = await dbHub.ref(`daily_stats/${dateStr}`).get();
                                            const dailyData = dSnap.val() || {};

                                            const userBranch = currentUserSession.branch;
                                            const isMaster = (currentUserSession.role === 'SUPER' || userBranch === 'ALL');

                                            // تحديد أي فروع ستظهر في الشاشة
                                            const branchesToShow = isMaster ? branchListCache : [userBranch];

                                            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                            const canEdit = p.daily_edit || currentUserSession.role === 'SUPER';

                                            let html = '';
                                            branchesToShow.forEach(branch => {
                                                html += `
                                                    <div class="massive-glass-card branch-data-card">
                                                        <h4 style="font-size:2.5rem;">${branch}</h4>
                                                        <input type="number" class="massive-daily-input"
                                                            value="${dailyData[branch] || 0}"
                                                            ${canEdit ? '' : 'disabled'}
                                                            onchange="commitDailyOrderValue('${dateStr}','${branch}',this.value)">
                                                        <div style="margin-top:20px;color:var(--text-muted-core);">أوردرات يوم ${dateStr}</div>
                                                    </div>`;
                                            });
                                            gridBox.innerHTML = html || `<h2 style="grid-column:1/-1;text-align:center;padding:100px;">لا توجد بيانات متاحة</h2>`;
                                        }

                                        async function commitDailyOrderValue(date, br, val) {
                                            if(val < 0) { renderSystemToast("خطأ: قيمة سالبة", "danger"); return; }
                                            await dbHub.ref(`daily_stats/${date}/${br}`).set(val);
                                            renderSystemToast("تم الحفظ", "success");
                                        }

                                        async function runComplaintTicketSequence() {
                                            const br = document.getElementById('f-branch-master-sel').value;
                                            const ord = document.getElementById('f-order-id-input').value.trim();
                                            const cust = document.getElementById('f-customer-name-input').value.trim();
    const type = document.getElementById('f-complaint-type-sel').value;
    const msg = document.getElementById('f-complaint-msg-input').value.trim();
                                            const selectedDate = document.getElementById('f-date-master').value;

                                            if(!ord || !cust || !msg) { Swal.fire('تنبيه', 'بيانات ناقصة', 'warning'); return; }

                                            const timeNow = new Date().toLocaleTimeString('ar-EG');

    const ticketData = {
        branch: br,
        order: ord,
        customer: cust,
        type: type,
        msg: msg,
        date: selectedDate,
        timeOnly: timeNow,
        status: 'active',
        stage: 'sent_to_dispatcher', // <--- دي اللي بتخليها تروح للديسبتشر أول واحد
        author: currentUserSession.name,
        logs: [{ time: timeNow, user: currentUserSession.name, action: "إنشاء بلاغ وتوجيهه للديسبتشر" }]
    };

                                            await dbHub.ref('operations').push(ticketData);
                                            triggerBranchBroadcast(br, ord, cust, type, msg, timeNow);
                                            closeSidebarControl();
                                            renderSystemToast("تم إرسال البلاغ وتنبيه الواتساب", "success");
                                        }

                                    async function triggerBranchBroadcast(br, ord, cust, type, msg, time) {
                                        // البيانات المستخرجة من الصورة الخاصة بك
                                        const instanceId = "instance157671";
                                        const token = "cpx85mx613v868fe";

                                        try {
                                            // جلب الأرقام المربوطة بهذا الفرع من قاعدة البيانات
                                            const snap = await dbHub.ref(`settings/whatsapp_phones/${br}`).once('value');
                                            const phonesData = snap.val();

                                            if (!phonesData) {
                                                console.warn("⚠️ لا توجد أرقام مسجلة للفرع: " + br);
                                                return;
                                            }

                                            const pList = Object.values(phonesData);

                                            // نص الرسالة الاحترافي
                                            const text = `🚨 *بلاغ CMS جديد* 🚨\n\n` +
                                                         `📍 *الفرع:* ${br}\n` +
                                                         `🔢 *الطلب:* ${ord}\n` +
                                                         `👤 *العميل:* ${cust}\n` +
                                                         `🏷️ *النوع:* ${type}\n` +
                                                         `📝 *التفاصيل:* ${msg}\n` +
                                                         `⏰ *الوقت:* ${time}\n\n` +
                                                         `👷 *الموظف:* ${currentUserSession.name}`;

                                            pList.forEach(phone => {
                                                // تنظيف الرقم وتجهيزه للصيغة الدولية (مصر +20)
                                                let cleanPhone = phone.toString().replace(/\D/g, '');
                                                if (cleanPhone.startsWith('01')) {
                                                    cleanPhone = '20' + cleanPhone.substring(1);
                                                } else if (!cleanPhone.startsWith('20')) {
                                                    cleanPhone = '20' + cleanPhone;
                                                }

                                                // إرسال الطلب لـ UltraMsg
                                                fetch(`https://api.ultramsg.com/${instanceId}/messages/chat`, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                    body: new URLSearchParams({
                                                        'token': token,
                                                        'to': cleanPhone,
                                                        'body': text
                                                    })
                                                }).then(res => res.json()).then(data => {
                                                    console.log("✅ تم إرسال الرسالة إلى: " + cleanPhone, data);
                                                }).catch(err => console.error("❌ خطأ في إرسال واتساب:", err));
                                            });

                                        } catch (error) {
                                            console.error("WhatsApp Broadcast Error:", error);
                                        }
                                    }

                                        function renderLiveBroadcastMatrix() {
                                            const box = document.getElementById('render-live-feed-matrix');
                                            if (!box) return;
                                            box.innerHTML = "";

                                            const userBranch = currentUserSession.branch;
                                            const isSuper = (currentUserSession.role === 'SUPER');

                                            Object.keys(complaintsCache).reverse().forEach(id => {
                                                const selectedFilter = document.getElementById('global-branch-filter').value;
                                                const op = complaintsCache[id];

                                                // لو الشكوى منتهية (Done) متظهرش هنا
                                                if(op.status === 'done') return;

                                                // فلترة الفروع: السوبر يشوف الكل، والموظف يشوف فرعه فقط
                                                let canSee = false;
                                                if (isSuper || userBranch === 'ALL') {
                                                    if (selectedFilter === 'ALL' || selectedFilter === 'SHOW_ALL' || op.branch === selectedFilter) {
                                                        canSee = true;
                                                    }
                                                } else {
                                                    if (op.branch === userBranch) {
                                                        canSee = true;
                                                    }
                                                }

                                                // لو ليه حق يشوفها، نعرضها بغض النظر عن هي في أنهي مرحلة
                                                if (canSee) {
                                                    box.innerHTML += generateTicketMarkup(id, op, true, {});
                                                }
                                            });
                                        }

                                        function runArchiveRefreshSequence() {
                                            const box = document.getElementById('render-archive-grid-hub'); if(!box) return; box.innerHTML = "";
                                            const from = document.getElementById('archive-date-from').value;
                                            const to = document.getElementById('archive-date-to').value;
                                            const selectedBranch = document.getElementById('global-branch-filter').value;
                                            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';
                                            Object.keys(complaintsCache).reverse().forEach(id => {
                                                const op = complaintsCache[id];
                                                if(op.status !== 'done') return;
                                                if(!canSeeAll && op.branch !== currentUserSession.branch) return;
                                                if(op.date < from || op.date > to) return;
                                                // شرط الفلترة بالفرع المختار
                                                if(selectedBranch !== 'ALL' && op.branch !== selectedBranch) return;
                                                box.innerHTML += generateTicketMarkup(id, op, false, p);
                                            });
                                        }

                                            // === UPDATED TICKET MARKUP FOR HOVER REVEAL ===
        function generateTicketMarkup(id, op, isInteractive, p) {
            let btns = generateDynamicButtons(id, op);

                                            // 3. عرض الرد (لو موجود)
                                            let verdictDisplay = "";
                                            if (op.branch_manager_verdict) {
                                                let color = op.branch_manager_verdict.includes('ناقص') ? '#ef4444' : '#10b981';
                                                verdictDisplay = `
                                                    <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; border-right:5px solid ${color}; margin: 10px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                                                        <b style="color:${color}; font-size:1rem;">📢 الرد الحالي:</b>
                                                        <div style="margin-top:5px; color:#fff;">${op.branch_manager_verdict}</div>
                                                    </div>`;
                                            }

                                            const logs = op.logs ? op.logs.map(l => `<div style="font-size:0.8rem; color:#8b949e; margin-bottom:3px;">• <b>${l.user}</b>: ${l.action}</div>`).join('') : '';

                                            return `
                                                <div class="massive-glass-card ticket-visual-unit" onclick="this.classList.toggle('is-fixed')" style="border-right: 8px solid ${op.branch_manager_verdict ? '#10b981' : '#f59e0b'}">
                                                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                                        <div>
                                                            <b style="color:var(--gold-master); font-size:1.1rem;">📍 ${op.branch}</b>
                                                            <div style="font-size:0.75rem; color:#8b949e;">${op.date} ${op.timeOnly}</div>
                                                        </div>
                                                        <div style="text-align:left;">
                                                            <span style="color:var(--gold-master); font-size:0.8rem;">رقم الطلب</span>
                                                            <div class="order-number-badge">#${op.order}</div>
                                                        </div>
                                                    </div>

                                                    <div class="ticket-hidden-details">
                                                        <div style="margin-bottom:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">
                                                            <div>👤 العميل: ${op.customer} | 🏷️ النوع: ${op.type}</div>
                                                            <div style="color:var(--gold-master); font-size:0.85rem; font-weight:bold; margin-top:5px;">
                                                                المرحلة: ${stageNamesAr[op.stage] || op.stage}
                                                            </div>
                                                        </div>

                                                        ${verdictDisplay}

                                                        <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:10px; font-size:0.95rem; border-right:3px solid var(--gold-master); color:#e2e8f0;">
                                                            <b style="color:var(--gold-master);">📝 التفاصيل:</b> ${op.msg}
                                                        </div>

                                                        <div style="max-height:120px; overflow-y:auto; margin-bottom:15px; border-top:1px solid #333; padding-top:10px; background:rgba(0,0,0,0.1); padding:8px; border-radius:5px;">
                                                            <b style="font-size:0.75rem; color:var(--gold-master); display:block; margin-bottom:5px;">📜 سجل التحركات:</b>
                                                            ${logs}
                                                        </div>

                                                        <div style="display:flex; flex-direction:column; gap:8px;">
                                                            ${btns}
                                                        </div>
                                                    </div>
                                                </div>`;
                                        }

                                        async function executeAdvancedAnalyticsSequence() {
                                            const from = document.getElementById('reports-date-from').value;
                                            const to = document.getElementById('reports-date-to').value;
                                            if (!from || !to) return;

                                            // --- العزل التام للفروع ---
                                            let branchesToProcess = (currentUserSession.role === 'SUPER' || currentUserSession.branch === 'ALL') 
                                                                    ? branchListCache 
                                                                    : [currentUserSession.branch];

                                            const dSnap = await dbHub.ref('daily_stats').get();
                                            const allOrders = dSnap.val() || {};
                                            const ops = Object.values(complaintsCache).filter(o => 
                                                o.date >= from && o.date <= to && branchesToProcess.includes(o.branch)
                                            );

                                            const types = ["تأخير", "سوء خدمه", "ناقص", "سوء تعبئه", "خطأ فى الطلب", "خطأ فى الباقى", "جوده", "جسم غريب", "سوء سلوك", "مندوب", "طلب بارد", "رسبي", "تأخير شكوي", "تواصل من الفرع", "سوشيال"];

                                            // بناء الهيدر مع العمود الجديد
                                            let table1Html = `<table class="premium-matrix">
                                                <thead>
                                                    <tr>
                                                        <th>المطعم</th>
                                                        ${types.map(t => `<th>${t}</th>`).join('')}
                                                        <th class="col-total-blue">اجمالي TA</th>
                                                        <th class="col-total-blue" style="background:#1e3a8a !important;">الاجمالي Din In</th>
                                                        <th class="col-total-blue">الاجمالي HD</th>
                                                        <th class="col-total-blue">اجمالي المطعم</th>
                                                    </tr>
                                                </thead><tbody>`;

                                            let grandTotals = Array(types.length + 4).fill(0); // زيادة المصفوفة لـ 4 أعمدة إجمالية
                                            let branchStats = [];

                                            branchesToProcess.forEach(br => {
                                                let brOps = ops.filter(o => o.branch === br);
                                                let counts = types.map(t => brOps.filter(o => o.type === t).length);

                                                // حسابات الإجماليات
                                                let taTotal = counts[13] + counts[14]; // تواصل من الفرع + سوشيال
                                                let dinInTotal = 0; // يمكنك وضع منطق هنا إذا كان هناك نوع شكوى محدد للـ Din in
                                                let restaurantTotal = brOps.length;
                                                let hdTotal = restaurantTotal - taTotal - dinInTotal;

                                                table1Html += `<tr>
                                                    <td style="background:#1e293b; color:#fbbf24; font-weight:bold;">${br}</td>
                                                    ${counts.map(c => `<td>${c}</td>`).join('')}
                                                    <td class="col-subtotal-light">${taTotal}</td>
                                                    <td class="col-subtotal-light" style="color:#10b981;">${dinInTotal}</td>
                                                    <td class="col-subtotal-light">${hdTotal}</td>
                                                    <td style="background:rgba(255,255,255,0.05)">${restaurantTotal}</td>
                                                </tr>`;

                                                // تجميع الإجماليات النهائية للسفل
                                                counts.forEach((c, i) => grandTotals[i] += c);
                                                grandTotals[types.length] += taTotal;
                                                grandTotals[types.length + 1] += dinInTotal;
                                                grandTotals[types.length + 2] += hdTotal;
                                                grandTotals[types.length + 3] += restaurantTotal;

                                                // للجدول الصغير
                                                let brOrders = 0;
                                                Object.keys(allOrders).forEach(d => { if(d >= from && d <= to) brOrders += parseInt(allOrders[d][br] || 0); });
                                                branchStats.push({ name: br, orders: brOrders, comps: restaurantTotal });
                                            });

                                            table1Html += `<tr style="background:#1e40af; color:white; font-weight:900;">
                                                <td>الاجمالي</td>${grandTotals.map(gt => `<td>${gt}</td>`).join('')}
                                            </tr></tbody></table>`;
                                            
                                            document.getElementById('matrix-report-table-container').innerHTML = table1Html;

                                            // تحديث باقي الرسوم والـ KPIs كما هي
                                            renderPremiumBarChart(branchStats);
                                            renderComplaintTypesPieChart(ops);
                                            updateKPIs(0, grandTotals[grandTotals.length-1], 0); // تحديث الإجمالي الكلي فقط
                                            
                                            // (ملاحظة: تأكد من استدعاء الجدول الصغير أيضاً إذا كنت تستخدمه)
                                            renderSmallStatsTable(branchStats); 
                                        }

                                        function renderPremiumBarChart(stats) {
                                            const ctx = document.getElementById('master-reports-canvas').getContext('2d');
                                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                            gradient.addColorStop(0, '#fbbf24');
                                            gradient.addColorStop(1, 'rgba(251, 191, 36, 0.1)');

                                            if(window.myChart) window.myChart.destroy();
                                            window.myChart = new Chart(ctx, {
                                                type: 'bar',
                                                data: {
                                                    labels: stats.map(s => s.name),
                                                    datasets: [{
                                                        label: 'نسبة الشكاوى %',
                                                        data: stats.map(s => s.orders > 0 ? ((s.comps/s.orders)*100).toFixed(2) : 0),
                                                        backgroundColor: gradient,
                                                        borderColor: '#fbbf24',
                                                        borderWidth: 2,
                                                        borderRadius: 10
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    maintainAspectRatio: false,
                                                    plugins: {
                                                        legend: { display: false },
                                                        datalabels: { color: '#fff', anchor: 'end', align: 'top', formatter: (v) => v + '%' }
                                                    },
                                                    scales: {
                                                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                                                        x: { ticks: { color: '#fff' } }
                                                    }
                                                },
                                                plugins: [ChartDataLabels]
                                            });
                                        }

                                        function renderComplaintTypesPieChart(ops) {
                                            const ctx = document.getElementById('complaint-types-pie-canvas').getContext('2d');
                                            const typeCounts = {};
                                            ops.forEach(o => { typeCounts[o.type || 'أخرى'] = (typeCounts[o.type || 'أخرى'] || 0) + 1; });

                                            if(window.pieChart) window.pieChart.destroy();
                                            window.pieChart = new Chart(ctx, {
                                                type: 'pie',
                                                data: {
                                                    labels: Object.keys(typeCounts),
                                                    datasets: [{
                                                        data: Object.values(typeCounts),
                                                        backgroundColor: ['#f59e0b', '#ef4444', '#10b981', '#1d4ed8', '#8b5cf6', '#f97316', '#06b6d4'],
                                                        borderWidth: 2,
                                                        borderColor: '#fff'
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    maintainAspectRatio: false,
                                                    plugins: {
                                                        legend: { position: 'bottom', labels: { color: '#fff' } },
                                                        datalabels: {
                                                            color: '#fff',
                                                            formatter: (value, context) => {
                                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                                const percentage = ((value / total) * 100).toFixed(1);
                                                                return percentage + '%';
                                                            }
                                                        }
                                                    }
                                                },
                                                plugins: [ChartDataLabels]
                                            });
                                        }

                                        function updateKPIs(totalOrders, totalComps, finalPerc) {
                                            document.getElementById('kpi-ops').innerText = totalOrders;
                                            document.getElementById('kpi-comps').innerText = totalComps;
                                            document.getElementById('kpi-rate').innerText = finalPerc + '%';
                                        }

                                        function renderPremiumChart(stats) {
                                            const ctx = document.getElementById('master-reports-canvas').getContext('2d');
                                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                            gradient.addColorStop(0, 'rgba(245, 158, 11, 0.8)');
                                            gradient.addColorStop(1, 'rgba(245, 158, 11, 0.05)');

                                            if(window.myChart) window.myChart.destroy();
                                            window.myChart = new Chart(ctx, {
                                                type: 'bar',
                                                data: {
                                                    labels: stats.map(s => s.name),
                                                    datasets: [{
                                                        label: 'معدل الشكاوى %',
                                                        data: stats.map(s => s.orders > 0 ? ((s.comps/s.orders)*100).toFixed(2) : 0),
                                                        backgroundColor: gradient,
                                                        borderColor: '#f59e0b',
                                                        borderWidth: 2,
                                                        borderRadius: 10,
                                                        barPercentage: 0.5
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    maintainAspectRatio: false,
                                                    plugins: {
                                                        legend: { display: false },
                                                        datalabels: { color: '#fff', anchor: 'end', align: 'top', formatter: (v) => v + '%' }
                                                    },
                                                    scales: {
                                                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                                                        x: { grid: { display: false }, ticks: { color: '#f8fafc' } }
                                                    }
                                                },
                                                plugins: [ChartDataLabels]
                                            });
                                        }

                                        function renderSummaryPercentageTable(allOrders, ops, from, to) {
                                            let html = `
                                                <table class="report-blue-table">
                                                <thead>
                                                    <tr>
                                                        <th>المطعم</th>
                                                        <th>العمليات</th>
                                                        <th>الشكاوى</th>
                                                        <th>النسبة</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;

                                            let totalOrd = 0, totalComp = 0;
                                            branchListCache.forEach(br => {
                                                let brOrders = 0;
                                                Object.keys(allOrders).forEach(d => { if(d >= from && d <= to) brOrders += parseInt(allOrders[d][br] || 0); });
                                                let brComp = ops.filter(o => o.branch === br).length;
                                                let perc = brOrders > 0 ? ((brComp/brOrders)*100).toFixed(2) : 0;

                                                html += `<tr><td>${br}</td><td>${brOrders}</td><td>${brComp}</td><td style="background:#dbeafe">${perc}%</td></tr>`;
                                                totalOrd += brOrders; totalComp += brComp;
                                            });

                                            let totalPerc = totalOrd > 0 ? ((totalComp/totalOrd)*100).toFixed(2) : 0;
                                            html += `<tr style="background:#2563eb; color:white;"><td>الاجمالي</td><td>${totalOrd}</td><td>${totalComp}</td><td>${totalPerc}%</td></tr></tbody></table>`;
                                            document.getElementById('summary-percentage-table').innerHTML = html;
                                        }

                                        function renderAnalyticsChart(allOrders, ops, from, to) {
                                            const ctx = document.getElementById('master-reports-canvas').getContext('2d');
                                            const labels = branchListCache;
                                            const data = branchListCache.map(br => {
                                                let brOrders = 0;
                                                Object.keys(allOrders).forEach(d => { if(d >= from && d <= to) brOrders += parseInt(allOrders[d][br] || 0); });
                                                let brComp = ops.filter(o => o.branch === br).length;
                                                return brOrders > 0 ? ((brComp/brOrders)*100).toFixed(2) : 0;
                                            });

                                            if(analyticsChartInstance) analyticsChartInstance.destroy();
                                            analyticsChartInstance = new Chart(ctx, {
                                                type: 'bar',
                                                data: {
                                                    labels: labels,
                                                    datasets: [{
                                                        label: 'معدل الشكاوى %',
                                                        data: data,
                                                        backgroundColor: '#2563eb', // اللون الأزرق
                                                        borderColor: '#1e40af',
                                                        borderWidth: 1
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    maintainAspectRatio: false,
                                                    plugins: {
                                                        datalabels: {
                                                            anchor: 'end',
                                                            align: 'top',
                                                            formatter: (v) => v + '%',
                                                            color: '#1e293b',
                                                            font: { weight: 'bold' }
                                                        }
                                                    },
                                                    scales: {
                                                        y: { beginAtZero: true, grid: { color: '#e2e8f0' } }
                                                    }
                                                },
                                                plugins: [ChartDataLabels]
                                            });
                                        }

                                        function renderAdvanced3DChart(allOrders, ops, from, to) {
                                            const ctx = document.getElementById('master-reports-canvas').getContext('2d');

                                            // إنشاء تدرج لوني يعطي إيحاء بالعمق
                                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                            gradient.addColorStop(0, 'rgba(245, 158, 11, 1)'); // ذهبي ساطع
                                            gradient.addColorStop(1, 'rgba(245, 158, 11, 0.1)'); // شفاف

                                            const labels = branchListCache;
                                            const data = branchListCache.map(br => {
                                                let brComp = ops.filter(o => o.branch === br).length;
                                                return brComp;
                                            });

                                            if(analyticsChartInstance) analyticsChartInstance.destroy();
                                            analyticsChartInstance = new Chart(ctx, {
                                                type: 'bar',
                                                data: {
                                                    labels: labels,
                                                    datasets: [{
                                                        label: 'حجم البلاغات',
                                                        data: data,
                                                        backgroundColor: gradient,
                                                        borderColor: '#f59e0b',
                                                        borderWidth: 2,
                                                        borderRadius: 15, // حواف دائرية تعطي شكل 3D Cylinder
                                                        borderSkipped: false,
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    maintainAspectRatio: false,
                                                    plugins: {
                                                        legend: { display: false },
                                                        // إضافة فكرة الأنيميشن عند التحميل
                                                        animation: { duration: 2000, easing: 'easeOutBounce' }
                                                    },
                                                    scales: {
                                                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b949e' } },
                                                        x: { grid: { display: false }, ticks: { color: '#f0f6fc' } }
                                                    }
                                                }
                                            });
                                        }

                                        function updateAnalyticsCharts(ops, selectedBranch, allDays, from, to) {
                                            // 6. إعداد بيانات الرسم البياني (نسبة الخطأ لكل فرع على حدة)
                                            const labels = [];
                                            const branchRates = [];

                                            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

                                            branchListCache.forEach(br => {
                                                if(!canSeeAll && br !== currentUserSession.branch) return;

                                                labels.push(br);
                                                const brComplaints = ops.filter(o => o.branch === br).length;
                                                let brOrders = 0;

                                                Object.keys(allDays).forEach(day => {
                                                    if(day >= from && day <= to && allDays[day][br]) {
                                                        brOrders += parseInt(allDays[day][br]);
                                                    }
                                                });

                                                // حساب نسبة الخطأ لكل فرع
                                                let rate = brOrders > 0 ? ((brComplaints / brOrders) * 100).toFixed(2) : 0;
                                                branchRates.push(rate);
                                            });

                                            // 7. تحديث المخطط البياني (الأعمدة)
                                            if(analyticsChartInstance) analyticsChartInstance.destroy();
                                            analyticsChartInstance = new Chart(document.getElementById('master-reports-canvas').getContext('2d'), {
                                                type: 'bar',
                                                plugins: [ChartDataLabels],
                                                data: {
                                                    labels: labels,
                                                    datasets: [{
                                                        label: 'معدل الخطأ % (شكاوى/أوردرات)',
                                                        data: branchRates,
                                                        backgroundColor: '#f59e0b',
                                                        borderRadius: 8
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    maintainAspectRatio: false,
                                                    scales: {
                                                        y: { beginAtZero: true, ticks: { color: '#fff' }, title: {display:true, text:'النسبة المئوية %', color:'#fff'} },
                                                        x: { ticks: { color: '#fff' } }
                                                    },
                                                    plugins: {
                                                        legend: { labels: { color: '#fff' } },
                                                        datalabels: {
                                                            color: '#fff',
                                                            anchor: 'end',
                                                            align: 'top',
                                                            formatter: (v) => v + '%'
                                                        }
                                                    }
                                                }
                                            });

                                            // 8. تحديث مخطط الأنواع (الدائرة)
                                            const typeCounts = {};
                                            ops.forEach(o => { typeCounts[o.type || 'أخرى'] = (typeCounts[o.type || 'أخرى'] || 0) + 1; });

                                            if(analyticsTypeChartInstance) analyticsTypeChartInstance.destroy();
                                            analyticsTypeChartInstance = new Chart(document.getElementById('master-types-canvas').getContext('2d'), {
                                                type: 'doughnut',
                                                plugins: [ChartDataLabels],
                                                data: {
                                                    labels: Object.keys(typeCounts),
                                                    datasets: [{
                                                        data: Object.values(typeCounts),
                                                        backgroundColor: ['#f59e0b','#ef4444','#10b981','#1d4ed8','#8b5cf6'],
                                                        borderWidth: 0
                                                    }]
                                                },
                                                options: {
                                                    plugins: {
                                                        legend: { position: 'bottom', labels: { color: '#fff' } },
                                                        datalabels: { color: '#000', backgroundColor: '#fff', borderRadius: 4, font: {weight:'bold'} }
                                                    }
                                                }
                                            });
                                        }

                                        async function exportReportsToExcel() {
                                            const fromDate = document.getElementById('reports-date-from').value;
                                            const toDate = document.getElementById('reports-date-to').value;

                                            if (!fromDate || !toDate) {
                                                return Swal.fire('تنبيه', 'يرجى تحديد التاريخ أولاً وتوليد التقرير', 'warning');
                                            }

                                            renderSystemToast("جاري إنشاء التقرير الاحترافي شامل الرسم البياني...", "success");

                                            // 1. إنشاء ملف الإكسيل وإعداد اتجاه الصفحة (يمين لليسار)
                                            const workbook = new ExcelJS.Workbook();
                                            const worksheet = workbook.addWorksheet('CMS Report', {
                                                views: [{ rightToLeft: true }]
                                            });

                                            // 2. تجهيز البيانات
                                            const dSnap = await dbHub.ref('daily_stats').get();
                                            const allOrders = dSnap.val() || {};
                                            const ops = Object.values(complaintsCache).filter(o => o.date >= fromDate && o.date <= toDate);

                                            const complaintTypes = ["تأخير", "سوء خدمه", "ناقص", "سوء تعبئه", "خطأ فى الطلب", "خطأ فى الباقى", "جوده", "جسم غريب", "سوء سلوك", "مندوب", "طلب بارد", "رسبي", "تأخير شكوي", "تواصل من الفرع", "سوشيال"];

                                            // 3. بناء الجدول الكبير (الأزرق)
                                            const headerRow1 = ["المطعم", ...complaintTypes, "اجمالي TA", "الاجمالي Din In", "الاجمالي HD", "اجمالي المطعم"];
                                            const headerRow = worksheet.addRow(headerRow1);

                                            // تنسيق هيدر الجدول (لون أزرق غامق وخط أبيض)
                                            headerRow.eachCell((cell) => {
                                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1E4B8B' } };
                                                cell.font = { color: { argb: 'FFFFFF' }, bold: true, size: 10 };
                                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                                                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                                            });

                                            let grandTotals = Array(headerRow1.length).fill(0);

                                            branchListCache.forEach(br => {
                                                const brOps = ops.filter(o => o.branch === br);
                                                const getC = (t) => brOps.filter(o => o.type === t).length;

                                                const taTotal = getC("سوشيال") + getC("تواصل من الفرع");
                                                const dinInTotal = 0; // يمكنك وضع منطق هنا إذا كان هناك نوع شكوى محدد للـ Din in
                                                const restaurantTotal = brOps.length;
                                                const hdTotal = restaurantTotal - taTotal - dinInTotal;

                                                const rowData = [br];
                                                complaintTypes.forEach(t => rowData.push(getC(t)));
                                                rowData.push(taTotal, dinInTotal, hdTotal, restaurantTotal);

                                                const row = worksheet.addRow(rowData);
                                                row.eachCell(cell => {
                                                    cell.alignment = { horizontal: 'center' };
                                                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                                                });

                                                for (let i = 1; i < rowData.length; i++) grandTotals[i] += rowData[i];
                                            });

                                            // سطر الإجمالي (الاجمالي) بنفس تنسيق الصورة
                                            const footerRow1 = worksheet.addRow(["الاجمالي", ...grandTotals.slice(1)]);
                                            footerRow1.eachCell((cell) => {
                                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D9E1F2' } }; // أزرق فاتح
                                                cell.font = { bold: true };
                                                cell.alignment = { horizontal: 'center' };
                                                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                                            });

                                            // 4. إضافة الرسم البياني (صورة)
                                            const canvas = document.getElementById('master-reports-canvas');
                                            if (canvas) {
                                                const chartImage = canvas.toDataURL('image/png');
                                                const imageId = workbook.addImage({
                                                    base64: chartImage,
                                                    extension: 'png',
                                                });
                                                worksheet.addImage(imageId, {
                                                    tl: { col: 1, row: worksheet.rowCount + 2 },
                                                    ext: { width: 650, height: 350 }
                                                });
                                            }

                                            // 5. إضافة الجدول الصغير (بجانب الرسم البياني أو تحته)
                                            const startRowTable2 = worksheet.rowCount + 20; // ترك مساحة للرسم البياني

                                            const table2Title = worksheet.addRow([]);
                                            table2Title.getCell(1).value = "نسبة شكاوى خدمة التوصيل للفروع";
                                            worksheet.mergeCells(startRowTable2 + 1, 1, startRowTable2 + 1, 4);
                                            table2Title.getCell(1).font = { bold: true, size: 12 };
                                            table2Title.getCell(1).alignment = { horizontal: 'center' };

                                            const headerRow2 = worksheet.addRow(["المطعم", "العمليات", "الشكاوى", "النسبة"]);
                                            headerRow2.eachCell(cell => {
                                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1E4B8B' } };
                                                cell.font = { color: { argb: 'FFFFFF' }, bold: true };
                                                cell.alignment = { horizontal: 'center' };
                                            });

                                            let totalOps = 0, totalComps = 0;
                                            branchListCache.forEach(br => {
                                                let brOrders = 0;
                                                Object.keys(allOrders).forEach(d => { if (d >= fromDate && d <= toDate) brOrders += parseInt(allOrders[d][br] || 0); });
                                                const brCompCount = ops.filter(o => o.branch === br).length;
                                                const perc = brOrders > 0 ? ((brCompCount / brOrders) * 100).toFixed(2) + "%" : "0.00%";

                                                const row = worksheet.addRow([br, brOrders, brCompCount, perc]);
                                                row.eachCell(c => c.alignment = { horizontal: 'center' });
                                                totalOps += brOrders; totalComps += brCompCount;
                                            });

                                            const finalPerc = totalOps > 0 ? ((totalComps / totalOps) * 100).toFixed(2) + "%" : "0.00%";
                                            const footer2 = worksheet.addRow(["الاجمالي", totalOps, totalComps, finalPerc]);
                                            footer2.eachCell(c => { c.font = { bold: true }; c.alignment = { horizontal: 'center' }; });

                                            // ضبط عرض الأعمدة تلقائياً
                                            worksheet.columns.forEach(column => { column.width = 14; });

                                            // 6. تحميل الملف النهائي
                                            const buffer = await workbook.xlsx.writeBuffer();
                                            saveAs(new Blob([buffer]), `CMS_Full_Report_${fromDate}.xlsx`);
                                        }


                                        // Ticket Action Modals
                                        async function openGenericReplyModal(id, nextStage, actionText) {
                                            const { value: r } = await Swal.fire({
                                                title: 'رد المراجعة والاعتماد',
                                                input: 'textarea',
                                                inputPlaceholder: 'اكتب ملاحظاتك هنا...',
                                                showCancelButton: true,
                                                confirmButtonText: 'إرسال للمستوى التالي',
                                                confirmButtonColor: '#10b981'
                                            });

                                            if (r) {
                                                const op = complaintsCache[id];
                                                const newLog = {
                                                    time: new Date().toLocaleTimeString('ar-EG'),
                                                    user: currentUserSession.name + " (" + currentUserSession.title + ")",
                                                    action: actionText + ": " + r
                                                };

                                                await dbHub.ref('operations/' + id).update({
                                                    stage: nextStage,
                                                    logs: [...(op.logs || []), newLog]
                                                });
                                                renderSystemToast("تم تحويل البلاغ بنجاح", "success");
                                            }
                                        }

                                        // دالة تحديث المرحلة بدون رد (توجيه فقط)
                                        async function updateTicketStage(id, nextStage, actionText) {
                                            const op = complaintsCache[id];

                                            // هنا نقوم بدمج الاسم مع الوظيفة (الرول)
                                            const userSignature = `${currentUserSession.name} (${currentUserSession.title})`;
                                            const newLog = {
                                                time: new Date().toLocaleTimeString('ar-EG'),
                                                user: userSignature, // سيظهر مثلاً: أحمد (مدير التشغيل)
                                                action: actionText
                                            };

                                            await dbHub.ref('operations/' + id).update({
                                                stage: nextStage,
                                                logs: [...(op.logs || []), newLog]
                                            });
                                            renderSystemToast("تم التحديث بواسطة " + currentUserSession.name, "success");
                                        }

                                        async function openBranchReplyModalHub(id) {
                                            const {value:r} = await Swal.fire({ title:'رد الفرع', html:`<select id="s1" class="swal2-input"><option value="كامل">✅ سليم</option><option value="ناقص">❌ ناقص فعلاً</option></select><textarea id="s2" class="swal2-input" placeholder="التفاصيل"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                                            if(r) {
                                                const op = complaintsCache[id], log={time:new Date().toLocaleTimeString('ar-EG'),user:`${currentUserSession.name} (${currentUserSession.title})`,action:r[0]==='ناقص'?'اعتراف بالنقص':'الطلب سليم'};
                                                await dbHub.ref('operations/'+id).update({ stage:'replied', branch_verdict:r[0], dispatcher_name:currentUserSession.name, logs:[...(op.logs||[]),log], status:r[0]==='ناقص'?'done':'active' });
                                                renderSystemToast("تم الرد", "success");
                                            }
                                        }
                                        async function finalizeTicketAndArchive(id) {
                                            const op = complaintsCache[id];
                                            const userSignature = `${currentUserSession.name} (${currentUserSession.title})`;

                                            const newLog = {
                                                time: new Date().toLocaleTimeString('ar-EG'),
                                                user: userSignature,
                                                action: "تم التوصيل النهائي والأرشفة"
                                            };

                                            await dbHub.ref('operations/' + id).update({
                                                status: 'done',
                                                stage: 'delivered',
                                                logs: [...(op.logs || []), newLog]
                                            });

                                            renderSystemToast("تمت الأرشفة بنجاح", "success");
                                        }
                                        async function sendToBranchManagerFromCallCenter(id) { await dbHub.ref('operations/'+id).update({stage:'sent_to_branch_manager', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:`${currentUserSession.name} (${currentUserSession.title})`,action:"إرسال لمدير الفرع"}]}); renderSystemToast("تم التحويل","success"); }
                                        async function sendToRegionalManager(id) { await dbHub.ref('operations/'+id).update({stage:'sent_to_regional_manager', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:`${currentUserSession.name} (${currentUserSession.title})`,action:"إرسال لمدير المنطقة"}]}); renderSystemToast("تم التحويل","success"); }
                                        async function forceChangeStage(id) {
                                            const { value: stage } = await Swal.fire({
                                                title: 'نقل البلاغ لمرحلة محددة',
                                                input: 'select',
                                                inputOptions: stageRankNames,
                                                inputPlaceholder: 'اختر المرحلة',
                                                showCancelButton: true
                                            });
                                            if (stage) {
                                                await dbHub.ref('operations/' + id).update({ stage: stage });
                                                renderSystemToast("تم تغيير المرحلة يدوياً", "success");
                                            }
                                        }
                                        async function deleteTicketRecord(id) { if((await Swal.fire({title:'حذف نهائي؟',icon:'warning',showCancelButton:true})).isConfirmed) { await dbHub.ref('operations/'+id).remove(); renderSystemToast("تم الحذف","success"); } }
                                        async function openBranchManagerReplyModalHub(id) {
                                            const { value: r } = await Swal.fire({
                                                title: 'رد المراجعة والتحقق',
                                                html: `
                                                    <select id="s1" class="swal2-input">
                                                        <option value="ناقص فعلاً">❌ نقص فعلاً (سيتم التعويض)</option>
                                                        <option value="سليم">✅ الطلب خرج سليماً</option>
                                                    </select>
                                                    <textarea id="s2" class="swal2-input" placeholder="اكتب ملاحظات إضافية..."></textarea>
                                                `,
                                                confirmButtonText: 'تأكيد الرد',
                                                showCancelButton: true,
                                                preConfirm: () => [
                                                    document.getElementById('s1').value,
                                                    document.getElementById('s2').value
                                                ]
                                            });

                                            if (r) {
                                                const op = complaintsCache[id];
                                                const verdict = r[0];
                                                const notes = r[1];

                                                // إذا كان "ناقص فعلاً"، نغير المرحلة إلى جاهز للتوصيل (تم التعويض)
                                                // أما إذا كان "سليم"، يمكن إرساله للكول سنتر للمراجعة
                                                const nextStage = (verdict === 'ناقص فعلاً') ? 'ready_for_delivery' : 'sent_back_to_call_center';

                                                const userSignature = `${currentUserSession.name} (${currentUserSession.title})`;
                                                const newLog = {
                                                    time: new Date().toLocaleTimeString('ar-EG'),
                                                    user: userSignature,
                                                    action: `النتيجة: ${verdict} - الملاحظات: ${notes}`
                                                };

                                                await dbHub.ref('operations/' + id).update({
                                                    stage: nextStage,
                                                    branch_manager_verdict: verdict,
                                                    logs: [...(op.logs || []), newLog]
                                                });

                                                renderSystemToast("تم تحديث حالة البلاغ", "success");
                                            }
                                        }
                                        async function openRegionalManagerReplyModalHub(id) {
                                            const {value:r} = await Swal.fire({ title:'رد المنطقة', html:`<select id="s1" class="swal2-input"><option value="كامل">✅ سليم</option><option value="ناقص">❌ ناقص فعلاً</option></select><textarea id="s2" class="swal2-input"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                                            if(r) { await dbHub.ref('operations/'+id).update({stage:'sent_to_regional_manager', regional_manager_verdict:r[0], regional_manager_name:currentUserSession.name, logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:`${currentUserSession.name} (${currentUserSession.title})`,action:'رد المنطقة: '+r[0]}]}); renderSystemToast("تم الرد","success"); }
                                        }

                                        // وظيفة حذف موظف نهائياً (من الإدارة ومن الرادار)
                                        async function deleteUserEntirely(uid, userName) {
                                            // 1. التأكد أن المستخدم الحالي "سوبر أدمن" ليكون له صلاحية الحذف
                                            if (currentUserSession.role !== 'SUPER') {
                                                renderSystemToast("ليس لديك صلاحية حذف المستخدمين", "danger");
                                                return;
                                            }

                                            // 2. رسالة تأكيد قبل الحذف
                                            const result = await Swal.fire({
                                                title: `حذف المستخدم: ${userName}؟`,
                                                text: "سيتم حذف هذا الموظف نهائياً من المنظومة.",
                                                icon: 'warning',
                                                showCancelButton: true,
                                                confirmButtonColor: '#ef4444',
                                                confirmButtonText: 'نعم، حذف نهائي',
                                                cancelButtonText: 'إلغاء'
                                            });

                                            if (result.isConfirmed) {
                                                try {
                                                    // 3. الحذف من قاعدة البيانات (Firebase)
                                                    await dbHub.ref('users/' + uid).remove();
                                                    await dbHub.ref('users_presence/' + uid).remove();

                                                    // 4. *** الخطوة الأهم ***: الحذف من ذاكرة المتصفح (LocalStorage)
                                                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                                                    if (users[uid]) {
                                                        delete users[uid]; // إزالة الموظف من الذاكرة
                                                        localStorage.setItem('users', JSON.stringify(users));
                                                    }

                                                    // 5. تحديث القائمة فوراً في الشاشة
                                                    renderAdminUsersScrollBox();

                                                    renderSystemToast("تم حذف الموظف بنجاح", "success");
                                                } catch (error) {
                                                    console.error("خطأ أثناء الحذف:", error);
                                                    renderSystemToast("فشل الحذف من الخادم", "danger");
                                                }
                                            }
                                        }

                                        // حذف سطر واحد من السجل
                                        async function deleteSpecificLog(logId) {
                                            if (currentUserSession.role !== 'SUPER') return;
                                            await dbHub.ref('access_logs/' + logId).remove();
                                            renderSystemToast("تم حذف السجل", "success");
                                        }

                                        // مسح السجل بالكامل (للسوبر فقط)
                                        async function clearAllSystemLogs() {
                                            if (currentUserSession.role !== 'SUPER') return;

                                            const result = await Swal.fire({
                                                title: 'مسح كل السجلات؟',
                                                text: "هذا الفعل سيمسح تاريخ الدخول والخروج بالكامل ولا يمكن التراجع عنه!",
                                                icon: 'danger',
                                                showCancelButton: true,
                                                confirmButtonColor: '#ef4444',
                                                confirmButtonText: 'نعم، امسح الكل'
                                            });

                                            if (result.isConfirmed) {
                                                await dbHub.ref('access_logs').remove();
                                                renderSystemToast("تم تصفير السجل بنجاح", "success");
                                            }
                                        }

                                        // دوال الرفع والخفض للشكاوى
                                        async function escalateComplaint(id) {
                                            const op = complaintsCache[id];
                                            const currentStage = op.stage || 'waiting_review';
                                            const nextStage = stageHierarchy[currentStage];
                                            const nextRankName = stageRankNames[nextStage] || "المستوى الأعلى";

                                            if (!nextStage) {
                                                renderSystemToast("هذا البلاغ في أعلى مستوى بالفعل", "danger");
                                                return;
                                            }

                                            // طلب سبب الرفع
                                            const { value: reason } = await Swal.fire({
                                                title: `رفع الشكوى إلى ${nextRankName}`,
                                                input: 'textarea',
                                                inputLabel: 'ما هو سبب رفع الشكوى للمستوى الأعلى؟',
                                                inputPlaceholder: 'اكتب التفاصيل هنا...',
                                                showCancelButton: true,
                                                confirmButtonText: 'تأكيد الرفع',
                                                cancelButtonText: 'إلغاء',
                                                confirmButtonColor: '#ff6b6b'
                                            });

                                            if (reason) {
                                                const userSignature = `${currentUserSession.name} (${currentUserSession.title})`;
                                                const newLog = {
                                                    time: new Date().toLocaleTimeString('ar-EG'),
                                                    user: userSignature,
                                                    action: `قام بالرفع إلى [${nextRankName}] - السبب: ${reason}`
                                                };

                                                await dbHub.ref('operations/' + id).update({
                                                    stage: nextStage,
                                                    logs: [...(op.logs || []), newLog]
                                                });

                                                renderSystemToast(`تم تحويل البلاغ إلى ${nextRankName}`, "success");
                                                // البلاغ سيختفي تلقائياً من عند المستخدم الحالي بسبب نظام الفلترة في الـ Render
                                            }
                                        }

                                        function deescalateComplaint(id) {
                                            const op = complaintsCache[id];
                                            const currentStage = op.stage || 'waiting_review';
                                            const prevStage = reverseStageHierarchy[currentStage];
                                            if (prevStage) {
                                                updateTicketStage(id, prevStage, 'خفض الشكوى للمستوى الأقل');
                                            } else {
                                                renderSystemToast("لا يمكن الخفض أكثر", "danger");
                                            }
                                        }

                                        // Admin Utilities
                                        function syncUiDropdownSelections() {
                                            // 1. تحضير كود HTML الخاص بالفروع
                                            const branchesHtml = branchListCache.map(b => `<option value="${b}">${b}</option>`).join('');

                                            // 2. تحضير كود HTML الخاص بالرتب (الموجودة في السيرفر)
                                            const customRanks = systemSettingsCache.custom_ranks ? Object.keys(systemSettingsCache.custom_ranks) : [];
                                            const ranksHtml = customRanks.map(r => `<option value="${r}">${r}</option>`).join('');

                                            // --- تحديث قوائم الفروع ---
                                            const branchSelectors = [
                                                'f-branch-master-sel',
                                                'adm-whatsapp-br-sel',
                                                'reg-user-branch-sel-core',
                                                'global-branch-filter',
                                                'log-filter-branch',
                                                'radar-branch-filter-select'
                                            ];

                                            branchSelectors.forEach(id => {
                                                const el = document.getElementById(id);
                                                if (el) {
                                                    const currentVal = el.value;
                                                    if (id === 'reg-user-branch-sel-core') {
                                                        el.innerHTML = `<option value="ALL">الإدارة العليا</option>` + branchesHtml;
                                                    } else if (id === 'global-branch-filter' || id === 'log-filter-branch' || id === 'radar-branch-filter-select') {
                                                        el.innerHTML = `<option value="ALL">-- عرض جميع الفروع --</option>` + branchesHtml;
                                                    } else {
                                                        el.innerHTML = branchesHtml;
                                                    }
                                                    if (currentVal) el.value = currentVal;
                                                }
                                            });

                                            // --- تحديث قوائم الرتب (الجزء اللي كان ناقص) ---
                                            const rankSelectors = [
                                                'adm-rank-matrix-sel',      // القائمة اللي في الصورة عندك (إدارة الصلاحيات)
                                                'reg-user-rank-sel-core'    // القائمة اللي في "تسجيل عضو جديد"
                                            ];

                                            rankSelectors.forEach(id => {
                                                const el = document.getElementById(id);
                                                if (el) {
                                                    const currentVal = el.value;
                                                    // بنضيف اختيار "اختر الرتبة" عشان متبقاش فاضية
                                                    el.innerHTML = `<option value="">-- اختر الرتبة --</option>` + ranksHtml;
                                                    if (currentVal) el.value = currentVal;
                                                }
                                            });
                                        }

                                        // 1. دالة تحديث قائمة الفروع في السجل (تأكد من استدعائها في syncUiDropdownSelections)
                                        function updateLogBranchDropdown() {
                                            const logBrSelect = document.getElementById('log-filter-branch');
                                            if(logBrSelect) {
                                                logBrSelect.innerHTML = '<option value="">كل الفروع</option><option value="ALL">الإدارة العليا</option>' +
                                                    branchListCache.map(b => `<option value="${b}">${b}</option>`).join('');
                                            }
                                        }
                                        // إضافة فرع جديد للسيرفر
                                        function addSystemBranchCore() {
                                            const n = document.getElementById('adm-branch-name-input').value.trim();
                                            if(n) {
                                                // إرسال الفرع لـ Firebase تحت node اسمها settings/branches
                                                const newBranchRef = dbHub.ref('settings/branches').push();
                                                newBranchRef.set(n).then(() => {
                                                    document.getElementById('adm-branch-name-input').value = "";
                                                    renderSystemToast("تم إضافة الفرع للسيرفر بنجاح", "success");
                                                });
                                            } else {
                                                renderSystemToast("اكتب اسم الفرع!", "danger");
                                            }
                                        }

                                        // عرض الفروع من السيرفر
                                        function renderAdminBranchScrollBox() {
                                            const b = document.getElementById('adm-branches-scroll-box');
                                            if(!b) return;
                                            b.innerHTML = "";

                                            // بنسحب من الكاش اللي جاي من Firebase
                                            if(systemSettingsCache.branches) {
                                                Object.keys(systemSettingsCache.branches).forEach(key => {
                                                    const branchName = systemSettingsCache.branches[key];
                                                    // عزل البيانات: مدير الفرع يرى فرعه فقط
                                                    if(currentUserSession.role !== 'SUPER' && currentUserSession.title === 'مدير فرع' && branchName !== currentUserSession.branch) return;
                                                    const canDelete = currentUserSession.role === 'SUPER';
                                                    b.innerHTML += `
                                                        <div class="admin-row-item">
                                                            <span>${branchName}</span>
                                                            ${canDelete ? `<i class="fas fa-trash" style="color:var(--danger-pulse);cursor:pointer;"
                                                            onclick="deleteBranchFromServer('${key}')"></i>` : ''}
                                                        </div>`;
                                                });
                                            }
                                        }

                                        // حذف فرع من السيرفر
                                        function deleteBranchFromServer(key) {
                                            Swal.fire({
                                                title: 'حذف الفرع؟',
                                                text: "سيتم حذفه من السيرفر نهائياً",
                                                icon: 'warning',
                                                showCancelButton: true,
                                                confirmButtonText: 'نعم، احذف'
                                            }).then((result) => {
                                                if (result.isConfirmed) {
                                                    dbHub.ref('settings/branches/' + key).remove();
                                                }
                                            });
                                        }
                                        function renderBranchWhatsappList() {
                                            const br = document.getElementById('adm-whatsapp-br-sel').value;
                                            const box = document.getElementById('adm-whatsapp-scroll-box');

                                            if (!br) return;

                                            // جلب الأرقام من Firebase
                                            dbHub.ref(`settings/whatsapp_phones/${br}`).on('value', (snap) => {
                                                box.innerHTML = "";
                                                const data = snap.val();
                                                if (data) {
                                                    Object.keys(data).forEach(key => {
                                                        const phone = data[key];
                                                        box.innerHTML += `
                                                            <div class="admin-row-item">
                                                                <span>${phone}</span>
                                                                <i class="fas fa-trash" style="color:var(--danger-pulse);cursor:pointer;"
                                                                   onclick="deleteWhatsappFromServer('${br}', '${key}')"></i>
                                                            </div>`;
                                                    });
                                                } else {
                                                    box.innerHTML = "<div style='text-align:center; padding:10px; opacity:0.5;'>لا توجد أرقام مربوطة</div>";
                                                }
                                            });
                                        }

                                        // دالة الحذف الجديدة من السيرفر
                                        async function deleteWhatsappFromServer(br, key) {
                                            if (confirm("هل أنت متأكد من حذف هذا الرقم؟")) {
                                                await dbHub.ref(`settings/whatsapp_phones/${br}/${key}`).remove();
                                                renderSystemToast("تم حذف الرقم من السيرفر", "success");
                                            }
                                        }
                                        async function bindNewWhatsappToBranch() {
                                            const br = document.getElementById('adm-whatsapp-br-sel').value;
                                            const ph = document.getElementById('adm-whatsapp-phone-input').value.trim();

                                            if (!ph) {
                                                renderSystemToast("يرجى إدخال رقم الهاتف أولاً", "danger");
                                                return;
                                            }

                                            try {
                                                // الحفظ في Firebase مباشرة تحت مسار الفرع
                                                const ref = dbHub.ref(`settings/whatsapp_phones/${br}`);
                                                await ref.push(ph); // نستخدم push لإضافة رقم جديد دون مسح القديم

                                                document.getElementById('adm-whatsapp-phone-input').value = "";
                                                renderSystemToast("تم ربط الرقم بنجاح في السيرفر", "success");
                                                // الدالة ستحدث القائمة تلقائياً بسبب المستمع (Listener)
                                            } catch (e) {
                                                console.error(e);
                                                renderSystemToast("فشل الحفظ في السيرفر", "danger");
                                            }
                                        }
                                        async function loadRankPermissionsMatrixHub() {
                                            const rank = document.getElementById('adm-rank-matrix-sel').value;
                                            if (!rank) {
                                                document.getElementById('adm-permissions-grid-hub').classList.add('hidden');
                                                return;
                                            }

                                            document.getElementById('adm-permissions-grid-hub').classList.remove('hidden');

                                            // جلب البيانات من السيرفر أو الكاش
                                            const p = (systemSettingsCache.permissions && systemSettingsCache.permissions[rank]) ? systemSettingsCache.permissions[rank] : {};

                                            // ضبط الـ Checkboxes
                                            document.getElementById('perm-view-all').checked = p.view_all || false;
                                            document.getElementById('perm-create-ticket').checked = p.create_ticket || false;
                                            document.getElementById('perm-reply-ticket').checked = p.reply_ticket || false;
                                            document.getElementById('perm-daily-edit').checked = p.daily_edit || false;
                                            document.getElementById('perm-admin-access').checked = p.admin_access || false;
                                        }
                                        async function saveRankPermissionsSequence() {
                                            const rank = document.getElementById('adm-rank-matrix-sel').value;
                                            if (!rank) return;

                                            // تجميع القيم من الـ Checkboxes
                                            const perms = {
                                                view_all: document.getElementById('perm-view-all').checked,
                                                create_ticket: document.getElementById('perm-create-ticket').checked,
                                                reply_ticket: document.getElementById('perm-reply-ticket').checked,
                                                daily_edit: document.getElementById('perm-daily-edit').checked,
                                                admin_access: document.getElementById('perm-admin-access').checked
                                            };

                                            try {
                                                // الحفظ في Firebase تحت نود settings/permissions
                                                await dbHub.ref('settings/permissions/' + rank).set(perms);
                                                renderSystemToast("تم تثبيت صلاحيات " + rank + " بنجاح", "success");
                                            } catch (e) {
                                                renderSystemToast("فشل الحفظ في السيرفر", "danger");
                                            }
                                        }
                                        function renderAdminUsersScrollBox() {
                                            const b = document.getElementById('adm-users-scroll-box');
                                            if(!b) return;
                                            b.innerHTML = "";
                                            const users = JSON.parse(localStorage.getItem('users') || '{}');
                                            Object.keys(users).forEach(uid => {
                                                const u = users[uid];
                                                // عزل البيانات: مدير الفرع يرى موظفي فرعه فقط
                                                if(currentUserSession.role !== 'SUPER' && currentUserSession.title === 'مدير فرع' && u.branch !== currentUserSession.branch) return;
                                                // تخطي السوبر أدمن الأساسي من الحذف لكن مسموح بالتعديل
                                                const isSuper = uid === 'super';

                                                b.innerHTML += `
                                                    <div class="admin-row-item">
                                                        <div>
                                                            <b style="color:var(--gold-master)">${u.name}</b>
                                                            <small style="color:var(--text-muted-core)">(${u.title})</small>
                                                            <div style="font-size:0.7rem; opacity:0.6;">الفرع: ${u.branch || '---'}</div>
                                                        </div>
                                                        <div style="display:flex; gap:15px;">
                                                            <!-- زر التعديل -->
                                                            <i class="fas fa-user-edit" style="color:var(--success-glow); cursor:pointer;"
                                                            onclick="openEditUserModal('${uid}')" title="تعديل البيانات"></i>

                                                            <!-- زر الحذف -->
                                                            ${!isSuper ? `<i class="fas fa-user-minus" style="color:var(--danger-pulse); cursor:pointer;"
                                                            onclick="deleteUserEntirely('${uid}', '${u.name}')" title="حذف نهائي"></i>` : ''}
                                                        </div>
                                                    </div>`;
                                            });
                                        }
                                        async function registerNewUserToSystemSequence() {
                                            const id = document.getElementById('reg-user-id-core').value.trim();
                                            const userData = {
                                                name: document.getElementById('reg-user-fullname-core').value,
                                                title: document.getElementById('reg-user-rank-sel-core').value,
                                                branch: document.getElementById('reg-user-branch-sel-core').value,
                                                pass: document.getElementById('reg-user-pass-core').value
                                            };

                                            if(id && userData.name) {
                                                // الحفظ في السيرفر (Firebase) لكي يظهر في كل المتصفحات
                                                await dbHub.ref('users/' + id).set(userData);

                                                // تحديث الذاكرة المحلية أيضاً
                                                const localUsers = JSON.parse(localStorage.getItem('users') || '{}');
                                                localUsers[id] = userData;
                                                localStorage.setItem('users', JSON.stringify(localUsers));

                                                renderAdminUsersScrollBox();
                                                renderSystemToast("تم تفعيل المستخدم على السيرفر بنجاح","success");
                                            }
                                        }

                                        async function openEditUserModal(uid) {
                                            // 1. جلب بيانات الموظف الحالية من localStorage
                                            const users = JSON.parse(localStorage.getItem('users') || '{}');
                                            const u = users[uid];
                                            if(!u) return;

                                            // 2. تحضير خيارات الرتب والفروع من الكاش عشان تظهر في التعديل
                                            const ranksOptions = Object.keys(systemSettingsCache.custom_ranks || {}).map(r => `<option value="${r}" ${u.title === r ? 'selected' : ''}>${r}</option>`).join('');
                                            const branchesOptions = branchListCache.map(b => `<option value="${b}" ${u.branch === b ? 'selected' : ''}>${b}</option>`).join('');

                                            // 3. فتح نافذة التعديل باستخدام SweetAlert2
                                            const { value: formValues } = await Swal.fire({
                                                title: `<span style="color:var(--gold-master)">تعديل حساب: ${u.name}</span>`,
                                                background: '#0d1117',
                                                color: '#f0f6fc',
                                                html: `
                                                    <div style="text-align:right; direction:rtl;">
                                                        <label style="display:block; margin-bottom:5px;">الاسم الكامل:</label>
                                                        <input id="swal-name" class="swal2-input" value="${u.name}" style="margin:0 0 15px 0; width:100%;">
                                                        
                                                        <label style="display:block; margin-bottom:5px;">الرتبة / المسمى الوظيفي:</label>
                                                        <select id="swal-rank" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                                                            ${ranksOptions}
                                                        </select>

                                                        <label style="display:block; margin-bottom:5px;">الفرع:</label>
                                                        <select id="swal-branch" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                                                            <option value="ALL" ${u.branch === 'ALL' ? 'selected' : ''}>الإدارة العليا</option>
                                                            ${branchesOptions}
                                                        </select>

                                                        <label style="display:block; margin-bottom:5px;">كلمة المرور الجديدة:</label>
                                                        <input id="swal-pass" type="text" class="swal2-input" value="${u.pass}" style="margin:0 0 15px 0; width:100%;">
                                                        
                                                        <p style="font-size:0.8rem; color:var(--danger-pulse);">* ملحوظة: تغيير الـ ID غير مسموح حفاظاً على السجلات.</p>
                                                    </div>
                                                `,
                                                focusConfirm: false,
                                                showCancelButton: true,
                                                confirmButtonText: 'حفظ التغييرات',
                                                cancelButtonText: 'إلغاء',
                                                confirmButtonColor: 'var(--gold-master)',
                                                preConfirm: () => {
                                                    return {
                                                        name: document.getElementById('swal-name').value,
                                                        title: document.getElementById('swal-rank').value,
                                                        branch: document.getElementById('swal-branch').value,
                                                        pass: document.getElementById('swal-pass').value
                                                    }
                                                }
                                            });

                                            // 4. حفظ البيانات الجديدة في localStorage
                                            if (formValues) {
                                                if(!formValues.name || !formValues.pass) {
                                                    renderSystemToast("الاسم والباسورد مطلوبين!", "danger");
                                                    return;
                                                }

                                                users[uid] = formValues;
                                                localStorage.setItem('users', JSON.stringify(users));
                                                
                                       هت         // تحديث القائمة فوراً
                                                renderAdminUsersScrollBox();
                                                renderSystemToast("تم تحديث بيانات الموظف بنجاح", "success");
                                            }
                                        }
                                        async function registerNewRankTitleCore() {
                                            const rankName = document.getElementById('adm-rank-name-input').value.trim();

                                            if (!rankName) {
                                                renderSystemToast("يرجى كتابة اسم الرتبة أولاً", "danger");
                                                return;
                                            }

                                            try {
                                                // 1. الحفظ في فايربيز (عشان كل الأدمن يشوفوها)
                                                await dbHub.ref('settings/custom_ranks/' + rankName).set(true);

                                                // 2. تحديث الذاكرة المحلية فوراً
                                                const localRanks = JSON.parse(localStorage.getItem('custom_ranks') || '{}');
                                                localRanks[rankName] = true;
                                                localStorage.setItem('custom_ranks', JSON.stringify(localRanks));

                                                // 3. مسح الخانة وتحديث القوائم في الشاشة
                                                document.getElementById('adm-rank-name-input').value = "";

                                                // تحديث الكاش المحلي للنظام
                                                if (!systemSettingsCache.custom_ranks) systemSettingsCache.custom_ranks = {};
                                                systemSettingsCache.custom_ranks[rankName] = true;

                                                // تشغيل دالة التحديث الموحدة للقوائم
                                                syncUiDropdownSelections();

                                                renderSystemToast("تم إضافة الرتبة وتحديث القوائم", "success");
                                            } catch (error) {
                                                console.error(error);
                                                renderSystemToast("فشل الحفظ في السيرفر", "danger");
                                            }
                                        }
                                    function runPermissionShieldCheck() {
                                        if (!currentUserSession) return;

                                        const userRank = currentUserSession.title;
                                        const p = (systemSettingsCache.permissions && systemSettingsCache.permissions[userRank]) ? systemSettingsCache.permissions[userRank] : {};

                                        // السوبر أدمن له صلاحية مطلقة
                                        const isSuper = currentUserSession.role === 'SUPER';

                                        // 1. دخول الإدارة
                                        const isAdmin = isSuper || p.admin_access === true;
                                        const adminTab = document.getElementById('tab-admin');
                                        if (adminTab) {
                                            isAdmin ? adminTab.classList.remove('hidden') : adminTab.classList.add('hidden');
                                        }

                                        // 2. زر إنشاء بلاغ (Floating Button)
                                        // لازم نضمن إنه يظهر لو هو SUPER حتى لو الصلاحيات التانية فيها مشكلة
                                        const canCreate = isSuper || p.create_ticket === true;
                                        const floatBtn = document.getElementById('floating-plus-btn');
                                        if (floatBtn) {
                                            canCreate ? floatBtn.classList.remove('hidden') : floatBtn.classList.add('hidden');
                                        }

                                        // باقي الصلاحيات...
                                    }

                                    // Helpers
                                    function openSidebarControl() { document.getElementById('sidebar-complaint-arc-hub').classList.add('open'); document.getElementById('master-dimmer').style.display='block'; }
                                    function closeSidebarControl() { document.getElementById('sidebar-complaint-arc-hub').classList.remove('open'); document.getElementById('master-dimmer').style.display='none'; }
                                    function toggleSidebar() { const n = document.getElementById('system-side-nav'), d = document.getElementById('master-dimmer'); n.classList.toggle('open'); d.style.display = n.classList.contains('open') ? 'block' : 'none'; }
                                    function closeAllMenus() { document.getElementById('system-side-nav').classList.remove('open'); closeSidebarControl(); }
                                    function switchToAppModule(m) {
                                        // إخفاء كل الموديولات
                                        document.querySelectorAll('.nav-link-vip').forEach(b => b.classList.remove('active'));
                                        document.getElementById('tab-' + m).classList.add('active');
                                        ['live', 'daily', 'archive', 'reports', 'admin'].forEach(id => {
                                            const mod = document.getElementById('module-view-' + id);
                                            if (mod) mod.classList.add('hidden');
                                        });

                                        // إظهار الموديول المطلوب
                                        const targetMod = document.getElementById('module-view-' + m);
                                        if (targetMod) targetMod.classList.remove('hidden');

                                        // تشغيل دوال التحديث الخاصة بكل صفحة
                                        if (m === 'reports') executeAdvancedAnalyticsSequence();
                                        if (m === 'daily') loadDailySnapshotData();

                                        if (m === 'admin') {
                                            // لو دخل صفحة الإدارة، لازم نشغل الدوال دي عشان الجداول تتملي
                                            renderAdminBranchScrollBox();
                                            renderAdminUsersScrollBox();
                                            initPresenceMonitor(); // تشغيل الرادار
                                            loadLogsFromFirebase(); // تحميل السجلات
                                        }

                                        if (window.innerWidth <= 768) closeAllMenus();
                                    }
                                    function renderSystemToast(m, t) {
                                        const b = document.getElementById('system-toast-container'), toast = document.createElement('div');
                                        toast.className = 'toast-msg-vip'; if(t==='danger') toast.style.background='#ef4444';
                                        toast.innerHTML = `<i class="fas ${t==='danger'?'fa-triangle-exclamation':'fa-circle-check'}"></i> ${m}`;
                                        b.appendChild(toast); setTimeout(() => toast.remove(), 5000);
                                    }

                                    function toggleTicketDetails(el) {
                                        el.classList.toggle('expanded');
                                    }

                                    function refreshAllModulesData() {
                                        const selectedBranch = document.getElementById('global-branch-filter').value;
                                        document.getElementById('branch-quick-stat').innerText = selectedBranch === 'ALL' ? "كل المنظومة" : "فرع: " + selectedBranch;

                                        // تحديث كل الأجزاء فوراً
                                        renderLiveBroadcastMatrix();
                                        runArchiveRefreshSequence();
                                        loadDailySnapshotData();
                                        if(!document.getElementById('module-view-reports').classList.contains('hidden')) {
                                            executeAdvancedAnalyticsSequence();
                                        }
                                    }

                // --- محرك حماية وتنبيهات المنظومة الرقمية V52 (العداد الحي المباشر) ---
                let licenseConfig = {}; // تخزين الإعدادات عالمياً لتحديث العداد
                let licenseInterval = null;

                function initLicensingShield() {
                    dbHub.ref('config').on('value', snap => {
                        licenseConfig = snap.val() || {};
                        runLiveLicensingEngine(); // تشغيل المحرك فور وصول البيانات
                    });

                    // إنشاء العداد الذي يعمل كل ثانية
                    if (licenseInterval) clearInterval(licenseInterval);
                    licenseInterval = setInterval(runLiveLicensingEngine, 1000);
                }

                function runLiveLicensingEngine() {
                    const now = Date.now();
                    const exp = licenseConfig.expiryDate || 0;
                    const graceMs = (licenseConfig.graceDays || 0) * 24 * 60 * 60 * 1000;
                    const hardLock = exp + graceMs;

                    if (licenseConfig.manualLocked || now > hardLock) {
                        renderSubscriptionKillScreen(licenseConfig);
                        removeExpiryWarning();
                    }
                    else if (now >= exp && now <= hardLock) {
                        // العميل في فترة السماح - عداد حي أحمر
                        renderGraceWarning(hardLock - now);
                        hideKillScreen();
                    }
                    else {
                        const timeLeft = exp - now;
                        const alertThreshold = 24 * 60 * 60 * 1000; // يظهر التنبيه قبل 24 ساعة

                        if (timeLeft > 0 && timeLeft <= alertThreshold) {
                            // العميل في فترة الاشتراك - عداد حي أصفر
                            renderNormalWarning(timeLeft);
                        } else {
                            removeExpiryWarning();
                        }
                        hideKillScreen();
                    }
                }

                function renderNormalWarning(ms) {
                    let bar = document.getElementById('expiry-warning-bar');
                    if (!bar) {
                        bar = document.createElement('div');
                        bar.id = 'expiry-warning-bar';
                        document.body.prepend(bar);
                    }

                    // الحساب بنظام (أيام : ساعات : دقائق : ثواني)
                    const d = Math.floor(ms / (1000 * 60 * 60 * 24));
                    const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((ms % (1000 * 60)) / 1000);

                    // التنسيق ليطابق لوحة تحكمك (01:23:59:59)
                    const timeStr = `${d.toString().padStart(2,'0')}:${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

                    bar.style = "background:#fbbf24; color:#000; text-align:center; padding:4px 10px; font-weight:800; font-size:12px; position:sticky; top:0; z-index:9999; direction:rtl; border-bottom:1px solid rgba(0,0,0,0.1);";
                    bar.innerHTML = `<i class="fas fa-clock fa-spin"></i> تنبيه: ينتهي الاشتراك خلال (${timeStr}). يرجى التجديد.`;
                }

                // دالة تنبيه فترة السماح (أحمر)
                function renderGraceWarning(ms) {
                    let bar = document.getElementById('expiry-warning-bar');
                    if (!bar) {
                        bar = document.createElement('div');
                        bar.id = 'expiry-warning-bar';
                        document.body.prepend(bar);
                    }

                    const d = Math.floor(ms / (1000 * 60 * 60 * 24));
                    const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((ms % (1000 * 60)) / 1000);

                    const timeStr = `${d.toString().padStart(2,'0')}:${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

                    bar.style = "background:#ef4444; color:#fff; text-align:center; padding:6px 10px; font-weight:bold; font-size:12px; position:sticky; top:0; z-index:9999; direction:rtl; box-shadow:0 2px 10px rgba(0,0,0,0.3);";
                    bar.innerHTML = `<i class="fas fa-exclamation-circle fa-beat"></i> انتهى الاشتراك! فترة سماح متبقية: (${timeStr}).`;
                }

                function removeExpiryWarning() {
                    const b = document.getElementById('expiry-warning-bar');
                    if(b) b.remove();
                }

                function hideKillScreen() {
                    const overlay = document.getElementById('licensing-lock-overlay');
                    if (overlay) overlay.remove();
                }

                function renderSubscriptionKillScreen(conf) {
                    if (document.getElementById('licensing-lock-overlay')) return;
                    const overlay = document.createElement('div');
                    overlay.id = 'licensing-lock-overlay';
                    overlay.style = "position:fixed; inset:0; background:#010409; z-index:100000; display:flex; align-items:center; justify-content:center; flex-direction:column; padding:20px;";
                overlay.innerHTML = `<div style="background:#0d1117; padding:40px; border-radius:20px; border:2px solid #ef4444; max-width:500px; text-align:center; color:#fff; font-family:'Cairo';">
                <i class="fas fa-shield-slash" style="font-size:5rem; color:#ef4444; margin-bottom:20px;"></i>
                <h1>توقف النظام!</h1>
                <p style="color:#8b949e; margin-bottom:20px;">انتهت فترة السماح. يرجى التواصل مع الإدارة.</p>
                <div style="background:#161b22; padding:20px; border-radius:15px; border-right:6px solid #fbbf24; text-align:right;">
                    <b>للتواصل: 01000060338</b><br>
                    <b>الحساب البنكي: 222</b><br>
                    <b>الاسم: أ/تامر </b>
                </div>
            </div>`;
                    document.body.appendChild(overlay);
                }

                // التشغيل
                setTimeout(initLicensingShield, 1500);

                async function addUniversalReply(id) {
                    const { value: replyText } = await Swal.fire({
                        title: `إضافة رد (بصفتي ${currentUserSession.title})`,
                        input: 'textarea',
                        inputPlaceholder: 'اكتب ردك هنا...',
                        showCancelButton: true,
                        confirmButtonText: 'إرسال الرد',
                        cancelButtonText: 'إلغاء',
                        confirmButtonColor: '#4b5563'
                    });

                    if (replyText) {
                        const op = complaintsCache[id];
                        const userSignature = `${currentUserSession.name} (${currentUserSession.title})`;
                        const newLog = {
                            time: new Date().toLocaleTimeString('ar-EG'),
                            user: userSignature,
                            action: `رد عام: ${replyText}`
                        };

                        await dbHub.ref('operations/' + id).update({
                            logs: [...(op.logs || []), newLog]
                        });

                        renderSystemToast("تم إضافة الرد بنجاح", "success");
                    }
                }

                async function transferTicket(id, targetStage) {
                    const op = complaintsCache[id];
                    const stageNames = {
                        'sent_to_dispatcher': 'الديسبتشر',
                        'sent_to_branch_manager': 'مدير الفرع',
                        'sent_to_regional_manager': 'مدير المنطقة',
                        'sent_back_to_call_center': 'الكول سنتر'
                    };

                    const { value: reason } = await Swal.fire({
                        title: `تحويل البلاغ إلى ${stageNames[targetStage]}`,
                        input: 'textarea',
                        inputLabel: 'اكتب ملاحظة التحويل:',
                        inputPlaceholder: 'لماذا قمت بتحويل البلاغ؟',
                        showCancelButton: true,
                        confirmButtonText: 'تأكيد التحويل'
                    });

                    if (reason) {
                        const userSignature = `${currentUserSession.name} (${currentUserSession.title})`;
                        const newLog = {
                            time: new Date().toLocaleTimeString('ar-EG'),
                            user: userSignature,
                            action: `قام بالتحويل إلى ${stageNames[targetStage]} - الملاحظة: ${reason}`
                        };

                        await dbHub.ref('operations/' + id).update({
                            stage: targetStage,
                            logs: [...(op.logs || []), newLog]
                        });

                        renderSystemToast("تم التحويل بنجاح", "success");
                    }
                }

                // --- وظيفة توليد الزراير بشكل ديناميكي حسب الرتبة ---
                function generateDynamicButtons(id, op) {
                    let btns = "";
                    const userTitle = currentUserSession.title; // رتبة الشخص اللي فاتح اللوجن دلوقتي
                    const isSuper = (currentUserSession.role === 'SUPER');

                    // تخصيص الزراير حسب "مين اللي فاتح اللوجن"

                    // --- لو اللي فاتح "كول سنتر" ---
                    if (userTitle === 'كول سنتر' || isSuper) {
                        if (op.stage === 'sent_back_to_call_center') {
                            btns += `<button class="btn-vip-execute-master" style="background:#10b981;" onclick="event.stopPropagation(); finalizeTicketAndArchive('${id}')">
                                    <i class="fas fa-check-double"></i> إنهاء وأرشفة (تم الحل)
                                    </button>`;
                        }
                        btns += `<button class="btn-vip-execute-master" style="background:#3b82f6;" onclick="event.stopPropagation(); transferTicket('${id}', 'sent_to_dispatcher')">
                                <i class="fas fa-paper-plane"></i> توجيه للديسبتشر
                                </button>`;
                    }

                    // --- لو اللي فاتح "ديسبتشر" ---
                    if (userTitle === 'ديسبتشر' || isSuper) {
                        btns += `<button class="btn-vip-execute-master" style="background:#f59e0b; color:black;" onclick="event.stopPropagation(); transferTicket('${id}', 'sent_to_branch_manager')">
                                <i class="fas fa-arrow-right"></i> تحويل لمدير الفرع
                                </button>`;
                        btns += `<button class="btn-vip-execute-master" style="background:#6366f1;" onclick="event.stopPropagation(); transferTicket('${id}', 'sent_back_to_call_center')">
                                <i class="fas fa-undo"></i> إعادة للكول سنتر
                                </button>`;
                    }

                    // --- لو اللي فاتح "مدير فرع" ---
                    if (userTitle === 'مدير فرع' || isSuper) {
                        btns += `<button class="btn-vip-execute-master" style="background:#f59e0b; color:black;" onclick="event.stopPropagation(); openBranchManagerReplyModalHub('${id}')">
                                <i class="fas fa-file-signature"></i> الرد النهائي على الشكوى
                                </button>`;
                        btns += `<button class="btn-vip-execute-master" style="background:#ef4444;" onclick="event.stopPropagation(); transferTicket('${id}', 'sent_to_regional_manager')">
                                <i class="fas fa-level-up-alt"></i> تصعيد لمدير المنطقة
                                </button>`;
                    }

                    // --- لو اللي فاتح "مدير منطقة" ---
                    if (userTitle === 'مدير منطقة' || isSuper) {
                        btns += `<button class="btn-vip-execute-master" style="background:#7c3aed;" onclick="event.stopPropagation(); transferTicket('${id}', 'sent_back_to_call_center')">
                                <i class="fas fa-check-circle"></i> اعتماد الحل وإرساله للكول سنتر
                                </button>`;
                    }

                    // زرار الحذف (للسوبر أدمن والكول سنتر)
                    if (isSuper || userTitle === 'كول سنتر') {
                        btns += `<button class="btn-vip-execute-master" style="background:#ef4444; margin-top:10px;" onclick="event.stopPropagation(); deleteTicketRecord('${id}')">
                                <i class="fas fa-trash"></i> حذف نهائي
                                </button>`;
                    }

                    return btns;
                }
                                </script>
                            </body>
                        </html>
