                        <!DOCTYPE html>
            <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>CMS COMMAND CENTER V47</title>
                    
                    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

                    <!-- 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ´ØªØºÙ„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ø·ÙˆÙ„) -->
                    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
                    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

                    <script>
                      // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨ØªØ§Ø¹Ùƒ (Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ø¨Ø¹ØªÙ‡Ø§)
                      const firebaseConfig = {
                        apiKey: "AIzaSyCcgHfPeVGSA699yFPH24AP5jt7VJgzYyw",
                        authDomain: "abn-maser-21fdb.firebaseapp.com",
                        databaseURL: "https://abn-maser-21fdb-default-rtdb.firebaseio.com",
                        projectId: "abn-maser-21fdb",
                        storageBucket: "abn-maser-21fdb.firebasestorage.app",
                        messagingSenderId: "921105330552",
                        appId: "1:921105330552:web:95f87a56b524b15f7f188d",
                        measurementId: "G-REL2TVSPSM"
                      };

                      // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                      firebase.initializeApp(firebaseConfig);

                      // 4. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙŠÙÙ‡Ù…Ù‡)
                      const dbHub = firebase.database();
                    </script>

                    <style>
                        /* 
                        ========================================================================
                        --- CSS MASTER ARCHITECTURE: VIP HOVER EDITION --- 
                        ========================================================================
                        */
            :root {
                --primary-bg-core: #010409;
                --glass-surface: rgba(13, 17, 23, 0.96);
                --gold-master: #f59e0b;
                --gold-bright: #fbbf24;
                --accent-navy: #1d4ed8;
                --success-glow: #10b981;
                --danger-pulse: #ef4444;
                --text-pure: #f0f6fc;
                --text-muted-core: #8b949e;
                --border-glow-line: rgba(245, 158, 11, 0.28);
                --radius-massive: 8px;
                --shadow-depth: 0 30px 60px rgba(0,0,0,0.85), inset 0 1px 2px rgba(255,255,255,0.06);
                --font-stack: 'Cairo', sans-serif;
                --transition-speed: 0.2s;
                --sidebar-width: 200px;
            }

                        /* Animations */
                        @keyframes slideRightFade { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
                        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
                        @keyframes rotateBrand { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                        @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                        @keyframes pulseLive { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

                        ::-webkit-scrollbar { width: 10px; }
                        ::-webkit-scrollbar-track { background: var(--primary-bg-core); }
                        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--gold-master), #d97706); border-radius: 12px; border: 3px solid var(--primary-bg-core); }

                        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; transition: var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1); }

            body {
                font-family: var(--font-stack);
                background: var(--primary-bg-core);
                color: var(--text-pure);
                min-height: 100vh;
                overflow-x: hidden;
                font-size: 13px;
                background-image: radial-gradient(circle at 5% 5%, rgba(245, 158, 11, 0.08) 0%, transparent 45%), radial-gradient(circle at 95% 95%, rgba(29, 78, 216, 0.08) 0%, transparent 50%);
                background-attachment: fixed;
            }

                        /* Layout */
                        .system-side-nav {
                            position: fixed; top: 20px; right: 20px; bottom: 20px; width: var(--sidebar-width);
                            background: var(--glass-surface); backdrop-filter: blur(55px);
                            border: 1px solid var(--border-glow-line); border-radius: var(--radius-massive);
                            box-shadow: var(--shadow-depth); z-index: 1000;
                            display: flex; flex-direction: column; padding: 20px 15px; overflow-y: auto;
                            animation: slideRightFade 0.8s ease-out;
                        }

                        .vip-master-container {
                            margin-right: calc(var(--sidebar-width) + 30px); margin-left: 20px;
                            padding-top: 20px; padding-bottom: 100px; max-width: 100%;
                            animation: slideUpFade 0.7s ease-out;
                        }

                        .hamburger-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 1100; background: var(--gold-master); color: #000; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }

                        /* Mobile Responsive */
                        @media (max-width: 768px) {
                            body { font-size: 12px; }
                            .vip-master-container { margin-right: 0 !important; margin-left: 0 !important; padding: 15px !important; padding-top: 80px !important; }
                            .system-side-nav { width: 280px !important; right: -300px !important; top: 0 !important; bottom: 0 !important; height: 100vh !important; border-radius: 0 !important; z-index: 3000 !important; }
                            .system-side-nav.open { right: 0 !important; }
                            .hamburger-btn { display: flex !important; }
                            .login-card-massive { width: 95% !important; padding: 40px 20px !important; }
                            .floating-action-master { width: 60px !important; height: 60px !important; font-size: 1.8rem !important; bottom: 20px !important; left: 20px !important; }
                            .admin-layout-flex { grid-template-columns: 1fr !important; }
                            h1 { font-size: 2rem !important; }
                        }

                        /* Sidebar Elements */
                        .identity-matrix { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid rgba(255,255,255,0.05); }
                        .identity-orb-vip { width: 70px; height: 70px; background: linear-gradient(135deg, var(--gold-master), #b45309); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 950; color: #000; font-size: 1.8rem; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4); cursor: pointer; margin-bottom: 10px; }
                        .identity-orb-vip:hover { animation: rotateBrand 2s infinite linear; }
                        .nav-hub-menu { display: flex; flex-direction: column; gap: 15px; flex: 1; }
                        .nav-link-vip { background: rgba(255,255,255,0.03); border: 1px solid transparent; color: var(--text-muted-core); padding: 15px 20px; border-radius: 18px; cursor: pointer; font-family: var(--font-stack); font-weight: 800; font-size: 1rem; display: flex; align-items: center; gap: 18px; width: 100%; }
                        .nav-link-vip:hover, .nav-link-vip.active { background: rgba(245, 158, 11, 0.15); color: var(--gold-master); border-color: var(--border-glow-line); transform: translateX(-8px); }
                        .nav-link-vip.active { background: var(--gold-master); color: #000; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }
                        .logout-btn-sidebar { margin-top: auto; background: rgba(239, 68, 68, 0.1) !important; color: var(--danger-pulse) !important; border: 1px solid rgba(239, 68, 68, 0.3) !important; justify-content: center; }

                        /* Cards & Inputs */
                        .massive-glass-card { background: var(--glass-surface); backdrop-filter: blur(55px); border: 1px solid var(--border-glow-line); border-radius: var(--radius-massive); box-shadow: var(--shadow-depth); position: relative; overflow: hidden; }
                        .floating-action-master { position: fixed; bottom: 50px; left: 50px; width: 100px; height: 100px; border-radius: 50%; background: var(--gold-master); color: #000; font-size: 3.5rem; border: none; cursor: pointer; z-index: 2000; box-shadow: 0 40px 90px rgba(245, 158, 11, 0.8); display: flex; align-items: center; justify-content: center; }
                        .floating-action-master:hover { transform: scale(1.1) rotate(90deg); }
                        
                        .sidebar-complaint-master { position: fixed; top: 0; left: -700px; width: 600px; height: 100%; background: #0b0e14; border-right: 12px solid var(--gold-master); z-index: 2600; padding: 70px; transition: 1s cubic-bezier(0.7, 0, 0.1, 1); box-shadow: 60px 0 200px rgba(0,0,0,1); overflow-y: auto; }
                        .sidebar-complaint-master.open { left: 0; }
                        .dimmer-overlay-master { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 2599; display: none; }

                        /*
            ============================================================
            --- VIP COMPACT MODE (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¶Ø®Ù…) ---
            ============================================================
            */

            :root {
                /* ØªØµØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ */
                --sidebar-width: 240px;
                --radius-massive: 12px;
                --transition-speed: 0.2s;
            }

            body {
                /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
                font-size: 13px;
            }

            /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ØªØµØºÙŠØ± ÙƒÙ„ÙŠ) --- */
            .system-side-nav {
                width: var(--sidebar-width);
                padding: 15px 10px;
                top: 15px; right: 15px; bottom: 15px;
            }

            .identity-orb-vip {
                width: 60px; height: 60px; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ù…Ù† 110px */
                font-size: 1.5rem;
                border-width: 3px;
                margin-bottom: 10px;
            }

            .identity-labels h2 { font-size: 1rem; }
            .identity-labels span { font-size: 0.75rem; }

            .nav-link-vip {
                padding: 10px 12px;
                font-size: 0.85rem;
                gap: 10px;
                border-radius: 10px;
                margin-bottom: 5px;
            }

            /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
            .vip-master-container {
                margin-right: calc(var(--sidebar-width) + 30px);
                margin-left: 15px;
                padding-top: 15px;
            }

            h1 { font-size: 1.6rem !important; margin-bottom: 15px !important; }

            /* --- Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ (ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø´Ø¨ÙƒØ© ÙƒØ±ÙˆØª ØµØºÙŠØ±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§) --- */
            #render-live-feed-matrix {
                display: grid;
                /* ÙŠØ¸Ù‡Ø± 3 Ø£Ùˆ 4 Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 12px;
            }

            .ticket-visual-unit {
                padding: 15px;
                border-radius: var(--radius-massive);
                border-right: 6px solid var(--gold-master);
                margin-bottom: 15px;
                background: #0d1117;
                height: 110px; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒØ§Ø±Øª ÙˆÙ‡Ùˆ Ù…Ù‚ÙÙˆÙ„ */
                overflow: hidden;
                transition: all 0.3s ease;
                cursor: pointer;
                position: relative;
                border: 1px solid rgba(255,255,255,0.05);
            }

            /* Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Hover Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· (is-fixed) */
            .ticket-visual-unit:hover,
            .ticket-visual-unit.is-fixed {
                height: auto;
                min-height: 110px;
                background: #161b22;
                border-color: var(--gold-bright);
                z-index: 100;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                transform: translateY(-2px);
            }

            /* ØªØµÙ…ÙŠÙ… Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù„ÙŠÙƒÙˆÙ† ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ */
            .order-number-badge {
                font-size: 2.2rem !important; /* Ø§Ù„Ø±Ù‚Ù… ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­ */
                font-weight: 900;
                color: #ffffff;
                display: block;
                margin: 5px 0;
                line-height: 1;
            }

            .ticket-hidden-details {
                opacity: 0;
                display: none;
            }

            .ticket-visual-unit:hover .ticket-hidden-details,
            .ticket-visual-unit.is-fixed .ticket-hidden-details {
                opacity: 1;
                display: block;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }

            /* ØªØµØºÙŠØ± Ø¹Ø§Ù… Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¨Ù‚Ø§Ø´ Ø¶Ø®Ù… */
            .vip-master-container { padding: 10px; margin-right: calc(var(--sidebar-width) + 20px); }
            h1 { font-size: 1.4rem !important; }
            .btn-vip-execute-master { padding: 10px; font-size: 0.9rem; }

                        /* ================================================== */

                        .badge-status-glow { padding: 10px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 950; display: inline-block; margin-bottom: 20px; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

                        .daily-matrix-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 40px; }
                        .branch-data-card { padding: 50px; text-align: center; border-bottom: 10px solid var(--gold-master); background: rgba(255,255,255,0.04); border-radius: var(--radius-massive); }
                        .massive-daily-input { font-size: 5rem; font-weight: 950; color: var(--gold-master); width: 100%; text-align: center; background: transparent; border: none; border-bottom: 6px solid var(--border-glow-line); margin-top: 30px; }
                        
                        input, select, textarea { width: 100%; padding: 20px; border-radius: 18px; background: #010409; border: 2px solid var(--border-glow-line); color: white; margin-bottom: 25px; font-family: var(--font-stack); font-size: 1.1rem; }
                        input:focus, select:focus { border-color: var(--gold-master); box-shadow: 0 0 25px rgba(245, 158, 11, 0.25); }
                        .btn-vip-execute-master { background: var(--gold-master); color: #000; border: none; padding: 20px; border-radius: 20px; font-weight: 950; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.2rem; box-shadow: 0 20px 50px rgba(245, 158, 11, 0.4); }
                        .btn-vip-execute-master:hover { filter: brightness(1.2); transform: translateY(-5px); }

                        .stat-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 80px; }
                        .analytics-pill-card { padding: 50px; text-align: center; border-radius: 30px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glow-line); }
                        .analytics-pill-card h2 { font-size: 3.5rem; font-weight: 950; color: var(--gold-master); }
                        .analytics-dual-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; margin-top: 50px; }
                        .chart-viewport-massive { padding: 60px; background: rgba(0,0,0,0.45); border-radius: 40px; border: 2px solid var(--border-glow-line); }

                        .admin-layout-flex { display: grid; grid-template-columns: 1fr; gap: 60px; }
                        @media(min-width: 1600px) { .admin-layout-flex { grid-template-columns: 1.5fr 1fr; } }
                        .scrollable-admin-list { max-height: 400px; overflow-y: auto; border: 2px solid var(--border-glow-line); border-radius: 20px; padding: 25px; background: rgba(0,0,0,0.3); }
                        .admin-row-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
                        
                        #system-toast-container { position: fixed; bottom: 40px; left: 40px; z-index: 6000; }
                        .toast-msg-vip { background: var(--gold-master); color: #000; padding: 20px 40px; border-radius: 15px; font-weight: 950; box-shadow: 0 20px 45px rgba(0,0,0,0.7); margin-top: 15px; display: flex; align-items: center; gap: 15px; animation: slideInRight 0.6s; }
                        
                        #auth-portal-mask { height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; z-index: 9999; position: fixed; inset: 0; }
                        .login-card-massive { width: 650px; padding: 100px 80px; text-align: center; border: 6px solid var(--gold-master); }
                        .hidden { display: none !important; }

                        /* --- Ø±Ø§Ø¯Ø§Ø± VIP Ø§Ù„Ù…Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø£Ù†ÙŠÙ‚ --- */
                        .presence-grid {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 15px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
                            justify-content: flex-start; /* Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
                            padding: 10px;
                        }

                        .presence-user-orb {
                            width: 75px; /* Ø¹Ø±Ø¶ Ù…Ø¯Ù…Ø¬ Ø¬Ø¯Ø§Ù‹ */
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        }

                        .presence-user-orb:hover { transform: scale(1.1); }

                        /* Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ø§Ù„ØµØºÙŠØ± ÙˆØ§Ù„Ø£Ù†ÙŠÙ‚ */
                        .avatar-ring {
                            width: 50px; /* Ø­Ø¬Ù… ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ */
                            height: 50px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #161b22;
                            border: 2px solid #30363d;
                            font-size: 1.2rem;
                            font-weight: bold;
                            color: #8b949e;
                            position: relative;
                        }

                        /* ØªÙˆÙ‡Ø¬ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
                        .orb-online .avatar-ring {
                            border-color: #238636; /* Ø£Ø®Ø¶Ø± Ù‡Ø§Ø¯Ø¦ */
                            box-shadow: 0 0 10px rgba(35, 134, 54, 0.4);
                            color: #39d353;
                        }

                        /* Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© */
                        .status-indicator {
                            position: absolute;
                            bottom: 2px;
                            right: 2px;
                            width: 12px;
                            height: 12px;
                            border-radius: 50%;
                            border: 2px solid #0d1117;
                            background: #484f58;
                        }

                        .orb-online .status-indicator { background: #39d353; }

                        .user-name-label {
                            margin-top: 5px;
                            font-size: 0.85rem;
                            color: #f0f6fc;
                            text-align: center;
                            width: 100%;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }

                        .user-rank-mini { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ØªØ¨Ø© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© */

                        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹) */
                        .orb-offline .avatar-ring {
                            border: 2px solid #30363d;
                            filter: grayscale(1); /* Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù‡ØªØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
                        }

                        .orb-offline .status-indicator {
                            background: #484f58; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø­Ø§Ù„Ø© */
                            box-shadow: none;
                        }

                        .orb-online .status-indicator {
                            background: #39d353;
                            box-shadow: 0 0 10px #39d353;
                            animation: pulseLive 2s infinite;
                        }

                        @keyframes pulseLive {
                            0% { transform: scale(1); opacity: 1; }
                            50% { transform: scale(1.2); opacity: 0.7; }
                            100% { transform: scale(1); opacity: 1; }
                        }

                /* ØªÙ†Ø³ÙŠÙ‚ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· - 4 Ø£Ø¹Ù…Ø¯Ø© */
                .log-table-row {
                    display: grid;
                    /* Ø§Ù„Ù…ÙˆØ¸Ù (ÙŠÙ…ÙŠÙ†) | Ø§Ù„Ø­Ø¯Ø« | Ø§Ù„ØªÙˆÙ‚ÙŠØª | Ø§Ù„ÙØ±Ø¹ (ÙŠØ³Ø§Ø±) */
                    grid-template-columns: 1.5fr 1.5fr 1.2fr 1fr;
                    padding: 12px 20px;
                    border-bottom: 1px solid rgba(255,255,255,0.05);
                    font-size: 0.9rem;
                    align-items: center;
                    direction: rtl; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ù† */
                }

                .log-header {
                    font-weight: 800;
                    color: var(--gold-master);
                    background: rgba(255, 255, 255, 0.02);
                    border-bottom: 2px solid var(--gold-master);
                    position: sticky;
                    top: 0;
                    z-index: 5;
                }

                .scrollable-admin-list {
                    max-height: 400px;
                    overflow-y: auto;
                    background: rgba(0,0,0,0.2);
                    border-radius: 0 0 10px 10px;
                }

                        .log-action-pill {
                            padding: 5px 12px;
                            border-radius: 8px;
                            font-size: 0.85rem;
                            font-weight: 800;
                            display: inline-block;
                        }

                        .radar-header-container {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            margin-bottom: 30px;
                        }

                        .scan-line {
                            height: 2px;
                            background: linear-gradient(90deg, transparent, var(--success-glow), transparent);
                            width: 100%;
                            position: relative;
                            overflow: hidden;
                            margin-bottom: 20px;
                        }
                        .scan-line::after {
                            content: '';
                            position: absolute;
                            left: -100%;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(90deg, transparent, #fff, transparent);
                            animation: scanning 3s linear infinite;
                        }
                        @keyframes scanning {
                            0% { left: -100%; }
                            100% { left: 100%; }
                        }

                        /*
            ============================================================
            --- VIP COMPACT MODE (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¶Ø®Ù…) ---
            ============================================================
            */

            :root {
                /* ØªØµØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ */
                --sidebar-width: 240px;
                --radius-massive: 12px;
                --transition-speed: 0.2s;
            }

            body {
                /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
                font-size: 13px;
            }

            /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ØªØµØºÙŠØ± ÙƒÙ„ÙŠ) --- */
            .system-side-nav {
                width: var(--sidebar-width);
                padding: 15px 10px;
                top: 15px; right: 15px; bottom: 15px;
            }

            .identity-orb-vip {
                width: 60px; height: 60px; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ù…Ù† 110px */
                font-size: 1.5rem;
                border-width: 3px;
                margin-bottom: 10px;
            }

            .identity-labels h2 { font-size: 1rem; }
            .identity-labels span { font-size: 0.75rem; }

            .nav-link-vip {
                padding: 10px 12px;
                font-size: 0.85rem;
                gap: 10px;
                border-radius: 10px;
                margin-bottom: 5px;
            }

            /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
            .vip-master-container {
                margin-right: calc(var(--sidebar-width) + 30px);
                margin-left: 15px;
                padding-top: 15px;
            }

            h1 { font-size: 1.6rem !important; margin-bottom: 15px !important; }

            /* --- Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ (ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø´Ø¨ÙƒØ© ÙƒØ±ÙˆØª ØµØºÙŠØ±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§) --- */
            #render-live-feed-matrix {
                display: grid;
                /* ÙŠØ¸Ù‡Ø± 3 Ø£Ùˆ 4 Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 12px;
            }

            .ticket-visual-unit {
                padding: 12px 15px;
                height: 100px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¬Ø¯Ø§Ù‹ */
                margin-bottom: 0;
                border-right-width: 6px;
                background: #0d1117;
                border-radius: 10px;
                transition: 0.3s;
            }

            /* ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒØ§Ø±Øª Ø¹Ù†Ø¯ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø¹Ù„ÙŠÙ‡ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ */
            .ticket-visual-unit:hover {
                height: auto;
                min-height: 100px;
                z-index: 100;
            }

            /* ØªØµØºÙŠØ± Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ù„Ø§Øº */
            .ticket-visual-unit b { font-size: 1rem !important; } /* Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ */
            .ticket-visual-unit div { font-size: 0.75rem; } /* Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª */

            /* ØªØµØºÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø¶Ø®Ù… */
            .ticket-visual-unit div[style*="font-size: 3rem"],
            .ticket-visual-unit div[style*="font-size: 5rem"] {
                font-size: 1.4rem !important;
                font-weight: 900;
                margin: 5px 0 !important;
            }

            /* --- ØªØµØºÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
            input, select, textarea {
                padding: 8px 12px;
                font-size: 0.85rem;
                margin-bottom: 10px;
                border-radius: 8px;
            }

            .btn-vip-execute-master {
                padding: 10px;
                font-size: 0.95rem;
                border-radius: 10px;
            }

            /* ØªØµØºÙŠØ± Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
            .floating-action-master {
                width: 55px; height: 55px;
                font-size: 1.5rem;
                bottom: 20px; left: 20px;
            }

            /* --- ØªØµØºÙŠØ± ÙƒØ±ÙˆØª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ÙŠÙˆÙ…ÙŠØ© --- */
            .analytics-pill-card {
                padding: 20px;
            }
            .analytics-pill-card h2 {
                font-size: 1.8rem;
            }
            .branch-data-card {
                padding: 20px;
            }
            .massive-daily-input {
                font-size: 2.5rem; /* ØªØµØºÙŠØ± Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¶Ø®Ù… */
            }
                        /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± */
                        .alarm-screen {
                            position: fixed;
                            top: 0; left: 0; width: 100%; height: 100%;
                            background-color: rgba(220, 38, 38, 0.85); /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø´ÙØ§Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
                            z-index: 10000; /* ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            backdrop-filter: blur(10px);
                            animation: flashRed 1s infinite; /* ÙˆÙ…ÙŠØ¶ Ù…Ø³ØªÙ…Ø± */
                        }

                        /* Ø­Ø±ÙƒØ© Ø§Ù„ÙˆÙ…ÙŠØ¶ */
                        @keyframes flashRed {
                            0% { background-color: rgba(220, 38, 38, 0.85); box-shadow: inset 0 0 0 0 red; }
                            50% { background-color: rgba(185, 28, 28, 0.95); box-shadow: inset 0 0 100px 50px #ff0000; }
                            100% { background-color: rgba(220, 38, 38, 0.85); box-shadow: inset 0 0 0 0 red; }
                        }

                        .alarm-content {
                            text-align: center;
                            color: white;
                            background: #000;
                            padding: 40px;
                            border-radius: 20px;
                            border: 4px solid #fca5a5;
                            box-shadow: 0 0 50px rgba(0,0,0,0.8);
                        }

                        .btn-stop-alarm {
                            background: #fff;
                            color: #dc2626;
                            border: none;
                            padding: 15px 40px;
                            font-size: 1.5rem;
                            font-weight: 900;
                            border-radius: 50px;
                            cursor: pointer;
                            margin-top: 20px;
                            transition: 0.2s;
                        }

                        .btn-stop-alarm:hover {
                            transform: scale(1.1);
                            box-shadow: 0 0 20px #fff;
                        }

/* ØªØµÙ…ÙŠÙ… ØªÙ‚Ø§Ø±ÙŠØ± VIP - Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØµÙˆØ± */
.reports-dashboard-container {
    background: #e2e8f0; /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© Ù„Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    padding: 20px;
    border-radius: 15px;
    color: #1e293b;
}

.blue-report-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    font-size: 0.8rem;
    border: 1px solid #1e3a8a;
    margin-bottom: 20px;
}

.blue-report-table th {
    background: #3b82f6; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ Ù„Ù„Ù‡ÙŠØ¯Ø± */
    color: white;
    padding: 8px 4px;
    border: 1px solid #1e40af;
    text-align: center;
}

.blue-report-table td {
    border: 1px solid #94a3b8;
    padding: 6px 3px;
    text-align: center;
    font-weight: bold;
}

/* ØªÙ…ÙŠÙŠØ² Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„ØºØ§Ù…Ù‚ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© */
.total-cell-accent {
    background: #1e3a8a !important;
    color: white !important;
}

.subtotal-cell-accent {
    background: #dbeafe;
    color: #1e3a8a;
}

.chart-summary-layout {
    display: grid;
    grid-template-columns: 3fr 1fr; /* Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙƒØ¨ÙŠØ± ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± Ø¬Ø§Ù†Ø¨Ù‡ */
    gap: 20px;
    margin-top: 20px;
}

.summary-side-table th {
    background: #1e3a8a;
    color: white;
}
                    </style>
                </head>
                <body>

                    <div id="system-toast-container"></div>
                    <div id="master-dimmer" class="dimmer-overlay-master" onclick="closeAllMenus()"></div>

                    <!-- Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
                    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

                    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ -->
                    <div id="red-alarm-overlay" class="alarm-screen hidden">
                        <div class="alarm-content">
                            <i class="fas fa-bell fa-shake" style="font-size: 5rem; margin-bottom: 20px;"></i>
                            <h1>ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…! ğŸš¨</h1>
                            <p>ÙŠÙˆØ¬Ø¯ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ ÙŠØ®Øµ ÙØ±Ø¹Ùƒ</p>
                            <button class="btn-stop-alarm" onclick="stopAlarmAndShowTicket()">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
                        </div>
                    </div>

                    <!-- Authentication Portal -->
                    <div id="auth-portal-mask">
                        <div class="massive-glass-card login-card-massive">
                            <div class="identity-orb-vip" style="margin: 0 auto; cursor: default;">CMS</div>
                            <h1 style="color:var(--gold-master); font-weight:950; margin-bottom:20px;">CENTRAL COMMAND</h1>
                            <p style="color:var(--text-muted-core); font-weight:900;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„ÙØ§Ø¦Ù‚ V47.0</p>
                            <div style="margin-top: 40px;">
                                <label>ÙƒÙˆØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (UID)</label>
                                <input type="text" id="auth-uid-master" placeholder="UID">
                                <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ù…Ø´ÙØ± (PWD)</label>
                                <input type="password" id="auth-pwd-master" placeholder="PWD">
                                <button class="btn-vip-execute-master" onclick="runSecurityAuthSequence()">ÙˆÙ„ÙˆØ¬ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© <i class="fas fa-shield-halved"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Interface -->
                    <div id="main-system-viewport" class="hidden">
                        
                        <nav class="system-side-nav" id="system-side-nav">
                            <button onclick="closeAllMenus()" style="display:none;" id="mobile-close-btn" class="nav-link-vip"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
                            <div class="identity-matrix">
                                <div class="identity-orb-vip" id="ui-avatar-orb">V</div>
                                <div class="identity-labels">
                                    <h2 id="ui-user-fullname">---</h2>
                                    <span id="ui-user-rank-label" style="display:block; margin-top:5px; color:var(--text-muted-core); font-size:0.9rem;">---</span>
                                </div>
                            </div>
                            
                            <div class="nav-hub-menu">
                                <button class="nav-link-vip active" id="tab-live" onclick="switchToAppModule('live')"><i class="fas fa-satellite-dish"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                                <button class="nav-link-vip" id="tab-daily" onclick="switchToAppModule('daily')"><i class="fas fa-calendar-check"></i> ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
                                <button class="nav-link-vip" id="tab-archive" onclick="switchToAppModule('archive')"><i class="fas fa-database"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                                <button class="nav-link-vip" id="tab-reports" onclick="switchToAppModule('reports')"><i class="fas fa-chart-line"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙƒÙØ§Ø¡Ø©</button>
                                <button class="nav-link-vip hidden" id="tab-admin" onclick="switchToAppModule('admin')"><i class="fas fa-crown"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</button>
                                <button class="nav-link-vip logout-btn-sidebar" onclick="runSystemLogoutSequence()"><i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                            </div>
                        </nav>

                        <div class="vip-master-container">
                            <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                            <button class="floating-action-master" id="floating-plus-btn" onclick="openSidebarControl()"><i class="fas fa-plus"></i></button>

                            <!-- Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
                            <div class="massive-glass-card" style="padding: 15px 25px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-filter" style="color: var(--gold-master);"></i>
                                    <span style="font-weight: 800;">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹:</span>
                                    <select id="global-branch-filter" onchange="refreshAllModulesData()" style="width: 200px; margin-bottom: 0; padding: 5px 15px;">
                                        <option value="ALL">-- Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ --</option>
                                    </select>
                                </div>
                                <div id="branch-quick-stat" style="color: var(--gold-master); font-weight: 900; font-size: 1.1rem;">
                                    <!-- Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹ -->
                                </div>
                            </div>

                            <!-- LIVE MODULE -->
                            <div id="module-view-live">
                                <h1 style="font-size:2rem; margin-bottom:20px; color:var(--text-pure); display:flex; align-items:center; gap:15px;">
                                    <i class="fas fa-satellite-dish" style="color:var(--gold-master)"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
                                </h1>
                                <div id="render-live-feed-matrix" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px;"></div>
                            </div>

                            <!-- DAILY MODULE -->
                            <div id="module-view-daily" class="hidden">
                                <div class="massive-glass-card" style="padding:80px; margin-bottom:80px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                                        <div>
                                            <h2 style="color:var(--gold-master); font-size:2rem; margin:0;">Ù…Ø­Ø±Ùƒ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                                        </div>
                                        <div style="width:250px;"><input type="date" id="daily-master-date-picker" style="font-size:1.2rem;" onchange="loadDailySnapshotData()"></div>
                                    </div>
                                    <div id="render-daily-grid-hub" class="daily-matrix-display"></div>
                                </div>
                            </div>

                            <!-- ARCHIVE MODULE -->
                            <div id="module-view-archive" class="hidden">
                                <div class="massive-glass-card" style="padding:60px; display:flex; gap:40px; margin-bottom:60px; align-items:flex-end;">
                                    <div style="flex:1;"><label>Ù…Ù†:</label><input type="date" id="archive-date-from"></div>
                                    <div style="flex:1;"><label>Ø¥Ù„Ù‰:</label><input type="date" id="archive-date-to"></div>
                                    <button class="btn-vip-execute-master" style="width:300px;" onclick="runArchiveRefreshSequence()">ØªØ­Ø¯ÙŠØ«</button>
                                </div>
                                <div id="render-archive-grid-hub" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(700px, 1fr)); gap:50px;"></div>
                            </div>

                            <!-- REPORTS MODULE UPDATED -->
                            <div id="module-view-reports" class="hidden reports-dashboard-container">
                                <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
                                <div class="massive-glass-card" style="padding:20px; display:flex; gap:15px; margin-bottom:20px; align-items:flex-end; flex-wrap: wrap;">
                                    <div style="flex:1;"><label>Ù…Ù†:</label><input type="date" id="reports-date-from"></div>
                                    <div style="flex:1;"><label>Ø¥Ù„Ù‰:</label><input type="date" id="reports-date-to"></div>
                                    <button class="btn-vip-execute-master" style="width:150px;" onclick="executeAdvancedAnalyticsSequence()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                                    <button class="btn-vip-execute-master" style="width:120px; background:#1d4ed8;" onclick="exportReportsToExcel()">Excel</button>
                                </div>

                                <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„Ù…ØµÙÙˆÙØ©) -->
                                <div class="massive-glass-card" style="padding:20px; overflow-x:auto; margin-bottom:30px;">
                                    <h3 style="color:#1e293b; margin-bottom:15px; text-align:center;">ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù„ÙƒÙ„ ÙØ±Ø¹</h3>
                                    <table id="matrix-report-table" class="blue-report-table" style="width:100%; text-align:center; font-size:0.8rem;">
                                        <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§ Ø³ÙƒØ±ÙŠØ¨Øª -->
                                    </table>
                                </div>

                                <div class="chart-summary-layout">
                                    <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
                                    <div class="massive-glass-card" style="padding:20px;">
                                        <canvas id="master-reports-canvas" style="height:350px;"></canvas>
                                    </div>

                                    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„ØµØºÙŠØ± -->
                                    <div class="massive-glass-card" style="padding:20px;">
                                        <table id="summary-percentage-table" class="blue-report-table summary-side-table" style="width:100%; text-align:center;">
                                            <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§ Ø³ÙƒØ±ÙŠØ¨Øª -->
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- ADMIN MODULE (UPDATED WITH PRESENCE & LOGS) -->
                            <div id="module-view-admin" class="hidden">
                                
                                <div class="massive-glass-card" style="padding:40px; margin-bottom:40px; border-top: 5px solid var(--success-glow);">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px;">
                                        <h3 style="color:var(--success-glow); font-size:1.8rem; margin:0; display:flex; align-items:center; gap:10px;">
                                            <i class="fas fa-satellite-dish"></i> Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø­ÙŠØ©
                                        </h3>

                                        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ Ù„Ù„Ø±Ø§Ø¯Ø§Ø± -->
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <span style="color:var(--text-muted-core);">Ø¹Ø±Ø¶ ÙØ±Ø¹:</span>
                                            <select id="radar-branch-filter-select" onchange="initPresenceMonitor()" style="width:200px; margin:0; padding:5px 10px;">
                                                <option value="SHOW_ALL">-- Ø§Ù„ÙƒÙ„ --</option>
                                                <option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>
                                                <!-- Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ù‡ØªØ¶Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± -->
                                    <div id="adm-presence-grid" class="presence-grid" style="min-height:100px;">
                                        <!-- Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡ÙŠØ¸Ù‡Ø±ÙˆØ§ Ù‡Ù†Ø§ -->
                                    </div>
                                </div>

                                <div class="massive-glass-card" style="padding:30px; margin-top:30px; border-bottom: 4px solid var(--gold-master);">
                                    <h3 style="color:var(--gold-master); margin-bottom:25px;"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>

                                    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± -->
                                    <div style="display:flex; gap:10px; margin-bottom:20px; flex-direction: row-reverse;">
                                        <input type="text" id="log-search-name" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." style="flex:2; margin:0;" onkeyup="applyLogsFilter()">
                                        <input type="date" id="log-filter-date" style="flex:1; margin:0;" onchange="applyLogsFilter()">
                                        <select id="log-filter-branch" style="flex:1; margin:0;" onchange="applyLogsFilter()">
                                            <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
                                        </select>
                                        <button class="btn-vip-execute-master" style="width:auto; padding:0 20px;" onclick="resetLogsFilter()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
                                    </div>

                                    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
                                    <div style="border: 1px solid rgba(255,255,255,0.1); border-radius:10px; overflow:hidden;">
                                        <div class="log-table-row log-header">
                                            <div>Ø§Ù„Ù…ÙˆØ¸Ù</div>
                                            <div>Ø§Ù„Ø­Ø¯Ø« (ÙØªØ­/Ù‚ÙÙ„)</div>
                                            <div>Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¯Ù‚ÙŠÙ‚</div>
                                            <div>Ø§Ù„ÙØ±Ø¹</div>
                                        </div>
                                        <div id="adm-access-logs-list" class="scrollable-admin-list">
                                            <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                                        </div>
                                    </div>

                                    <button class="btn-vip-execute-master" style="background:var(--danger-pulse); width:auto; margin-top:15px; font-size:0.8rem;" onclick="clearAllSystemLogs()">
                                        <i class="fas fa-trash"></i> ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„
                                    </button>
                                </div>

                                <div class="admin-layout-flex">
                                    <div class="massive-glass-card" style="padding:80px;">
                                        <h3 style="color:var(--gold-master); margin-bottom:60px;">Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙØ±ÙˆØ¹</h3>
                                        <div style="display:flex; gap:25px; margin-bottom:40px;">
                                            <input id="adm-branch-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹">
                                            <button class="btn-vip-execute-master" style="width:180px;" onclick="addSystemBranchCore()">Ø¥Ø¯Ø±Ø§Ø¬</button>
                                        </div>
                                        <div id="adm-branches-scroll-box" class="scrollable-admin-list"></div>
                                        <hr style="margin:50px 0; border-color:var(--border-glow-line);">
                                        <h3 style="color:var(--gold-master); margin-bottom:40px;">ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                                        <select id="adm-whatsapp-br-sel" onchange="renderBranchWhatsappList()"></select>
                                        <div style="display:flex; gap:25px;">
                                            <input id="adm-whatsapp-phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                                            <button class="btn-vip-execute-master" style="width:180px;" onclick="bindNewWhatsappToBranch()">+ Ø±Ø¨Ø·</button>
                                        </div>
                                        <div id="adm-whatsapp-scroll-box" class="scrollable-admin-list" style="margin-top:40px;"></div>
                                    </div>

                                    <div class="massive-glass-card" style="padding:80px;">
                                        <h3 style="color:var(--gold-master); margin-bottom:60px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
                                        <div style="display:flex; gap:25px; margin-bottom:40px;">
                                            <input id="adm-rank-name-input" placeholder="Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                                            <button class="btn-vip-execute-master" style="width:180px;" onclick="registerNewRankTitleCore()">Ø¥Ø¶Ø§ÙØ©</button>
                                        </div>
                                        <select id="adm-rank-matrix-sel" onchange="loadRankPermissionsMatrixHub()"></select>
                                        <div id="adm-permissions-grid-hub" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; background:rgba(0,0,0,0.6); padding:40px; border-radius:20px; margin-top:35px;">
                                            <label><input type="checkbox" id="perm-view-all"> Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø©</label>
                                            <label><input type="checkbox" id="perm-create-ticket"> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§ØºØ§Øª</label>
                                            <label><input type="checkbox" id="perm-reply-ticket"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø¯</label>
                                            <label><input type="checkbox" id="perm-daily-edit"> ØªØ­Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                                            <label><input type="checkbox" id="perm-admin-access"> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                                            <button class="btn-vip-execute-master" style="grid-column: span 2;" onclick="saveRankPermissionsSequence()">ØªØ«Ø¨ÙŠØª</button>
                                        </div>
                                        <hr style="margin:60px 0; border-color:var(--border-glow-line);">
                                        <h3 style="color:var(--gold-master);">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶Ùˆ</h3>
                                        <input id="reg-user-id-core" placeholder="ID">
                                        <input id="reg-user-fullname-core" placeholder="Ø§Ù„Ø§Ø³Ù…">
                                        <select id="reg-user-rank-sel-core"></select>
                                        <select id="reg-user-branch-sel-core"></select>
                                        <input id="reg-user-pass-core" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                                        <button class="btn-vip-execute-master" onclick="registerNewUserToSystemSequence()">ØªÙØ¹ÙŠÙ„</button>
                                        <div id="adm-users-scroll-box" class="scrollable-admin-list" style="margin-top:50px;"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Sidebar Complaint Form -->
                    <div id="sidebar-complaint-arc-hub" class="sidebar-complaint-master">
                        <h2 style="color:var(--gold-master); font-size:3rem; margin-bottom:60px;">ØªØ­Ø±ÙŠØ± Ù…Ø°ÙƒØ±Ø© Ø¨Ù„Ø§Øº CMS</h2>
                        <label>Ø§Ù„ÙØ±Ø¹</label><select id="f-branch-master-sel"></select>
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="f-date-master">
                        <label>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label><input id="f-order-id-input" placeholder="#00000000">
                        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="f-customer-name-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
                        <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                        <select id="f-complaint-type-sel">
                            <option>ØªØ£Ø®ÙŠØ±</option>
                            <option>Ø³ÙˆØ¡ Ø®Ø¯Ù…Ø©</option>
                            <option>Ù†Ø§Ù‚Øµ</option>
                            <option>Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ø©</option>
                            <option>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨</option>
                            <option>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</option>
                            <option>Ø¬ÙˆØ¯Ø©</option>
                            <option>Ø¬Ø³Ù… ØºØ±ÙŠØ¨</option>
                            <option>Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ</option>
                            <option>Ù…Ù†Ø¯ÙˆØ¨</option>
                            <option>Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯</option>
                            <option>Ø±ÙŠØ³ÙŠØ¨ÙŠ</option>
                            <option>ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙŠ</option>
                            <option>ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹</option>
                            <option>Ø³ÙˆØ´ÙŠØ§Ù„</option>
                        </select>
                        <label>Ø§Ù„Ø·ÙŠØ§Ø±</label><input id="f-driver-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±">
                        <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea id="f-complaint-msg-input" rows="8"></textarea>
                        <button class="btn-vip-execute-master" id="submit-complaint-btn" onclick="runComplaintTicketSequence()">ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§Øº ÙÙˆØ±Ø§Ù‹</button>
                    </div>



                    <script>
                        /* 
                        ========================================================================
                        --- INTERNAL CORE LOGIC V47.0 (PRESENCE + LOGS + HOVER UI) --- 
                        ========================================================================
                        */


                        let currentUserSession = null;
                        let complaintsCache = {};
                        let systemSettingsCache = {};
                        let branchListCache = [];
                        let analyticsChartInstance = null;
                        let analyticsTypeChartInstance = null;
                        let allAccessLogsCache = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
                        let isFirstLoad = true;

                    async function runSecurityAuthSequence() {
                        // --- ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„ÙÙƒ Ø­Ø¸Ø± Ø§Ù„ØµÙˆØª ---
                        const audio = document.getElementById("notification-sound");
                        if(audio) {
                            audio.play().then(() => {
                                audio.pause();
                                audio.currentTime = 0;
                            }).catch(e => console.log("Audio permission needed"));
                        }
                        // ----------------------------

                        const uid = document.getElementById('auth-uid-master').value.trim();
                        const pwd = document.getElementById('auth-pwd-master').value.trim();

                        if(!uid || !pwd) { renderSystemToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!", "danger"); return; }

                        // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†
                        if(uid === 'super' && pwd === 'vip2026') {
                            const adminData = { id: 'super', name: 'Super Administrator', title: 'ROOT-COMMAND', branch: 'ALL', role: 'SUPER' };
                            grantCoreAccess(adminData);
                            return;
                        }

                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± (Firebase)
                        const snap = await dbHub.ref('users/' + uid).once('value');
                        const userData = snap.val();

                        if(userData && userData.pass === pwd) {
                            const dataToSave = { id: uid, ...userData, role: 'USER' };
                            grantCoreAccess(dataToSave);
                        } else {
                            Swal.fire('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­', 'error');
                        }
                    }

                        function grantCoreAccess(data) {
                            localStorage.setItem('vip_v43_secure_token', JSON.stringify(data));
                            
                            // === NEW PRESENCE & LOGS LOGIC ===
                            // 1. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙ‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ (ÙØªØ­ ÙˆÙ‚ÙÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹)
                            const presenceRef = dbHub.ref('users_presence/' + data.id);
                            const connectedRef = dbHub.ref('.info/connected');
                            const logsRef = dbHub.ref('access_logs');

                            connectedRef.on('value', (snap) => {
                                if (snap.val() === true) {
                                    // User is Online -> Set State
                                    presenceRef.onDisconnect().update({
                                        state: 'offline',
                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                    });
                                    
                                    // Push Disconnect Log (To happen when they disconnect)
                                    // Note: Firebase queues this on server.
                                    const logDisconnectRef = logsRef.push();
                                    logDisconnectRef.onDisconnect().set({
                                        user: data.name,
                                        uid: data.id,
                                        action: 'ğŸ”´ Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (OFFLINE)',
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    // Set Online Status Now
                                    presenceRef.set({
                                        state: 'online',
                                        name: data.name,
                                        title: data.title,
                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    // Push Login Log Now
                                    logsRef.push({
                                        user: data.name,
                                        uid: data.id,
                                        action: 'ğŸŸ¢ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ONLINE)',
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });
                                }
                            });
                            
                            location.reload();
                        }

                        function runSystemLogoutSequence() {
                            localStorage.removeItem('vip_v43_secure_token');
                            location.reload();
                        }

                        function activateUserPresenceTracking(userData) {
                            if (!userData || !userData.id) return;

                            const presenceRef = dbHub.ref('users_presence/' + userData.id);
                            const logsRef = dbHub.ref('access_logs');
                            const connectedRef = dbHub.ref('.info/connected');

                            connectedRef.on('value', (snap) => {
                                if (snap.val() === true) {
                                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ÙØ±Ø¹
                                    logsRef.push({
                                        uid: userData.id,
                                        user: userData.name,
                                        branch: userData.branch, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù‡Ù†Ø§
                                        action: "ğŸŸ¢ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ONLINE)",
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    const offlineLogRef = logsRef.push();
                                    offlineLogRef.onDisconnect().set({
                                        uid: userData.id,
                                        user: userData.name,
                                        branch: userData.branch, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù‡Ù†Ø§
                                        action: "ğŸ”´ ØºØ§Ø¯Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (OFFLINE)",
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    presenceRef.onDisconnect().update({
                                        state: 'offline',
                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                    });

                                    presenceRef.set({
                                        state: 'online',
                                        name: userData.name,
                                        title: userData.title,
                                        branch: userData.branch, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù‡Ù†Ø§ Ù„Ù„Ø±Ø§Ø¯Ø§Ø±
                                        last_changed: firebase.database.ServerValue.TIMESTAMP
                                    });
                                }
                            });
                        }

                        window.onload = () => {
                            const sess = localStorage.getItem('vip_v43_secure_token');
                            if(sess) {
                                currentUserSession = JSON.parse(sess);
                                document.getElementById('auth-portal-mask').classList.add('hidden');
                                document.getElementById('main-system-viewport').classList.remove('hidden');
                                document.getElementById('ui-user-fullname').innerText = currentUserSession.name;
                                document.getElementById('ui-user-rank-label').innerText = currentUserSession.title;
                                document.getElementById('ui-avatar-orb').innerText = currentUserSession.name.charAt(0);

                                // Ø¶Ø¨Ø· Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                                const todayStr = new Date().toISOString().split('T')[0];
                                const dateInputs = ['daily-master-date-picker', 'archive-date-from', 'archive-date-to', 'reports-date-from', 'reports-date-to', 'f-date-master'];
                                dateInputs.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = todayStr; });

                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
                                branchListCache = JSON.parse(localStorage.getItem('branches') || '[]');
                                systemSettingsCache.custom_ranks = JSON.parse(localStorage.getItem('custom_ranks') || '{}');
                                systemSettingsCache.permissions = JSON.parse(localStorage.getItem('permissions') || '{}');

                                syncUiDropdownSelections();
                                renderAdminBranchScrollBox();
                                renderAdminUsersScrollBox();

                                runPermissionShieldCheck(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

                                initCoreDataListeners(); // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
                            }
                        };

                        async function initPresenceMonitor() {
                            const radarFilter = document.getElementById('radar-branch-filter-select');
                            const selectedBranch = radarFilter ? radarFilter.value : "SHOW_ALL";

                            // 1. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
                            const usersSnap = await dbHub.ref('users').once('value');
                            const allUsers = usersSnap.val() || {};

                            // 2. Ø³Ù…Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ© (Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†)
                            dbHub.ref('users_presence').on('value', snap => {
                                const presenceData = snap.val() || {};
                                const grid = document.getElementById('adm-presence-grid');
                                if(!grid) return;
                                grid.innerHTML = '';

                                // ØªØ­Ø¶ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
                                let userList = [];

                                // Ù†Ù…Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (allUsers)
                                Object.keys(allUsers).forEach(uid => {
                                    const user = allUsers[uid];

                                    // ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹
                                    if (selectedBranch === "SHOW_ALL" || user.branch === selectedBranch) {
                                        // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙ‡ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ§Ø¬Ø¯
                                        const presenceInfo = presenceData[uid] || {};
                                        const isOnline = presenceInfo.state === 'online';

                                        userList.push({
                                            uid: uid,
                                            name: user.name,
                                            branch: user.branch,
                                            rank: user.title,
                                            isOnline: isOnline
                                        });
                                    }
                                });

                                if (userList.length === 0) {
                                    grid.innerHTML = `<div style="color:var(--text-muted-core); padding:20px; text-align:center; width:100%;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</div>`;
                                    return;
                                }

                                // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£ÙˆÙ„
                                userList.sort((a, b) => b.isOnline - a.isOnline);

                                // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆØ£ÙˆÙÙ„Ø§ÙŠÙ†)
                                userList.forEach(u => {
                                    grid.innerHTML += `
                                        <div class="presence-user-orb ${u.isOnline ? 'orb-online' : 'orb-offline'}"
                                            style="opacity: ${u.isOnline ? '1' : '0.5'};"
                                            onclick="viewUserProfileActivity('${u.uid}', '${u.name}')">
                                            <div class="avatar-ring" style="border-color: ${u.isOnline ? '#39d353' : '#484f58'}">
                                                ${u.name ? u.name.charAt(0) : '?'}
                                                <div class="status-indicator" style="background: ${u.isOnline ? '#39d353' : '#484f58'}"></div>
                                            </div>
                                            <div class="user-name-label" style="color: ${u.isOnline ? '#fff' : '#8b949e'}">${u.name}</div>
                                            <div style="font-size:0.7rem; color:var(--gold-master); opacity:0.8;">${u.rank || ''}</div>
                                        </div>`;
                                });
                            });
                        }

                        function applyLogsFilter() {
                            // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙÙ„ØªØ±
                            const searchName = document.getElementById('log-search-name').value.toLowerCase();
                            const filterDate = document.getElementById('log-filter-date').value;
                            const filterBranch = document.getElementById('log-filter-branch').value;
                            const list = document.getElementById('adm-access-logs-list');

                            if(!list) return;
                            list.innerHTML = '';

                            // ØªØµÙÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù€ 3
                            const filtered = allAccessLogsCache.filter(log => {
                                const matchesName = log.user.toLowerCase().includes(searchName);

                                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ timestamp Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-dd Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                                const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                                const matchesDate = filterDate ? (logDate === filterDate) : true;

                                // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØ±Ø¹ (Ù„Ùˆ "ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹" ÙŠØ¨Ù‚Ù‰ ÙØ§Ø¶ÙŠ ÙˆÙŠØ¹Ø¯ÙŠ Ø§Ù„ÙƒÙ„)
                                const matchesBranch = (filterBranch === "" || filterBranch === "ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹") ? true : (log.branch === filterBranch);

                                return matchesName && matchesDate && matchesBranch;
                            });

                            if (filtered.length === 0) {
                                list.innerHTML = `<div style="text-align:center; padding:50px; color:var(--text-muted-core);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</div>`;
                                return;
                            }

                            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                            filtered.forEach(log => {
                                const d = new Date(log.timestamp);
                                const timeStr = d.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                                const isOnline = log.action.includes('ONLINE') || log.action.includes('ÙØªØ­');

                                list.innerHTML += `
                                    <div class="log-table-row">
                                        <div style="font-weight:600;">${log.user}</div>
                                        <div style="color:${isOnline ? 'var(--success-glow)' : '#ef4444'}">
                                            <i class="fas ${isOnline ? 'fa-sign-in-alt' : 'fa-sign-out-alt'}"></i> ${log.action}
                                        </div>
                                        <div style="direction:ltr; font-family:monospace; font-size:0.85rem;">${timeStr}</div>
                                        <div style="color:var(--gold-master);">${log.branch || '---'}</div>
                                    </div>`;
                            });
                        }

                        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· (Ø²Ø± "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·")
                        function resetLogsFilter() {
                            document.getElementById('log-search-name').value = '';
                            document.getElementById('log-filter-date').value = '';
                            document.getElementById('log-filter-branch').value = '';
                            applyLogsFilter(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­
                        }

                        // === ÙˆØ¸ÙŠÙØ© Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù (Ø¹Ø±Ø¶ Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡) ===
                        async function viewUserProfileActivity(uid, userName) {
                            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                            // Ø¬Ù„Ø¨ Ø¢Ø®Ø± 50 Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                            const snap = await dbHub.ref('access_logs').orderByChild('uid').equalTo(uid).limitToLast(50).once('value');
                            const logsData = snap.val();
                            
                            let timelineHtml = `<div style="text-align:right; max-height:400px; overflow-y:auto; padding:10px; direction:rtl;">`;
                            
                            if(!logsData) {
                                timelineHtml += `<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù†Ø´Ø§Ø· Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø¹Ø¯.</p>`;
                            } else {
                                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù…ØµÙÙˆÙØ© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
                                const sortedLogs = Object.values(logsData).sort((a, b) => b.timestamp - a.timestamp);
                                
                                sortedLogs.forEach(l => {
                                    const dateObj = new Date(l.timestamp);
                                    const time = dateObj.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                                    const date = dateObj.toLocaleDateString('ar-EG');
                                    const isOnline = l.action.includes('ONLINE');
                                    
                                    timelineHtml += `
                                        <div style="border-bottom:1px solid #30363d; padding:12px 0; display:flex; justify-content:space-between; align-items:center;">
                                            <div>
                                                <span style="color:${isOnline ? '#39d353' : '#f85149'}; font-size:1.1rem; margin-left:10px;">
                                                    ${isOnline ? 'â—' : 'â—'}
                                                </span>
                                                <b style="color:#f0f6fc;">${l.action.split('(')[0]}</b>
                                            </div>
                                            <div style="text-align:left;">
                                                <div style="font-size:0.85rem; color:#f0f6fc;">${time}</div>
                                                <div style="font-size:0.7rem; color:#8b949e;">${date}</div>
                                            </div>
                                        </div>`;
                                });
                            }
                            timelineHtml += `</div>`;

                            Swal.fire({
                                title: `<span style="color:#f59e0b">Ù…Ù„Ù Ù†Ø´Ø§Ø·: ${userName}</span>`,
                                html: timelineHtml,
                                confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
                                confirmButtonColor: '#21262d',
                                background: '#0d1117',
                                color: '#f0f6fc',
                                width: '450px'
                            });
                        }

                        function checkForNewComplaintsAndPlaySound(newOps) {
                            let triggered = false;

                            // 1. Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† Ù…Ù† Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„ØµÙˆØªÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
                            if (currentUserSession.role === 'SUPER') return;

                            // 2. Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù…ÙˆØ¸ÙÙŠ Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ø°ÙŠÙ† ÙØ±Ø¹Ù‡Ù… ALL) Ù…Ù† Ø§Ù„Ø¥Ù†Ø°Ø§Ø±
                            if (currentUserSession.branch === 'ALL') return;

                            Object.keys(newOps).forEach(id => {
                                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ§Ø´)
                                if (!complaintsCache[id]) {
                                    const ticket = newOps[id];

                                    // 3. Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙŠØ´ØªØºÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ±Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø·Ø§Ø¨Ù‚ Ù„ÙØ±Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº
                                    if (currentUserSession.branch === ticket.branch) {
                                        triggered = true;
                                    }
                                }
                            });

                            if (triggered) {
                                triggerRedAlarm(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„ØµÙˆØª
                            }
                        }

                        // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±
                        function triggerRedAlarm() {
                            const overlay = document.getElementById('red-alarm-overlay');
                            const audio = document.getElementById('notification-sound');

                            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
                            overlay.classList.remove('hidden');
                            overlay.style.display = 'flex'; // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±

                            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø± (Loop)
                            if (audio) {
                                audio.loop = true; // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
                                audio.currentTime = 0;
                                audio.play().catch(e => console.log("User interaction needed for audio"));
                            }
                        }

                        // Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ù†Ø°Ø§Ø± (Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø²Ø±)
                        function stopAlarmAndShowTicket() {
                            const overlay = document.getElementById('red-alarm-overlay');
                            const audio = document.getElementById('notification-sound');

                            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
                            overlay.classList.add('hidden');
                            overlay.style.display = 'none';

                            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
                            if (audio) {
                                audio.pause();
                                audio.currentTime = 0;
                                audio.loop = false; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙƒØ±Ø§Ø±
                            }

                            // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                            switchToAppModule('live');
                            // Ø¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }

                        function playNotificationSound() {
                            const audio = document.getElementById("notification-sound");
                            if (audio) {
                                audio.currentTime = 0; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØª Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
                                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØªØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
                                const playPromise = audio.play();
                                if (playPromise !== undefined) {
                                    playPromise.catch(error => {
                                        console.log("Auto-play was prevented by browser logic.");
                                    });
                                }
                            }
                        }

                        function initCoreDataListeners() {
                            console.log("Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...");

                            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø±ØªØ¨)
                            dbHub.ref('settings').on('value', snap => {
                                systemSettingsCache = snap.val() || {};
                                branchListCache = systemSettingsCache.branches ? Object.values(systemSettingsCache.branches) : [];
                                syncUiDropdownSelections();
                                renderAdminBranchScrollBox();
                                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ÙØ±ÙˆØ¹");
                            });

                            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ (Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)
                            dbHub.ref('operations').on('value', snap => {
                                const newOperations = snap.val() || {};
                                complaintsCache = newOperations;
                                
                                console.log("ÙˆØµÙ„Øª Ø´ÙƒØ§ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¯Ø¯Ù‡Ø§: " + Object.keys(newOperations).length);
                                
                                // Ø±Ø³Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹
                                renderLiveBroadcastMatrix();
                                runArchiveRefreshSequence();
                            }, error => {
                                console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰:", error);
                            });
                        }

                        async function loadDailySnapshotData() {
                            const dateStr = document.getElementById('daily-master-date-picker').value;
                            const gridBox = document.getElementById('render-daily-grid-hub');

                            if (!gridBox) return;
                            gridBox.innerHTML = `<h2 style="grid-column:1/-1;text-align:center;padding:100px; color:var(--gold-master);">Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨...</h2>`;

                            try {
                                // Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ²
                                const dSnap = await dbHub.ref(`daily_stats/${dateStr}`).get();
                                const dailyData = dSnap.val() || {};

                                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙØ±ÙˆØ¹
                                if (branchListCache.length === 0) {
                                    gridBox.innerHTML = `<h2 style="grid-column:1/-1;text-align:center;padding:100px;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ù…Ø³Ø¬Ù„Ø©. Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ£Ø¶Ù Ø§Ù„ÙØ±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹.</h2>`;
                                    return;
                                }

                                gridBox.innerHTML = "";
                                const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                                const canEdit = p.daily_edit || currentUserSession.role === 'SUPER';
                                const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

                                branchListCache.forEach(branch => {
                                    if(!canSeeAll && branch !== currentUserSession.branch) return;
                                    gridBox.innerHTML += `
                                        <div class="massive-glass-card branch-data-card">
                                            <h4 style="font-size:2.5rem;">${branch}</h4>
                                            <input type="number" class="massive-daily-input"
                                                   value="${dailyData[branch] || 0}"
                                                   ${canEdit ? '' : 'disabled'}
                                                   onchange="commitDailyOrderValue('${dateStr}','${branch}',this.value)">
                                            <div style="margin-top:20px;color:var(--text-muted-core);">Ø£ÙˆØ±Ø¯Ø±Ø§Øª ${dateStr}</div>
                                        </div>`;
                                });
                            } catch (error) {
                                gridBox.innerHTML = `<h2 style="color:red; text-align:center;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}</h2>`;
                            }
                        }

                        async function commitDailyOrderValue(date, br, val) {
                            if(val < 0) { renderSystemToast("Ø®Ø·Ø£: Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø©", "danger"); return; }
                            await dbHub.ref(`daily_stats/${date}/${br}`).set(val);
                            renderSystemToast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "success");
                        }

                        async function runComplaintTicketSequence() {
                            const br = document.getElementById('f-branch-master-sel').value;
                            const ord = document.getElementById('f-order-id-input').value.trim();
                            const cust = document.getElementById('f-customer-name-input').value.trim();
                            const type = document.getElementById('f-complaint-type-sel').value;
                            const drv = document.getElementById('f-driver-name-input').value.trim();
                            const msg = document.getElementById('f-complaint-msg-input').value.trim();
                            if(!ord || !cust || !msg) { Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'warning'); return; }
                            const timeNow = new Date().toLocaleTimeString('ar-EG');
                            const selectedDate = document.getElementById('f-date-master').value;
                            const ticketData = {
                                branch: br, order: ord, customer: cust, type: type, msg: msg, driver: drv,
                                stage: 'waiting_review', status: 'active',
                                timestamp: new Date().toLocaleString('ar-EG'), timeOnly: timeNow, date: selectedDate,
                                author: currentUserSession.name,
                                logs: [{ time: timeNow, user: currentUserSession.name, action: "Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº" }]
                            };
                            await dbHub.ref('operations').push(ticketData);
                            triggerBranchBroadcast(br, ord, cust, type, msg, timeNow);
                            closeSidebarControl();
                            renderSystemToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "success");
                            ['f-order-id-input','f-customer-name-input','f-complaint-msg-input','f-driver-name-input'].forEach(id => document.getElementById(id).value = '');
                        }

                        async function triggerBranchBroadcast(br, ord, cust, type, msg, time) {
                            const pList = Object.values((systemSettingsCache.phones && systemSettingsCache.phones[br]) || {});
                            if(pList.length === 0) return;
                            const text = `ğŸš¨ *Ø¨Ù„Ø§Øº CMS Ø¬Ø¯ÙŠØ¯* ğŸš¨\n\nğŸ“ Ø§Ù„ÙØ±Ø¹: ${br}\nâ° ${time}\nğŸ”¢ Ø§Ù„Ø·Ù„Ø¨: ${ord}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${cust}\nğŸ·ï¸ ${type}\nğŸ“ ${msg}\nğŸ‘· Ø§Ù„Ù…ØªÙ„Ù‚ÙŠ: ${currentUserSession.name}`;
                            pList.forEach(ph => {
                                fetch(`https://api.ultramsg.com/instance157671/messages/chat`, {
                                    method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                    body: new URLSearchParams({'token': 'cpx85mx613v868fe', 'to': ph, 'body': text})
                                });
                            });
                        }

                        function renderLiveBroadcastMatrix() {
                            const box = document.getElementById('render-live-feed-matrix'); box.innerHTML = "";
                            const selectedBranch = document.getElementById('global-branch-filter').value;
                            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';
                            Object.keys(complaintsCache).reverse().forEach(id => {
                                const op = complaintsCache[id];
                                if(op.status === 'done') return;
                                if(!canSeeAll && op.branch !== currentUserSession.branch) return;
                                // Ø´Ø±Ø· Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
                                if(selectedBranch !== 'ALL' && op.branch !== selectedBranch) return;
                                box.innerHTML += generateTicketMarkup(id, op, true, p);
                            });
                        }

                        function runArchiveRefreshSequence() {
                            const box = document.getElementById('render-archive-grid-hub'); if(!box) return; box.innerHTML = "";
                            const from = document.getElementById('archive-date-from').value;
                            const to = document.getElementById('archive-date-to').value;
                            const selectedBranch = document.getElementById('global-branch-filter').value;
                            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';
                            Object.keys(complaintsCache).reverse().forEach(id => {
                                const op = complaintsCache[id];
                                if(op.status !== 'done') return;
                                if(!canSeeAll && op.branch !== currentUserSession.branch) return;
                                if(op.date < from || op.date > to) return;
                                // Ø´Ø±Ø· Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
                                if(selectedBranch !== 'ALL' && op.branch !== selectedBranch) return;
                                box.innerHTML += generateTicketMarkup(id, op, false, p);
                            });
                        }

                        // === UPDATED TICKET MARKUP FOR HOVER REVEAL ===
                        function generateTicketMarkup(id, op, isInteractive, p) {
                            let btns = "";
                            if(isInteractive) {
                                if(op.stage === 'waiting_review' && (p.reply_ticket || currentUserSession.role === 'SUPER')) {
                                    btns = `<button class="btn-vip-execute-master" style="background:var(--success-glow); color:#000;" onclick="event.stopPropagation(); openBranchReplyModalHub('${id}')">Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>`;
                                } else if(op.stage === 'replied' && currentUserSession.role === 'SUPER') {
                                    btns = `<button class="btn-vip-execute-master" style="background:var(--success-glow);" onclick="event.stopPropagation(); finalizeTicketAndArchive('${id}')">Ø¥ØºÙ„Ø§Ù‚ (Ø³Ù„ÙŠÙ…)</button>
                                            <button class="btn-vip-execute-master" style="background:var(--danger-pulse);" onclick="event.stopPropagation(); sendToBranchManagerFromCallCenter('${id}')">Ù„Ù„Ù…Ø¯ÙŠØ±</button>`;
                                } else if(op.stage === 'sent_to_branch_manager' && currentUserSession.title === 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹') {
                                    btns = `<button class="btn-vip-execute-master" onclick="event.stopPropagation(); openBranchManagerReplyModalHub('${id}')">Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±</button>`;
                                } else if(op.stage === 'sent_back_to_call_center' && currentUserSession.role === 'SUPER') {
                                    btns = `<button class="btn-vip-execute-master" style="background:var(--success-glow);" onclick="event.stopPropagation(); finalizeTicketAndArchive('${id}')">Ø¥ØºÙ„Ø§Ù‚ (Ø³Ù„ÙŠÙ…)</button>
                                            <button class="btn-vip-execute-master" onclick="event.stopPropagation(); sendToRegionalManager('${id}')">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ù†Ø·Ù‚Ø©</button>`;
                                } else if(op.stage === 'sent_to_regional_manager' && currentUserSession.title === 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©') {
                                    btns = `<button class="btn-vip-execute-master" onclick="event.stopPropagation(); openRegionalManagerReplyModalHub('${id}')">Ø±Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>`;
                                } else if(op.stage === 'sent_to_regional_manager' && currentUserSession.role === 'SUPER') {
                                    btns = `<button class="btn-vip-execute-master" onclick="event.stopPropagation(); finalizeTicketAndArchive('${id}')">Ø¥ØºÙ„Ø§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ</button>`;
                                }
                            }

                            if(currentUserSession.role === 'SUPER') btns += `<button class="btn-vip-execute-master" style="background:var(--danger-pulse); margin-top:5px;" onclick="event.stopPropagation(); deleteTicketRecord('${id}')">Ø­Ø°Ù</button>`;

                            const logs = op.logs ? op.logs.map(l => `<div style="font-size:0.8rem; color:#8b949e;">â€¢ ${l.user}: ${l.action}</div>`).join('') : '';

                            return `
                                <div class="massive-glass-card ticket-visual-unit" onclick="this.classList.toggle('is-fixed')">
                                    <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ -->
                                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                        <div>
                                            <b style="color:var(--gold-master); font-size:1.1rem;">ğŸ“ ${op.branch || 'ÙØ±Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</b>
                                            <div style="font-size:0.75rem; color:#8b949e;">${op.date || ''} ${op.timeOnly || ''}</div>
                                        </div>
                                        <div style="text-align:left;">
                                            <span style="color:var(--gold-master); font-size:0.8rem;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span>
                                            <div class="order-number-badge">#${op.order || '000'}</div>
                                        </div>
                                    </div>

                                    <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø®ÙÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø£Ùˆ Ø§Ù„Ù‡Ø§ÙØ± -->
                                    <div class="ticket-hidden-details">
                                        <div style="margin-bottom:10px;">
                                            <div style="font-weight:bold; color:#fff;">ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${op.customer}</div>
                                            <div style="color:var(--danger-pulse);">ğŸ·ï¸ Ø§Ù„Ù†ÙˆØ¹: ${op.type}</div>
                                            <div style="color:var(--success-glow);">ğŸ‘¨â€âœˆï¸ Ø§Ù„Ø·ÙŠØ§Ø±: ${op.driver || '---'}</div>
                                        </div>
                                        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:5px; margin-bottom:10px; font-size:0.9rem;">
                                            ğŸ“ ${op.msg}
                                        </div>
                                        <div style="border-top:1px solid #333; padding-top:5px; margin-bottom:10px;">
                                            ${logs}
                                        </div>
                                        <div style="display:grid; grid-template-columns:1fr; gap:5px;">
                                            ${btns}
                                        </div>
                                    </div>

                                    <div style="position:absolute; bottom:5px; left:50%; transform:translateX(-50%); font-size:0.7rem; color:#444;">
                                        Ø¥Ø¶ØºØ· Ù„Ù„ØªØ«Ø¨ÙŠØª
                                    </div>
                                </div>`;
                        }

                        async function executeAdvancedAnalyticsSequence() {
                            const from = document.getElementById('reports-date-from').value;
                            const to = document.getElementById('reports-date-to').value;
                            if (!from || !to) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹', 'warning');

                            const dSnap = await dbHub.ref('daily_stats').get();
                            const allOrders = dSnap.val() || {};
                            const ops = Object.values(complaintsCache).filter(o => o.date >= from && o.date <= to);

                            // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                            const types = ["ØªØ£Ø®ÙŠØ±", "Ø³ÙˆØ¡ Ø®Ø¯Ù…Ø©", "Ù†Ø§Ù‚Øµ", "Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ø©", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ", "Ø¬ÙˆØ¯Ø©", "Ø¬Ø³Ù… ØºØ±ÙŠØ¨", "Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ", "Ù…Ù†Ø¯ÙˆØ¨", "Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯", "Ø±ÙŠØ³ÙŠØ¨ÙŠ", "ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙŠ", "ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹", "Ø³ÙˆØ´ÙŠØ§Ù„"];
                            const branches = branchListCache;

                            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø±
                            let tableHtml = `
                                <table class="report-blue-table">
                                <thead>
                                    <tr>
                                        <th rowspan="1">Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                                        ${types.map(t => `<th>${t}</th>`).join('')}
                                        <th class="total-column">Ø§Ø¬Ù…Ø§Ù„ÙŠ TA</th>
                                        <th class="total-column">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ PK</th>
                                        <th class="total-column">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Din In</th>
                                        <th class="total-column">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ HD</th>
                                        <th class="total-column">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                            let grandTotals = Array(types.length + 5).fill(0);

                            branches.forEach(br => {
                                let brOps = ops.filter(o => o.branch === br);
                                let counts = types.map(t => brOps.filter(o => o.type === t).length);

                                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
                                let socialCount = brOps.filter(o => o.type === "Ø³ÙˆØ´ÙŠØ§Ù„").length;
                                let branchContactCount = brOps.filter(o => o.type === "ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹").length;

                                let taTotal = socialCount + branchContactCount;
                                let pkTotal = 0; // Ø§ÙØªØ±Ø§Ø¶ÙŠ 0 Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø§ØªØ§
                                let dinTotal = 0; // Ø§ÙØªØ±Ø§Ø¶ÙŠ 0
                                let grandTotal = brOps.length;
                                let hdTotal = grandTotal - taTotal; // Ø§Ù„Ø¨Ø§Ù‚ÙŠ HD

                                tableHtml += `<tr>
                                    <td style="background:#f8fafc; font-weight:800; text-align:right;">${br}</td>
                                    ${counts.map(c => `<td>${c}</td>`).join('')}
                                    <td class="sub-total-column">${taTotal}</td>
                                    <td class="sub-total-column">${pkTotal}</td>
                                    <td class="sub-total-column">${dinTotal}</td>
                                    <td class="sub-total-column">${hdTotal}</td>
                                    <td class="total-column">${grandTotal}</td>
                                </tr>`;

                                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù„Ù„Ø³ÙÙ„ÙŠ
                                counts.forEach((c, i) => grandTotals[i] += c);
                                grandTotals[types.length] += taTotal;
                                grandTotals[types.length+1] += pkTotal;
                                grandTotals[types.length+2] += dinTotal;
                                grandTotals[types.length+3] += hdTotal;
                                grandTotals[types.length+4] += grandTotal;
                            });

                            // Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                            tableHtml += `<tr style="background:#cbd5e1; font-weight:900;">
                                <td>Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</td>
                                ${grandTotals.map(gt => `<td>${gt}</td>`).join('')}
                            </tr></tbody></table>`;

                            document.getElementById('matrix-report-table').innerHTML = tableHtml;

                            // --- ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„ØµØºÙŠØ± ---
                            renderSummaryPercentageTable(allOrders, ops, from, to);

                            // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ---
                            renderAnalyticsChart(allOrders, ops, from, to);
                        }

                        function renderSummaryPercentageTable(allOrders, ops, from, to) {
                            let html = `
                                <table class="report-blue-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                                        <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                                        <th>Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</th>
                                        <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                            let totalOrd = 0, totalComp = 0;
                            branchListCache.forEach(br => {
                                let brOrders = 0;
                                Object.keys(allOrders).forEach(d => { if(d >= from && d <= to) brOrders += parseInt(allOrders[d][br] || 0); });
                                let brComp = ops.filter(o => o.branch === br).length;
                                let perc = brOrders > 0 ? ((brComp/brOrders)*100).toFixed(2) : 0;

                                html += `<tr><td>${br}</td><td>${brOrders}</td><td>${brComp}</td><td style="background:#dbeafe">${perc}%</td></tr>`;
                                totalOrd += brOrders; totalComp += brComp;
                            });

                            let totalPerc = totalOrd > 0 ? ((totalComp/totalOrd)*100).toFixed(2) : 0;
                            html += `<tr style="background:#2563eb; color:white;"><td>Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</td><td>${totalOrd}</td><td>${totalComp}</td><td>${totalPerc}%</td></tr></tbody></table>`;
                            document.getElementById('summary-percentage-table').innerHTML = html;
                        }

                        function renderAnalyticsChart(allOrders, ops, from, to) {
                            const ctx = document.getElementById('master-reports-canvas').getContext('2d');
                            const labels = branchListCache;
                            const data = branchListCache.map(br => {
                                let brOrders = 0;
                                Object.keys(allOrders).forEach(d => { if(d >= from && d <= to) brOrders += parseInt(allOrders[d][br] || 0); });
                                let brComp = ops.filter(o => o.branch === br).length;
                                return brOrders > 0 ? ((brComp/brOrders)*100).toFixed(2) : 0;
                            });

                            if(analyticsChartInstance) analyticsChartInstance.destroy();
                            analyticsChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ %',
                                        data: data,
                                        backgroundColor: '#2563eb', // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚
                                        borderColor: '#1e40af',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        datalabels: {
                                            anchor: 'end',
                                            align: 'top',
                                            formatter: (v) => v + '%',
                                            color: '#1e293b',
                                            font: { weight: 'bold' }
                                        }
                                    },
                                    scales: {
                                        y: { beginAtZero: true, grid: { color: '#e2e8f0' } }
                                    }
                                },
                                plugins: [ChartDataLabels]
                            });
                        }

                        function updateAnalyticsCharts(ops, selectedBranch, allDays, from, to) {
                            // 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ ÙØ±Ø¹ Ø¹Ù„Ù‰ Ø­Ø¯Ø©)
                            const labels = [];
                            const branchRates = [];

                            const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                            const canSeeAll = p.view_all || currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER';

                            branchListCache.forEach(br => {
                                if(!canSeeAll && br !== currentUserSession.branch) return;

                                labels.push(br);
                                const brComplaints = ops.filter(o => o.branch === br).length;
                                let brOrders = 0;

                                Object.keys(allDays).forEach(day => {
                                    if(day >= from && day <= to && allDays[day][br]) {
                                        brOrders += parseInt(allDays[day][br]);
                                    }
                                });

                                // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø·Ø£ Ù„ÙƒÙ„ ÙØ±Ø¹
                                let rate = brOrders > 0 ? ((brComplaints / brOrders) * 100).toFixed(2) : 0;
                                branchRates.push(rate);
                            });

                            // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)
                            if(analyticsChartInstance) analyticsChartInstance.destroy();
                            analyticsChartInstance = new Chart(document.getElementById('master-reports-canvas').getContext('2d'), {
                                type: 'bar',
                                plugins: [ChartDataLabels],
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ % (Ø´ÙƒØ§ÙˆÙ‰/Ø£ÙˆØ±Ø¯Ø±Ø§Øª)',
                                        data: branchRates,
                                        backgroundColor: '#f59e0b',
                                        borderRadius: 8
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: { beginAtZero: true, ticks: { color: '#fff' }, title: {display:true, text:'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© %', color:'#fff'} },
                                        x: { ticks: { color: '#fff' } }
                                    },
                                    plugins: {
                                        legend: { labels: { color: '#fff' } },
                                        datalabels: {
                                            color: '#fff',
                                            anchor: 'end',
                                            align: 'top',
                                            formatter: (v) => v + '%'
                                        }
                                    }
                                }
                            });

                            // 8. ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©)
                            const typeCounts = {};
                            ops.forEach(o => { typeCounts[o.type || 'Ø£Ø®Ø±Ù‰'] = (typeCounts[o.type || 'Ø£Ø®Ø±Ù‰'] || 0) + 1; });

                            if(analyticsTypeChartInstance) analyticsTypeChartInstance.destroy();
                            analyticsTypeChartInstance = new Chart(document.getElementById('master-types-canvas').getContext('2d'), {
                                type: 'doughnut',
                                plugins: [ChartDataLabels],
                                data: {
                                    labels: Object.keys(typeCounts),
                                    datasets: [{
                                        data: Object.values(typeCounts),
                                        backgroundColor: ['#f59e0b','#ef4444','#10b981','#1d4ed8','#8b5cf6'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: { position: 'bottom', labels: { color: '#fff' } },
                                        datalabels: { color: '#000', backgroundColor: '#fff', borderRadius: 4, font: {weight:'bold'} }
                                    }
                                }
                            });
                        }

                        async function exportReportsToExcel() {
                            const fromDate = document.getElementById('reports-date-from').value;
                            const toDate = document.getElementById('reports-date-to').value;

                            if (!fromDate || !toDate) {
                                return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'warning');
                            }

                            renderSystemToast("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ...", "success");

                            // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© (ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±)
                            const workbook = new ExcelJS.Workbook();
                            const worksheet = workbook.addWorksheet('CMS Report', {
                                views: [{ rightToLeft: true }]
                            });

                            // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            const dSnap = await dbHub.ref('daily_stats').get();
                            const allOrders = dSnap.val() || {};
                            const ops = Object.values(complaintsCache).filter(o => o.date >= fromDate && o.date <= toDate);

                            const complaintTypes = ["ØªØ£Ø®ÙŠØ±", "Ø³ÙˆØ¡ Ø®Ø¯Ù…Ù‡", "Ù†Ø§Ù‚Øµ", "Ø³ÙˆØ¡ ØªØ¹Ø¨Ø¦Ù‡", "Ø®Ø·Ø£ ÙÙ‰ Ø§Ù„Ø·Ù„Ø¨", "Ø®Ø·Ø£ ÙÙ‰ Ø§Ù„Ø¨Ø§Ù‚Ù‰", "Ø¬ÙˆØ¯Ù‡", "Ø¬Ø³Ù… ØºØ±ÙŠØ¨", "Ø³ÙˆØ¡ Ø³Ù„ÙˆÙƒ", "Ù…Ù†Ø¯ÙˆØ¨", "Ø·Ù„Ø¨ Ø¨Ø§Ø±Ø¯", "Ø±Ø³Ø¨ÙŠ", "ØªØ£Ø®ÙŠØ± Ø´ÙƒÙˆÙŠ", "ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹", "Ø³ÙˆØ´ÙŠØ§Ù„"];

                            // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ¨ÙŠØ± (Ø§Ù„Ø£Ø²Ø±Ù‚)
                            const headerRow1 = ["Ø§Ù„Ù…Ø·Ø¹Ù…", ...complaintTypes, "Ø§Ø¬Ù…Ø§Ù„ÙŠ TA", "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ PK", "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Din In", "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ HD", "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø¹Ù…"];
                            const headerRow = worksheet.addRow(headerRow1);

                            // ØªÙ†Ø³ÙŠÙ‚ Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ ÙˆØ®Ø· Ø£Ø¨ÙŠØ¶)
                            headerRow.eachCell((cell) => {
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1E4B8B' } };
                                cell.font = { color: { argb: 'FFFFFF' }, bold: true, size: 10 };
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                            });

                            let grandTotals = Array(headerRow1.length).fill(0);

                            branchListCache.forEach(br => {
                                const brOps = ops.filter(o => o.branch === br);
                                const getC = (t) => brOps.filter(o => o.type === t).length;

                                const taTotal = getC("Ø³ÙˆØ´ÙŠØ§Ù„") + getC("ØªÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„ÙØ±Ø¹");
                                const restaurantTotal = brOps.length;
                                const hdTotal = restaurantTotal - taTotal;

                                const rowData = [br];
                                complaintTypes.forEach(t => rowData.push(getC(t)));
                                rowData.push(taTotal, 0, 0, hdTotal, restaurantTotal);

                                const row = worksheet.addRow(rowData);
                                row.eachCell(cell => {
                                    cell.alignment = { horizontal: 'center' };
                                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                                });

                                for (let i = 1; i < rowData.length; i++) grandTotals[i] += rowData[i];
                            });

                            // Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ) Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø©
                            const footerRow1 = worksheet.addRow(["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ", ...grandTotals.slice(1)]);
                            footerRow1.eachCell((cell) => {
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D9E1F2' } }; // Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­
                                cell.font = { bold: true };
                                cell.alignment = { horizontal: 'center' };
                                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                            });

                            // 4. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (ØµÙˆØ±Ø©)
                            const canvas = document.getElementById('master-reports-canvas');
                            if (canvas) {
                                const chartImage = canvas.toDataURL('image/png');
                                const imageId = workbook.addImage({
                                    base64: chartImage,
                                    extension: 'png',
                                });
                                worksheet.addImage(imageId, {
                                    tl: { col: 1, row: worksheet.rowCount + 2 },
                                    ext: { width: 650, height: 350 }
                                });
                            }

                            // 5. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± (Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø£Ùˆ ØªØ­ØªÙ‡)
                            const startRowTable2 = worksheet.rowCount + 20; // ØªØ±Ùƒ Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ

                            const table2Title = worksheet.addRow([]);
                            table2Title.getCell(1).value = "Ù†Ø³Ø¨Ø© Ø´ÙƒØ§ÙˆÙ‰ Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„ÙØ±ÙˆØ¹";
                            worksheet.mergeCells(startRowTable2 + 1, 1, startRowTable2 + 1, 4);
                            table2Title.getCell(1).font = { bold: true, size: 12 };
                            table2Title.getCell(1).alignment = { horizontal: 'center' };

                            const headerRow2 = worksheet.addRow(["Ø§Ù„Ù…Ø·Ø¹Ù…", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰", "Ø§Ù„Ù†Ø³Ø¨Ø©"]);
                            headerRow2.eachCell(cell => {
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1E4B8B' } };
                                cell.font = { color: { argb: 'FFFFFF' }, bold: true };
                                cell.alignment = { horizontal: 'center' };
                            });

                            let totalOps = 0, totalComps = 0;
                            branchListCache.forEach(br => {
                                let brOrders = 0;
                                Object.keys(allOrders).forEach(d => { if (d >= fromDate && d <= toDate) brOrders += parseInt(allOrders[d][br] || 0); });
                                const brCompCount = ops.filter(o => o.branch === br).length;
                                const perc = brOrders > 0 ? ((brCompCount / brOrders) * 100).toFixed(2) + "%" : "0.00%";

                                const row = worksheet.addRow([br, brOrders, brCompCount, perc]);
                                row.eachCell(c => c.alignment = { horizontal: 'center' });
                                totalOps += brOrders; totalComps += brCompCount;
                            });

                            const finalPerc = totalOps > 0 ? ((totalComps / totalOps) * 100).toFixed(2) + "%" : "0.00%";
                            const footer2 = worksheet.addRow(["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ", totalOps, totalComps, finalPerc]);
                            footer2.eachCell(c => { c.font = { bold: true }; c.alignment = { horizontal: 'center' }; });

                            // Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            worksheet.columns.forEach(column => { column.width = 14; });

                            // 6. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                            const buffer = await workbook.xlsx.writeBuffer();
                            saveAs(new Blob([buffer]), `CMS_Full_Report_${fromDate}.xlsx`);
                        }


                        // Ticket Action Modals
                        async function openBranchReplyModalHub(id) {
                            const {value:r} = await Swal.fire({ title:'Ø±Ø¯ Ø§Ù„ÙØ±Ø¹', html:`<select id="s1" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option></select><textarea id="s2" class="swal2-input" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                            if(r) {
                                const op = complaintsCache[id], log={time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:r[0]==='Ù†Ø§Ù‚Øµ'?'Ø§Ø¹ØªØ±Ø§Ù Ø¨Ø§Ù„Ù†Ù‚Øµ':'Ø§Ù„Ø·Ù„Ø¨ Ø³Ù„ÙŠÙ…'};
                                await dbHub.ref('operations/'+id).update({ stage:'replied', branch_verdict:r[0], dispatcher_name:currentUserSession.name, logs:[...(op.logs||[]),log], status:r[0]==='Ù†Ø§Ù‚Øµ'?'done':'active' });
                                renderSystemToast("ØªÙ… Ø§Ù„Ø±Ø¯", "success");
                            }
                        }
                        async function finalizeTicketAndArchive(id) { await dbHub.ref('operations/'+id).update({status:'done', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:"Ø¥ØºÙ„Ø§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ"}]}); renderSystemToast("ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ©","success"); }
                        async function sendToBranchManagerFromCallCenter(id) { await dbHub.ref('operations/'+id).update({stage:'sent_to_branch_manager', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:"Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹"}]}); renderSystemToast("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„","success"); }
                        async function sendToRegionalManager(id) { await dbHub.ref('operations/'+id).update({stage:'sent_to_regional_manager', logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:"Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"}]}); renderSystemToast("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„","success"); }
                        async function deleteTicketRecord(id) { if((await Swal.fire({title:'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ',icon:'warning',showCancelButton:true})).isConfirmed) { await dbHub.ref('operations/'+id).remove(); renderSystemToast("ØªÙ… Ø§Ù„Ø­Ø°Ù","success"); } }
                        async function openBranchManagerReplyModalHub(id) {
                            const {value:r} = await Swal.fire({ title:'Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±', html:`<select id="s1" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option></select><textarea id="s2" class="swal2-input"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                            if(r) { await dbHub.ref('operations/'+id).update({stage:'sent_back_to_call_center', branch_manager_verdict:r[0], branch_manager_name:currentUserSession.name, logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:'Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±: '+r[0]}]}); renderSystemToast("ØªÙ… Ø§Ù„Ø±Ø¯","success"); }
                        }
                        async function openRegionalManagerReplyModalHub(id) {
                            const {value:r} = await Swal.fire({ title:'Ø±Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', html:`<select id="s1" class="swal2-input"><option value="ÙƒØ§Ù…Ù„">âœ… Ø³Ù„ÙŠÙ…</option><option value="Ù†Ø§Ù‚Øµ">âŒ Ù†Ø§Ù‚Øµ ÙØ¹Ù„Ø§Ù‹</option></select><textarea id="s2" class="swal2-input"></textarea>`, preConfirm:()=>[document.getElementById('s1').value,document.getElementById('s2').value] });
                            if(r) { await dbHub.ref('operations/'+id).update({stage:'sent_to_regional_manager', regional_manager_verdict:r[0], regional_manager_name:currentUserSession.name, logs:[...(complaintsCache[id].logs||[]),{time:new Date().toLocaleTimeString('ar-EG'),user:currentUserSession.name,action:'Ø±Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: '+r[0]}]}); renderSystemToast("ØªÙ… Ø§Ù„Ø±Ø¯","success"); }
                        }

                        // ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ù† Ø§Ù„Ø±Ø§Ø¯Ø§Ø±)
                        async function deleteUserEntirely(uid, userName) {
                            // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ "Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†" Ù„ÙŠÙƒÙˆÙ† Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù
                            if (currentUserSession.role !== 'SUPER') {
                                renderSystemToast("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", "danger");
                                return;
                            }

                            // 2. Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
                            const result = await Swal.fire({
                                title: `Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userName}ØŸ`,
                                text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©.",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#ef4444',
                                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ',
                                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                            });

                            if (result.isConfirmed) {
                                try {
                                    // 3. Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase)
                                    await dbHub.ref('users/' + uid).remove();
                                    await dbHub.ref('users_presence/' + uid).remove();

                                    // 4. *** Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ù‡Ù… ***: Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ (LocalStorage)
                                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                                    if (users[uid]) {
                                        delete users[uid]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                                        localStorage.setItem('users', JSON.stringify(users));
                                    }

                                    // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©
                                    renderAdminUsersScrollBox();

                                    renderSystemToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
                                } catch (error) {
                                    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù:", error);
                                    renderSystemToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…", "danger");
                                }
                            }
                        }

                        // Ø­Ø°Ù Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
                        async function deleteSpecificLog(logId) {
                            if (currentUserSession.role !== 'SUPER') return;
                            await dbHub.ref('access_logs/' + logId).remove();
                            renderSystemToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„", "success");
                        }

                        // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù„Ø³ÙˆØ¨Ø± ÙÙ‚Ø·)
                        async function clearAllSystemLogs() {
                            if (currentUserSession.role !== 'SUPER') return;

                            const result = await Swal.fire({
                                title: 'Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ',
                                text: "Ù‡Ø°Ø§ Ø§Ù„ÙØ¹Ù„ Ø³ÙŠÙ…Ø³Ø­ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!",
                                icon: 'danger',
                                showCancelButton: true,
                                confirmButtonColor: '#ef4444',
                                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„'
                            });

                            if (result.isConfirmed) {
                                await dbHub.ref('access_logs').remove();
                                renderSystemToast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­", "success");
                            }
                        }

                        // Admin Utilities
                        function syncUiDropdownSelections() {
                            // 1. ØªØ­Ø¶ÙŠØ± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹
                            const h = branchListCache.map(b => `<option value="${b}">${b}</option>`).join('');

                            // 2. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙ‚Ø§Ø¦Ù…Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                            if(document.getElementById('f-branch-master-sel')) document.getElementById('f-branch-master-sel').innerHTML = h;
                            if(document.getElementById('adm-whatsapp-br-sel')) document.getElementById('adm-whatsapp-br-sel').innerHTML = h;
                            if(document.getElementById('reg-user-branch-sel-core')) document.getElementById('reg-user-branch-sel-core').innerHTML = `<option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>` + h;

                            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
                            const globalFilter = document.getElementById('global-branch-filter');
                            if(globalFilter) {
                                const currentVal = globalFilter.value;
                                globalFilter.innerHTML = `<option value="ALL">-- Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ --</option>` + h;
                                globalFilter.value = currentVal;
                            }

                            // 4. ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            const reportsFilter = document.getElementById('reports-branch-filter');
                            if(reportsFilter) {
                                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† ÙŠØ±Ù‰ ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ± ÙØ±Ø¹ ÙŠØ±Ù‰ ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
                                if(currentUserSession.branch === 'ALL' || currentUserSession.role === 'SUPER') {
                                    reportsFilter.innerHTML = `<option value="ALL">-- ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ --</option>` + h;
                                } else {
                                    reportsFilter.innerHTML = `<option value="${currentUserSession.branch}">${currentUserSession.branch}</option>`;
                                }
                            }

                            // 5. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© ÙÙ„ØªØ± Ø§Ù„Ø±Ø§Ø¯Ø§Ø± (Ø§Ù„Ù„ÙŠ Ø³Ø£Ù„Øª Ø¹Ù„ÙŠÙ‡Ø§)
                            const radarFilter = document.getElementById('radar-branch-filter-select');
                            if(radarFilter) {
                                // Ø¨Ù†Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¹Ø´Ø§Ù† Ù…ØªØªØºÙŠØ±Ø´ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                                const currentVal = radarFilter.value;
                                radarFilter.innerHTML = `<option value="SHOW_ALL">-- Ø§Ù„ÙƒÙ„ --</option><option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>` + h;
                                radarFilter.value = currentVal;
                            }

                            // 6. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØªØ¨
                            const rh = Object.keys(systemSettingsCache.custom_ranks || {}).map(r => `<option value="${r}">${r}</option>`).join('');
                            if(document.getElementById('adm-rank-matrix-sel')) document.getElementById('adm-rank-matrix-sel').innerHTML = `<option value="">-- Ø§Ø®ØªØ± --</option>` + rh;
                            if(document.getElementById('reg-user-rank-sel-core')) document.getElementById('reg-user-rank-sel-core').innerHTML = rh;

                            // 7. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                            updateLogBranchDropdown();
                        }

                        // 1. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡Ø§ ÙÙŠ syncUiDropdownSelections)
                        function updateLogBranchDropdown() {
                            const logBrSelect = document.getElementById('log-filter-branch');
                            if(logBrSelect) {
                                logBrSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option><option value="ALL">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>' +
                                    branchListCache.map(b => `<option value="${b}">${b}</option>`).join('');
                            }
                        }
                        // Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³ÙŠØ±ÙØ±
                        function addSystemBranchCore() {
                            const n = document.getElementById('adm-branch-name-input').value.trim();
                            if(n) {
                                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ±Ø¹ Ù„Ù€ Firebase ØªØ­Øª node Ø§Ø³Ù…Ù‡Ø§ settings/branches
                                const newBranchRef = dbHub.ref('settings/branches').push();
                                newBranchRef.set(n).then(() => {
                                    document.getElementById('adm-branch-name-input').value = "";
                                    renderSystemToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­", "success");
                                });
                            } else {
                                renderSystemToast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹!", "danger");
                            }
                        }

                        // Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                        function renderAdminBranchScrollBox() {
                            const b = document.getElementById('adm-branches-scroll-box');
                            if(!b) return;
                            b.innerHTML = "";

                            // Ø¨Ù†Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù„ÙŠ Ø¬Ø§ÙŠ Ù…Ù† Firebase
                            if(systemSettingsCache.branches) {
                                Object.keys(systemSettingsCache.branches).forEach(key => {
                                    const branchName = systemSettingsCache.branches[key];
                                    b.innerHTML += `
                                        <div class="admin-row-item">
                                            <span>${branchName}</span>
                                            <i class="fas fa-trash" style="color:var(--danger-pulse);cursor:pointer;"
                                               onclick="deleteBranchFromServer('${key}')"></i>
                                        </div>`;
                                });
                            }
                        }

                        // Ø­Ø°Ù ÙØ±Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                        function deleteBranchFromServer(key) {
                            Swal.fire({
                                title: 'Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ØŸ',
                                text: "Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    dbHub.ref('settings/branches/' + key).remove();
                                }
                            });
                        }
                        function renderBranchWhatsappList() {
                            const br = document.getElementById('adm-whatsapp-br-sel').value, b = document.getElementById('adm-whatsapp-scroll-box'); b.innerHTML = "";
                            const phones = JSON.parse(localStorage.getItem('whatsapp_' + br) || '[]');
                            phones.forEach((phone, index) => b.innerHTML += `<div class="admin-row-item"><span>${phone}</span><i class="fas fa-trash" style="color:var(--danger-pulse);cursor:pointer;" onclick="deleteWhatsapp('${br}', ${index})"></i></div>`);
                        }
                        function bindNewWhatsappToBranch() {
                            const br = document.getElementById('adm-whatsapp-br-sel').value, ph = document.getElementById('adm-whatsapp-phone-input').value.trim();
                            if(ph) {
                                const phones = JSON.parse(localStorage.getItem('whatsapp_' + br) || '[]');
                                phones.push(ph);
                                localStorage.setItem('whatsapp_' + br, JSON.stringify(phones));
                                document.getElementById('adm-whatsapp-phone-input').value = "";
                                renderBranchWhatsappList();
                                renderSystemToast("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„","success");
                            }
                        }
                        function deleteWhatsapp(br, index) {
                            const phones = JSON.parse(localStorage.getItem('whatsapp_' + br) || '[]');
                            phones.splice(index, 1);
                            localStorage.setItem('whatsapp_' + br, JSON.stringify(phones));
                            renderBranchWhatsappList();
                        }
                        function loadRankPermissionsMatrixHub() {
                            const r = document.getElementById('adm-rank-matrix-sel').value;
                            if(!r) { document.getElementById('adm-permissions-grid-hub').classList.add('hidden'); return; }
                            document.getElementById('adm-permissions-grid-hub').classList.remove('hidden');
                            const permissions = JSON.parse(localStorage.getItem('permissions') || '{}');
                            const p = permissions[r] || {};
                            ['view_all','create_ticket','reply_ticket','daily_edit','admin_access'].forEach(k => document.getElementById('perm-'+k.replace('_','-')).checked = p[k]||false);
                        }
                        function saveRankPermissionsSequence() {
                            const r = document.getElementById('adm-rank-matrix-sel').value;
                            const d = {}; ['view_all','create_ticket','reply_ticket','daily_edit','admin_access'].forEach(k => d[k] = document.getElementById('perm-'+k.replace('_','-')).checked);
                            const permissions = JSON.parse(localStorage.getItem('permissions') || '{}');
                            permissions[r] = d;
                            localStorage.setItem('permissions', JSON.stringify(permissions));
                            renderSystemToast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«","success");
                        }
                        function renderAdminUsersScrollBox() {
                            const b = document.getElementById('adm-users-scroll-box');
                            if(!b) return;
                            b.innerHTML = "";
                            const users = JSON.parse(localStorage.getItem('users') || '{}');
                            Object.keys(users).forEach(uid => {
                                const u = users[uid];
                                // ØªØ®Ø·ÙŠ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ù„ÙƒÙ† Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                                const isSuper = uid === 'super';

                                b.innerHTML += `
                                    <div class="admin-row-item">
                                        <div>
                                            <b style="color:var(--gold-master)">${u.name}</b>
                                            <small style="color:var(--text-muted-core)">(${u.title})</small>
                                            <div style="font-size:0.7rem; opacity:0.6;">Ø§Ù„ÙØ±Ø¹: ${u.branch || '---'}</div>
                                        </div>
                                        <div style="display:flex; gap:15px;">
                                            <!-- Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                                            <i class="fas fa-user-edit" style="color:var(--success-glow); cursor:pointer;"
                                            onclick="openEditUserModal('${uid}')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"></i>

                                            <!-- Ø²Ø± Ø§Ù„Ø­Ø°Ù -->
                                            ${!isSuper ? `<i class="fas fa-user-minus" style="color:var(--danger-pulse); cursor:pointer;"
                                            onclick="deleteUserEntirely('${uid}', '${u.name}')" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ"></i>` : ''}
                                        </div>
                                    </div>`;
                            });
                        }
                        async function registerNewUserToSystemSequence() {
                            const id = document.getElementById('reg-user-id-core').value.trim();
                            const userData = {
                                name: document.getElementById('reg-user-fullname-core').value,
                                title: document.getElementById('reg-user-rank-sel-core').value,
                                branch: document.getElementById('reg-user-branch-sel-core').value,
                                pass: document.getElementById('reg-user-pass-core').value
                            };

                            if(id && userData.name) {
                                // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± (Firebase) Ù„ÙƒÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
                                await dbHub.ref('users/' + id).set(userData);

                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
                                const localUsers = JSON.parse(localStorage.getItem('users') || '{}');
                                localUsers[id] = userData;
                                localStorage.setItem('users', JSON.stringify(localUsers));

                                renderAdminUsersScrollBox();
                                renderSystemToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­","success");
                            }
                        }

                        async function openEditUserModal(uid) {
                            // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† localStorage
                            const users = JSON.parse(localStorage.getItem('users') || '{}');
                            const u = users[uid];
                            if(!u) return;

                            // 2. ØªØ­Ø¶ÙŠØ± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±ØªØ¨ ÙˆØ§Ù„ÙØ±ÙˆØ¹ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                            const ranksOptions = Object.keys(systemSettingsCache.custom_ranks || {}).map(r => `<option value="${r}" ${u.title === r ? 'selected' : ''}>${r}</option>`).join('');
                            const branchesOptions = branchListCache.map(b => `<option value="${b}" ${u.branch === b ? 'selected' : ''}>${b}</option>`).join('');

                            // 3. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SweetAlert2
                            const { value: formValues } = await Swal.fire({
                                title: `<span style="color:var(--gold-master)">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨: ${u.name}</span>`,
                                background: '#0d1117',
                                color: '#f0f6fc',
                                html: `
                                    <div style="text-align:right; direction:rtl;">
                                        <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                                        <input id="swal-name" class="swal2-input" value="${u.name}" style="margin:0 0 15px 0; width:100%;">
                                        
                                        <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø±ØªØ¨Ø© / Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                        <select id="swal-rank" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                                            ${ranksOptions}
                                        </select>

                                        <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙØ±Ø¹:</label>
                                        <select id="swal-branch" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                                            <option value="ALL" ${u.branch === 'ALL' ? 'selected' : ''}>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>
                                            ${branchesOptions}
                                        </select>

                                        <label style="display:block; margin-bottom:5px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                                        <input id="swal-pass" type="text" class="swal2-input" value="${u.pass}" style="margin:0 0 15px 0; width:100%;">
                                        
                                        <p style="font-size:0.8rem; color:var(--danger-pulse);">* Ù…Ù„Ø­ÙˆØ¸Ø©: ØªØºÙŠÙŠØ± Ø§Ù„Ù€ ID ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø­ÙØ§Ø¸Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.</p>
                                    </div>
                                `,
                                focusConfirm: false,
                                showCancelButton: true,
                                confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª',
                                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                                confirmButtonColor: 'var(--gold-master)',
                                preConfirm: () => {
                                    return {
                                        name: document.getElementById('swal-name').value,
                                        title: document.getElementById('swal-rank').value,
                                        branch: document.getElementById('swal-branch').value,
                                        pass: document.getElementById('swal-pass').value
                                    }
                                }
                            });

                            // 4. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ localStorage
                            if (formValues) {
                                if(!formValues.name || !formValues.pass) {
                                    renderSystemToast("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†!", "danger");
                                    return;
                                }

                                users[uid] = formValues;
                                localStorage.setItem('users', JSON.stringify(users));
                                
                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
                                renderAdminUsersScrollBox();
                                renderSystemToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
                            }
                        }
                        async function registerNewRankTitleCore() {
                            const rankName = document.getElementById('adm-rank-name-input').value.trim();

                            if (!rankName) {
                                renderSystemToast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø±ØªØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹", "danger");
                                return;
                            }

                            try {
                                // 1. Ø§Ù„Ø­ÙØ¸ ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ² (Ø¹Ø´Ø§Ù† ÙƒÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ´ÙˆÙÙˆÙ‡Ø§)
                                await dbHub.ref('settings/custom_ranks/' + rankName).set(true);

                                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹
                                const localRanks = JSON.parse(localStorage.getItem('custom_ranks') || '{}');
                                localRanks[rankName] = true;
                                localStorage.setItem('custom_ranks', JSON.stringify(localRanks));

                                // 3. Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©
                                document.getElementById('adm-rank-name-input').value = "";

                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…
                                if (!systemSettingsCache.custom_ranks) systemSettingsCache.custom_ranks = {};
                                systemSettingsCache.custom_ranks[rankName] = true;

                                // ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù‚ÙˆØ§Ø¦Ù…
                                syncUiDropdownSelections();

                                renderSystemToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØªØ¨Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…", "success");
                            } catch (error) {
                                console.error(error);
                                renderSystemToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±", "danger");
                            }
                        }
                    function runPermissionShieldCheck() {
                        const p = systemSettingsCache.permissions ? (systemSettingsCache.permissions[currentUserSession.title] || {}) : {};
                        if(p.admin_access || currentUserSession.role === 'SUPER') document.getElementById('tab-admin').classList.remove('hidden');
                        document.getElementById('floating-plus-btn').className = (p.create_ticket || currentUserSession.role === 'SUPER' || currentUserSession.title === 'Ø¯ÙŠØ³Ø¨ØªØ´Ø±') ? 'floating-action-master' : 'hidden';
                    }

                    // Helpers
                    function openSidebarControl() { document.getElementById('sidebar-complaint-arc-hub').classList.add('open'); document.getElementById('master-dimmer').style.display='block'; }
                    function closeSidebarControl() { document.getElementById('sidebar-complaint-arc-hub').classList.remove('open'); document.getElementById('master-dimmer').style.display='none'; }
                    function toggleSidebar() { const n = document.getElementById('system-side-nav'), d = document.getElementById('master-dimmer'); n.classList.toggle('open'); d.style.display = n.classList.contains('open') ? 'block' : 'none'; }
                    function closeAllMenus() { document.getElementById('system-side-nav').classList.remove('open'); closeSidebarControl(); }
                    function switchToAppModule(m) {
                        document.querySelectorAll('.nav-link-vip').forEach(b => b.classList.remove('active'));
                        document.getElementById('tab-'+m).classList.add('active');
                        ['live','daily','archive','reports','admin'].forEach(id => document.getElementById('module-view-'+id).classList.add('hidden'));
                        document.getElementById('module-view-'+m).classList.remove('hidden');
                        if(m==='reports') executeAdvancedAnalyticsSequence();
                        if(m==='daily') loadDailySnapshotData();
                        if(window.innerWidth <= 768) closeAllMenus();
                    }
                    function renderSystemToast(m, t) {
                        const b = document.getElementById('system-toast-container'), toast = document.createElement('div');
                        toast.className = 'toast-msg-vip'; if(t==='danger') toast.style.background='#ef4444';
                        toast.innerHTML = `<i class="fas ${t==='danger'?'fa-triangle-exclamation':'fa-circle-check'}"></i> ${m}`;
                        b.appendChild(toast); setTimeout(() => toast.remove(), 5000);
                    }

                    function toggleTicketDetails(el) {
                        el.classList.toggle('expanded');
                    }

                    function refreshAllModulesData() {
                        const selectedBranch = document.getElementById('global-branch-filter').value;
                        document.getElementById('branch-quick-stat').innerText = selectedBranch === 'ALL' ? "ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©" : "ÙØ±Ø¹: " + selectedBranch;

                        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ÙÙˆØ±Ø§Ù‹
                        renderLiveBroadcastMatrix();
                        runArchiveRefreshSequence();
                        loadDailySnapshotData();
                        if(!document.getElementById('module-view-reports').classList.contains('hidden')) {
                            executeAdvancedAnalyticsSequence();
                        }
                    }
                </script>
            </body>
        </html>
